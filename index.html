<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PRO SPY | Covert Arena</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üïµÔ∏è</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #05050a;
            --bg-card: rgba(20, 20, 30, 0.7);
            --primary: #00f2ff;
            --secondary: #7000ff;
            --accent: #ff0055;
            --text-main: #ffffff;
            --text-muted: #8b8b9e;
            --border: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body { 
            background-color: var(--bg-dark); 
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-gradient-main {
            background: 
                radial-gradient(circle at 10% 20%, rgba(112, 0, 255, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(0, 242, 255, 0.1) 0%, transparent 40%),
                var(--bg-dark);
        }

        .glass-panel {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .font-tech { font-family: 'Rajdhani', sans-serif; }

        /* Animations */
        @keyframes pulse-glow {
            0% { text-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary); }
            50% { text-shadow: 0 0 20px var(--primary), 0 0 40px var(--primary), 0 0 60px var(--secondary); }
            100% { text-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary); }
        }

        @keyframes rotate-border {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .animate-fade-in { animation: fade-in-up 0.6s ease-out forwards; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        .logo-container {
            position: relative;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-border {
            position: absolute;
            inset: 0;
            border-radius: 12px;
            border: 2px solid transparent;
            border-top-color: var(--primary);
            border-right-color: var(--secondary);
            animation: rotate-border 3s linear infinite;
        }

        .game-title {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            letter-spacing: 2px;
            background: linear-gradient(to right, #fff, var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: pulse-glow 3s infinite alternate;
        }

        .btn-neon {
            position: relative;
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            color: white;
            font-weight: 700;
            transition: all 0.3s;
            overflow: hidden;
        }
        
        .btn-neon:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 0 15px var(--primary);
        }
        
        .btn-neon:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-ghost {
            background: transparent;
            border: 1px solid var(--border);
            transition: 0.3s;
        }
        .btn-ghost:hover { border-color: var(--primary); color: var(--primary); }

        .input-dark {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
            color: white;
            transition: 0.2s;
        }
        .input-dark:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.2);
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--secondary); border-radius: 2px; }

        .player-card { transition: all 0.3s; }
        .player-card.active {
            border: 1px solid var(--primary);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);
            background: rgba(0, 242, 255, 0.1);
        }

        .player-card.eliminated {
            opacity: 0.4;
            border-color: var(--accent);
            filter: grayscale(100%);
        }

        /* Small Timer for Player List */
        .player-timer-svg { 
            transform: rotate(-90deg); 
            width: 24px; 
            height: 24px;
            position: absolute;
            left: -12px;
            top: 50%;
            margin-top: -12px;
            z-index: 10;
        }
        .player-timer-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 3; }
        .player-timer-progress { fill: none; stroke: var(--primary); stroke-width: 3; stroke-linecap: round; transition: stroke-dashoffset 1s linear; }
        .player-timer-text {
            position: absolute;
            left: -12px;
            top: 50%;
            width: 24px;
            height: 24px;
            margin-top: -12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: bold;
            color: var(--primary);
            z-index: 11;
        }

        /* Chat Bubbles */
        .chat-bubble-me {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            color: white;
            border-radius: 18px 18px 4px 18px;
            padding: 8px 12px;
            max-width: 80%;
            align-self: flex-end;
            word-wrap: break-word;
        }
        .chat-bubble-other {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            border-radius: 18px 18px 18px 4px;
            padding: 8px 12px;
            max-width: 80%;
            align-self: flex-start;
            word-wrap: break-word;
        }
        
        .identity-square {
            width: 100%;
            max-width: 280px;
            aspect-ratio: 1 / 1; 
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.5s ease;
        }
        
        .identity-spy {
            border: 2px solid var(--accent);
            background: radial-gradient(circle at center, rgba(255, 0, 85, 0.15), transparent 70%);
            box-shadow: 0 0 30px rgba(255, 0, 85, 0.2);
        }
        
        .identity-agent {
            border: 2px solid #10b981;
            background: radial-gradient(circle at center, rgba(16, 185, 129, 0.1), transparent 70%);
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.1);
        }
    </style>
</head>
<body class="bg-gradient-main">
    <div id="root"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyApAJaNfF0YHupunLRlK3jRYvttxczWShY",
            authDomain: "who-is-the-spy-919b9.firebaseapp.com",
            projectId: "who-is-the-spy-919b9",
            storageBucket: "who-is-the-spy-919b9.firebasestorage.app",
            messagingSenderId: "607075438373",
            appId: "1:607075438373:web:a03e9fb8b243cd993e14cc"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'pro_spy_v6_final';

        // --- Translations ---
        const TRANSLATIONS = {
            en: {
                appName: "PRO SPY", tagline: "COVERT ARENA",
                nickname: "OPERATOR NAME", create: "CREATE LOBBY", join: "JOIN OPS",
                codePlaceholder: "ENTER CODE", players: "OPERATIVES", start: "LAUNCH MISSION",
                langBtn: "ÿßŸÑÿπÿ±ÿ®Ÿäÿ©", loading: "PROCESSING...", you: "YOU",
                statusSpy: "SPY", statusAgent: "AGENT",
                round: "ROUND", discussionTime: "DISCUSSION TIME",
                skip: "SKIP TURN", vote: "VOTE TO EJECT",
                chatPlaceholder: "Type message...", send: "SEND",
                waiting: "Awaiting host...", location: "LOCATION",
                spectator: "SPECTATOR", ejected: "EJECTED",
                noChoice: "NO VOTE", confirm: "CONFIRM VOTE", gameOver: "GAME OVER",
                spyWin: "SPY WINS!", agentsWin: "AGENTS WIN!",
                playAgain: "PLAY AGAIN", connecting: "Establishing Secure Connection...",
                voteWait: "Waiting for votes...", voteDone: "VOTE LOCKED"
            },
            ar: {
                appName: "ÿ®ÿ±Ÿà ÿ¨ÿßÿ≥Ÿàÿ≥", tagline: "ÿ≥ÿßÿ≠ÿ© ÿßŸÑÿπŸÖŸÑŸäÿßÿ™",
                nickname: "ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ", create: "ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖŸÇÿ±", join: "ÿßŸÜÿ∂ŸÖÿßŸÖ",
                codePlaceholder: "ÿ£ÿØÿÆŸÑ ÿßŸÑŸÉŸàÿØ", players: "ÿßŸÑÿπŸÖŸÑÿßÿ°", start: "ÿ®ÿØÿ° ÿßŸÑŸÖŸáŸÖÿ©",
                langBtn: "English", loading: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...", you: "ÿ£ŸÜÿ™",
                statusSpy: "ÿ¨ÿßÿ≥Ÿàÿ≥", statusAgent: "ÿπŸÖŸäŸÑ",
                round: "ÿßŸÑÿ¨ŸàŸÑÿ©", discussionTime: "ŸàŸÇÿ™ ÿßŸÑŸÜŸÇÿßÿ¥",
                skip: "ÿ™ÿÆÿ∑Ÿä ÿßŸÑÿØŸàÿ±", vote: "ÿ™ÿµŸàŸäÿ™ ŸÑŸÑÿ∑ÿ±ÿØ",
                chatPlaceholder: "ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©...", send: "ÿ•ÿ±ÿ≥ÿßŸÑ",
                waiting: "ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÖÿ∂ŸäŸÅ...", location: "ÿßŸÑŸÖŸàŸÇÿπ",
                spectator: "ŸÖÿ¥ÿßŸáÿØ", ejected: "ŸÖÿ∑ÿ±ŸàÿØ",
                noChoice: "ŸÑŸÖ ŸäÿµŸàÿ™", confirm: "ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ™ÿµŸàŸäÿ™", gameOver: "ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÑÿπÿ®ÿ©",
                spyWin: "ŸÅÿßÿ≤ ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥!", agentsWin: "ŸÅÿßÿ≤ ÿßŸÑÿπŸÖŸÑÿßÿ°!",
                playAgain: "ŸÑÿπÿ® ŸÖÿ¨ÿØÿØÿßŸã", connecting: "ÿ¨ÿßÿ±Ÿä ÿ™ÿ£ŸÖŸäŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ...",
                voteWait: "ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ£ÿµŸàÿßÿ™...", voteDone: "ÿ™ŸÖ ÿ™ÿ´ÿ®Ÿäÿ™ ÿßŸÑÿ™ÿµŸàŸäÿ™"
            }
        };

        // --- Scenarios DB ---
        const SCENARIOS = [
            { loc_ar: "ŸÖÿ≠ÿ∑ÿ© ŸÅÿ∂ÿßÿ°", words_ar: ["ŸÅÿ∂ÿßÿ°", "ÿµÿßÿ±ŸàÿÆ", "zero-g", "ŸÇŸÖÿ±"], loc_en: "Space Station", words_en: ["Space", "Rocket", "Zero-g", "Moon"] },
            { loc_ar: "ÿ∫Ÿàÿßÿµÿ© ŸÜŸàŸàŸäÿ©", words_ar: ["ÿπŸÖŸÇ", "ŸÖÿßÿ°", "ÿ∂ÿ∫ÿ∑", "ÿ≥ŸàŸÜÿßÿ±"], loc_en: "Nuclear Submarine", words_en: ["Depth", "Water", "Pressure", "Sonar"] },
            { loc_ar: "ŸÇÿµÿ± ŸÖŸÑŸÉŸä", words_ar: ["ÿ™ÿßÿ¨", "ÿ≠ÿ±ÿßÿ≥", "ÿπÿ±Ÿàÿ¥", "ÿÆÿØŸÖ"], loc_en: "Royal Palace", words_en: ["Crown", "Guards", "Throne", "Servants"] },
            { loc_ar: "ÿ®ŸÜŸÉ ŸÖÿ±ŸÉÿ≤Ÿä", words_ar: ["ÿÆÿ≤ŸÜÿ©", "ŸÖÿßŸÑ", "ÿ±ÿµÿßÿµ", "ŸÖŸÅÿ™ÿßÿ≠"], loc_en: "Central Bank", words_en: ["Vault", "Money", "Lead", "Key"] },
            { loc_ar: "ŸÖÿ≥ÿ™ÿ¥ŸÅŸâ ŸÖŸáÿ¨Ÿàÿ±", words_ar: ["ÿ£ÿ¥ÿ®ÿßÿ≠", "ÿ£ÿ∑ÿ®ÿßÿ°", "ÿ∏ŸÑÿßŸÖ", "ÿ≠ŸÇŸÜ"], loc_en: "Abandoned Hospital", words_en: ["Ghosts", "Doctors", "Dark", "Syringe"] },
            { loc_ar: "ŸÇÿ∑ÿßÿ± ŸÑŸäŸÑŸä", words_ar: ["ÿØÿ±ÿ¨ÿßÿ™", "ÿ™ÿ∞ÿßŸÉÿ±", "ŸÜŸàŸÖ", "ŸÖŸÖÿ±"], loc_en: "Night Train", words_en: ["Bunks", "Tickets", "Sleep", "Aisle"] },
            { loc_ar: "ÿ¨ÿ≤Ÿäÿ±ÿ© ŸÉŸÜÿ≤", words_ar: ["ÿÆÿ±Ÿäÿ∑ÿ©", "ÿ≠ŸÅÿ±", "ÿ∞Ÿáÿ®", "ŸÇÿ±ÿßÿµŸÜÿ©"], loc_en: "Treasure Island", words_en: ["Map", "Dig", "Gold", "Pirates"] },
            { loc_ar: "ŸÖÿµŸÜÿπ ÿ±Ÿàÿ®Ÿàÿ™ÿßÿ™", words_ar: ["ÿ£ÿ≥ŸÑÿßŸÉ", "ÿµŸäÿßŸÜÿ©", "ÿ®ÿ±ŸÖÿ¨ÿ©", "ŸÖÿπÿßÿØŸÜ"], loc_en: "Robot Factory", words_en: ["Wires", "Maintenance", "Coding", "Metal"] },
            { loc_ar: "ŸÖÿ∑ÿßÿ± ÿØŸàŸÑŸä", words_ar: ["ÿ¨Ÿàÿßÿ≤ÿßÿ™", "ÿ∑ÿßÿ¶ÿ±ÿßÿ™", "ÿ≠ŸÇÿßÿ¶ÿ®", "ÿ•ŸÇŸÑÿßÿπ"], loc_en: "Airport", words_en: ["Passports", "Planes", "Bags", "Takeoff"] },
            { loc_ar: "ÿ¨ÿßŸÖÿπÿ© ÿ≥ÿ≠ÿ±", words_ar: ["ŸÉÿ™ÿ®", "ÿπÿµÿß", "ÿπŸÅÿßÿ±Ÿäÿ™", "ÿ™ÿ±ÿßŸÉŸäÿ®"], loc_en: "Magic Uni", words_en: ["Books", "Wand", "Ghosts", "Potions"] }
        ];

        function App() {
            const [lang, setLang] = useState('en');
            const [user, setUser] = useState(null);
            const [room, setRoom] = useState(null);
            const [roomId, setRoomId] = useState('');
            const [inputCode, setInputCode] = useState('');
            const [nickname, setNickname] = useState(() => localStorage.getItem('pro_spy_nick') || '');
            const [loading, setLoading] = useState(false);
            const [chatMsg, setChatMsg] = useState('');
            const [voteTarget, setVoteTarget] = useState(null); 
            const [turnTimer, setTurnTimer] = useState(30);
            const [votingTimer, setVotingTimer] = useState(30);
            
            const t = TRANSLATIONS[lang];
            const turnIntervalRef = useRef(null);

            // --- Hooks defined at the top level ---

            // Auth Effect
            useEffect(() => {
                const unsub = auth.onAuthStateChanged(async (u) => {
                    if (u) setUser(u);
                    else await auth.signInAnonymously();
                });
                return unsub;
            }, []);

            // Room Listener
            useEffect(() => {
                if (!user || !roomId) return;
                const unsub = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId)
                    .onSnapshot(doc => {
                        if (doc.exists) setRoom(doc.data());
                        else setRoom(null);
                    });
                return unsub;
            }, [user, roomId]);

            // Turn Timer Logic
            useEffect(() => {
                if (room?.status === 'discussing' && room.turnEndTime) {
                    const interval = setInterval(() => {
                        const remaining = Math.max(0, Math.floor((room.turnEndTime - Date.now()) / 1000));
                        setTurnTimer(remaining);
                    }, 1000);
                    return () => clearInterval(interval);
                } else {
                    setTurnTimer(30);
                }
            }, [room?.status, room?.turnEndTime]);

            // Voting Timer Logic
            useEffect(() => {
                if (room?.status === 'voting' && room.votingEndTime) {
                    const interval = setInterval(() => {
                        const remaining = Math.max(0, Math.floor((room.votingEndTime - Date.now()) / 1000));
                        setVotingTimer(remaining);
                    }, 1000);
                    return () => clearInterval(interval);
                } else {
                    setVotingTimer(30);
                }
            }, [room?.status, room.votingEndTime]);

            // Automatic Vote Resolution & Skip Logic
            useEffect(() => {
                // Auto Skip Turn
                if (room?.status === 'discussing' && room.turnEndTime && Date.now() >= room.turnEndTime) {
                    handleSkipTurn(true); // Force skip
                }
                
                // Auto Resolve Votes
                if (room?.status === 'voting' && room.votingEndTime && Date.now() >= room.votingEndTime) {
                    resolveVotes(true); // Force resolve
                }
            }, [turnTimer, votingTimer, room?.status]); // Dependencies trigger checks

            // Memoized Words Logic
            const currentWords = useMemo(() => {
                if (!room?.scenario || !user) return [];
                const isSpy = room.spyId === user.uid;
                if (isSpy) return ["?", "?", "?", "?"];
                return lang === 'ar' ? room.scenario.words_ar : room.scenario.words_en;
            }, [room, user, lang]);

            // --- Actions ---

            const handleCreate = async () => {
                if (!nickname.trim() || !user) return;
                setLoading(true);
                const id = Math.random().toString(36).substring(2, 7).toUpperCase();
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(id).set({
                    id, admin: user.uid, status: 'waiting',
                    players: [{ uid: user.uid, name: nickname, status: 'active' }],
                    scenario: null, spyId: null, 
                    currentTurnUID: null, turnEndTime: null, votingEndTime: null, currentRound: 0,
                    messages: [], votes: {}, usedLocations: []
                });
                setRoomId(id);
                setLoading(false);
            };

            const handleJoin = async () => {
                if (!nickname.trim() || !inputCode || !user) return;
                const code = inputCode.toUpperCase();
                setLoading(true);
                const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(code);
                const snap = await ref.get();
                if (snap.exists) {
                    const data = snap.data();
                    const exists = data.players.find(p => p.uid === user.uid);
                    if (!exists) {
                        await ref.update({ players: [...data.players, { uid: user.uid, name: nickname, status: 'active' }] });
                    }
                    setRoomId(code);
                }
                setLoading(false);
            };

            const startGame = async () => {
                if (room.admin !== user.uid) return;
                
                const used = room.usedLocations || [];
                const avail = SCENARIOS.filter(s => !used.includes(s.loc_en));
                const scenario = (avail.length > 0 ? avail : SCENARIOS)[Math.floor(Math.random() * (avail.length || SCENARIOS.length))];
                const activePlayers = room.players.filter(p => p.status === 'active');
                
                if (activePlayers.length < 3) {
                     alert("Need at least 3 players!"); 
                     setLoading(false);
                     return;
                }

                const spy = activePlayers[Math.floor(Math.random() * activePlayers.length)];
                const firstPlayer = activePlayers[0];

                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                    status: 'discussing',
                    scenario,
                    spyId: spy.uid,
                    currentTurnUID: firstPlayer.uid,
                    turnEndTime: Date.now() + 30000,
                    currentRound: 1,
                    players: room.players.map(p => ({ ...p, vote: null })),
                    usedLocations: firebase.firestore.FieldValue.arrayUnion(scenario.loc_en),
                    messages: [],
                    votes: {}
                });
            };

            const handleSkipTurn = async (forced = false) => {
                // Check if still my turn or if forced by timer
                if (!forced && room.currentTurnUID !== user.uid) return;
                if (forced && room.status !== 'discussing') return;
                
                nextTurn();
            };

            const nextTurn = async () => {
                const activePlayers = room.players.filter(p => p.status === 'active');
                const currentIndex = activePlayers.findIndex(p => p.uid === room.currentTurnUID);
                const nextIndex = (currentIndex + 1) % activePlayers.length;

                if (nextIndex === 0) {
                    // Full circle, go to voting
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                        status: 'voting',
                        currentTurnUID: null,
                        turnEndTime: null,
                        votingEndTime: Date.now() + 30000 // 30s for voting
                    });
                } else {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                        currentTurnUID: activePlayers[nextIndex].uid,
                        turnEndTime: Date.now() + 30000
                    });
                }
            };

            const sendMessage = async (e) => {
                e.preventDefault();
                if (!chatMsg.trim() || !user) return;
                const msg = { sender: user.uid, name: nickname, text: chatMsg, time: Date.now() };
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                    messages: firebase.firestore.FieldValue.arrayUnion(msg)
                });
                setChatMsg('');
            };

            const submitVote = async (targetUID) => {
                if (!targetUID || !user || (room.votes && room.votes[user.uid])) return;
                
                const voteUpdate = {};
                voteUpdate[`votes.${user.uid}`] = targetUID;
                
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update(voteUpdate);
            };

            const resolveVotes = async (forced = false) => {
                if (room.status !== 'voting') return;
                
                // Check if already resolved by another client
                const freshSnap = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).get();
                const freshData = freshSnap.data();
                if (freshData.status !== 'voting') return;

                const activePlayers = freshData.players.filter(p => p.status === 'active');
                const votes = freshData.votes || {};
                
                // Count votes
                const voteCounts = {};
                Object.values(votes).forEach(v => voteCounts[v] = (voteCounts[v] || 0) + 1);
                
                let maxVotes = 0;
                let ejectedUID = null;
                let isTie = false;

                for (const uid in voteCounts) {
                    if (voteCounts[uid] > maxVotes) {
                        maxVotes = voteCounts[uid];
                        ejectedUID = uid;
                        isTie = false;
                    } else if (voteCounts[uid] === maxVotes) {
                        isTie = true;
                    }
                }

                const majorityNeeded = Math.floor(activePlayers.length / 2) + 1;
                
                if (isTie || maxVotes < majorityNeeded) {
                    // Continue to next round
                    const firstPlayer = activePlayers[0];
                     await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                        status: 'discussing',
                        votes: {},
                        currentTurnUID: firstPlayer.uid,
                        turnEndTime: Date.now() + 30000,
                        votingEndTime: null,
                        currentRound: firebase.firestore.FieldValue.increment(1)
                    });
                } else {
                    // Eject player
                    const newPlayers = freshData.players.map(p => {
                        if (p.uid === ejectedUID) return { ...p, status: 'spectator' };
                        return p;
                    });

                    const isSpy = ejectedUID === freshData.spyId;
                    const remainingAgents = newPlayers.filter(p => p.status === 'active' && p.uid !== freshData.spyId);
                    let newStatus = freshData.status;

                    if (isSpy) {
                        newStatus = 'finished_spy_caught';
                    } else if (remainingAgents.length <= 1) {
                        newStatus = 'finished_spy_wins';
                    } else {
                        newStatus = 'discussing';
                    }

                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                        players: newPlayers,
                        status: newStatus,
                        votes: {},
                        currentTurnUID: isSpy ? null : newPlayers.find(p => p.status === 'active')?.uid,
                        turnEndTime: isSpy ? null : (Date.now() + 30000),
                        votingEndTime: null,
                        currentRound: firebase.firestore.FieldValue.increment(1)
                    });
                }
            };

            const resetGame = async () => {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                    status: 'waiting',
                    scenario: null,
                    spyId: null,
                    currentTurnUID: null,
                    currentRound: 0,
                    votes: {},
                    messages: [],
                    votingEndTime: null,
                    turnEndTime: null,
                    players: room.players.map(p => ({ uid: p.uid, name: p.name, status: 'active' }))
                });
            };

            // --- Render Guard ---
            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gradient-main">
                        <div className="text-center space-y-4 animate-fade-in">
                            <div className="logo-container mx-auto">
                                <div className="logo-border"></div>
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" strokeWidth="2">
                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                </svg>
                            </div>
                            <p className="text-gray-400 font-mono text-sm animate-pulse">{t.connecting}</p>
                        </div>
                    </div>
                );
            }

            // --- Render Helpers ---
            const isMyTurn = room?.currentTurnUID === user.uid;
            const isSpy = room?.spyId === user.uid;
            const me = room?.players?.find(p => p.uid === user.uid);
            const isSpectator = me?.status === 'spectator';
            const hasVoted = room?.votes?.[user.uid];

            const timerProgress = (turnTimer / 30) * 100;
            const circumference = 2 * Math.PI * 18;
            const strokeDashoffset = circumference - (timerProgress / 100) * circumference;
            
            // Small timer logic
            const smallCircumference = 2 * Math.PI * 10;
            const smallStrokeDashoffset = smallCircumference - ((turnTimer / 30) * 100 / 100) * smallCircumference;

            return (
                <div className="min-h-screen flex flex-col items-center p-4 md:p-6" dir={lang === 'ar' ? 'rtl' : 'ltr'}>
                    {/* Header */}
                    <header className="w-full max-w-4xl flex justify-between items-center mb-6 animate-fade-in">
                        <div className="flex items-center gap-3">
                            <div className="logo-container animate-float">
                                <div className="logo-border"></div>
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" strokeWidth="2">
                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                </svg>
                            </div>
                            <div>
                                <h1 className="game-title text-2xl">{t.appName}</h1>
                                <p className="text-[10px] text-gray-500 tracking-widest font-tech">{t.tagline}</p>
                            </div>
                        </div>
                        <button onClick={() => setLang(lang === 'en' ? 'ar' : 'en')} className="btn-ghost px-4 py-1 rounded text-xs font-bold border-gray-700">
                            {t.langBtn}
                        </button>
                    </header>

                    <main className="w-full max-w-4xl grid grid-cols-1 md:grid-cols-3 gap-4">
                        
                        {/* Left Column: Players List */}
                        <div className="glass-panel rounded-2xl p-4 space-y-2 animate-fade-in delay-1">
                            <h3 className="text-xs font-bold text-gray-400 mb-2 border-b border-gray-800 pb-2 uppercase tracking-wider">{t.players}</h3>
                            <div className="space-y-2">
                                {room?.players.map((p, i) => (
                                    <div key={i} 
                                        className={`player-card relative p-2 rounded-lg flex items-center justify-between 
                                        ${p.uid === room.currentTurnUID ? 'active' : 'border border-transparent'}
                                        ${p.status === 'spectator' ? 'eliminated' : ''}`}
                                    >
                                        {/* Show Timer only for current player in discussion */}
                                        {p.uid === room.currentTurnUID && room.status === 'discussing' && (
                                            <>
                                                <svg className="player-timer-svg" viewBox="0 0 24 24">
                                                    <circle className="player-timer-bg" cx="12" cy="12" r="10"/>
                                                    <circle className="player-timer-progress" cx="12" cy="12" r="10"
                                                        strokeDasharray={smallCircumference} strokeDashoffset={smallStrokeDashoffset}
                                                    />
                                                </svg>
                                                <div className="player-timer-text">{turnTimer}</div>
                                            </>
                                        )}
                                        
                                        <div className="flex items-center gap-2 pl-5"> {/* Added padding for timer */}
                                            <div className={`w-2 h-2 rounded-full ${p.status === 'spectator' ? 'bg-red-500' : 'bg-green-500'}`}></div>
                                            <span className="font-bold text-sm truncate">{p.name}</span>
                                            {p.uid === user.uid && <span className="text-[9px] bg-blue-500 px-1 rounded">{t.you}</span>}
                                        </div>
                                        <div>
                                            {p.status === 'spectator' && <span className="text-[9px] text-red-400">{t.spectator}</span>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Middle Column: Main Game Area */}
                        <div className="md:col-span-2 space-y-4">
                            
                            {/* Waiting / Setup Screen */}
                            {!room && (
                                <div className="glass-panel rounded-2xl p-8 text-center space-y-6 animate-fade-in">
                                    <div className="space-y-2">
                                        <label className="text-xs text-gray-400 uppercase">{t.nickname}</label>
                                        <input className="input-dark w-full p-3 rounded-lg text-center font-bold" value={nickname} 
                                            onChange={e => { setNickname(e.target.value); localStorage.setItem('pro_spy_nick', e.target.value); }} 
                                        />
                                    </div>
                                    <button onClick={handleCreate} disabled={loading || !nickname} className="btn-neon w-full py-3 rounded-lg font-bold">
                                        {t.create}
                                    </button>
                                    <div className="flex gap-2">
                                        <input className="input-dark flex-1 p-3 rounded-lg text-center font-mono uppercase" placeholder={t.codePlaceholder} value={inputCode} onChange={e => setInputCode(e.target.value)} />
                                        <button onClick={handleJoin} disabled={loading || !nickname || !inputCode} className="btn-ghost px-6 rounded-lg font-bold">
                                            {t.join}
                                        </button>
                                    </div>
                                </div>
                            )}

                            {room && (
                                <>
                                    {/* Room Info Bar */}
                                    <div className="glass-panel rounded-xl p-3 flex justify-between items-center">
                                        <div className="flex items-center gap-2">
                                            <span className="font-mono font-bold text-lg tracking-widest text-cyan-400">{room.id}</span>
                                            <button onClick={() => navigator.clipboard.writeText(room.id)} className="text-[10px] bg-white/10 px-2 py-1 rounded">Copy</button>
                                        </div>
                                        <span className="text-xs text-gray-400">{t.round}: {room.currentRound || 0}</span>
                                    </div>

                                    {/* Waiting for players */}
                                    {room.status === 'waiting' && (
                                        <div className="glass-panel rounded-2xl p-6 text-center animate-fade-in">
                                            <div className="animate-pulse text-gray-400 text-sm mb-4">{t.waiting}</div>
                                            {room.admin === user.uid && (
                                                <button onClick={startGame} className="btn-neon w-full py-3 rounded-lg font-bold">
                                                    {t.start}
                                                </button>
                                            )}
                                        </div>
                                    )}

                                    {/* Game Finished */}
                                    {(room.status === 'finished_spy_caught' || room.status === 'finished_spy_wins') && (
                                        <div className="glass-panel rounded-2xl p-8 text-center animate-fade-in border border-purple-500">
                                            <h2 className="text-3xl font-black mb-4 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">
                                                {room.status === 'finished_spy_caught' ? t.agentsWin : t.spyWin}
                                            </h2>
                                            <p className="text-gray-400 mb-6">
                                                The Spy was: <span className="text-white font-bold">{room.players.find(p => p.uid === room.spyId)?.name}</span>
                                            </p>
                                            {room.admin === user.uid && (
                                                <button onClick={resetGame} className="btn-ghost border-white/20 text-white w-full py-3 rounded-lg">
                                                    {t.playAgain}
                                                </button>
                                            )}
                                        </div>
                                    )}

                                    {/* Discussion Phase */}
                                    {room.status === 'discussing' && (
                                        <div className="space-y-4 animate-fade-in">
                                            
                                            {/* Identity Card */}
                                            <div className={`identity-square glass-panel ${isSpy ? 'identity-spy' : 'identity-agent'}`}>
                                                <div className="relative z-10 p-6 flex flex-col items-center justify-center h-full">
                                                    <span className={`text-[10px] font-bold uppercase tracking-widest mb-2 px-3 py-1 rounded-full ${isSpy ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}`}>
                                                        {isSpy ? t.statusSpy : t.statusAgent}
                                                    </span>
                                                    
                                                    {isSpy ? (
                                                        <>
                                                            <div className="text-5xl mb-2">üïµÔ∏è</div>
                                                            <h3 className="text-3xl font-black tracking-wider text-red-500">???</h3>
                                                            <p className="text-xs text-gray-500 mt-2 text-center">{lang === 'ar' ? 'ÿßŸÉÿ™ÿ¥ŸÅ ÿßŸÑŸÖŸÉÿßŸÜ ÿØŸàŸÜ ÿ£ŸÜ ÿ™ŸÜŸÉÿ¥ŸÅ' : 'Find the location without getting caught'}</p>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <div className="text-4xl font-black mt-2 text-center px-2">
                                                                {lang === 'ar' ? room.scenario?.loc_ar : room.scenario?.loc_en}
                                                            </div>
                                                            <p className="text-xs text-gray-400 mt-2">{t.location}</p>
                                                        </>
                                                    )}
                                                </div>
                                            </div>

                                            {/* Chat Area */}
                                            <div className="glass-panel rounded-2xl p-4 flex flex-col overflow-hidden">
                                                <div className="chat-container space-y-2 mb-3 px-2">
                                                    {room.messages?.slice(-20).map((m, i) => (
                                                        <div key={i} className={`flex w-full ${m.sender === user.uid ? 'justify-end' : 'justify-start'}`}>
                                                            <div className={m.sender === user.uid ? 'chat-bubble-me' : 'chat-bubble-other'}>
                                                                <div className="text-[10px] opacity-70 mb-1 font-bold">{m.name}</div>
                                                                <div className="text-sm leading-tight">{m.text}</div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                                
                                                {!isSpectator && isMyTurn ? (
                                                    <form onSubmit={sendMessage} className="flex gap-2 mt-auto border-t border-white/10 pt-3">
                                                        <input 
                                                            className="input-dark flex-1 p-3 rounded-xl text-sm" 
                                                            placeholder={t.chatPlaceholder} 
                                                            value={chatMsg} 
                                                            onChange={e => setChatMsg(e.target.value)} 
                                                        />
                                                        <button type="submit" className="btn-neon px-5 rounded-xl text-xs">{t.send}</button>
                                                        <button type="button" onClick={() => handleSkipTurn(false)} className="btn-ghost px-4 rounded-xl text-xs border-orange-500 text-orange-400">{t.skip}</button>
                                                    </form>
                                                ) : (
                                                    <div className="text-center text-xs text-gray-600 py-3 border-t border-white/10 mt-2">
                                                        {isSpectator ? t.spectator : "Waiting for turn..."}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}

                                    {/* Voting Phase */}
                                    {room.status === 'voting' && (
                                        <div className="glass-panel rounded-2xl p-6 animate-fade-in space-y-4">
                                            <div className="flex justify-between items-center">
                                                <h3 className="text-lg font-bold text-yellow-400">{t.vote}</h3>
                                                {/* Voting Timer Circle */}
                                                <div className="relative w-10 h-10">
                                                    <svg className="w-full h-full transform -rotate-90" viewBox="0 0 36 36">
                                                        <circle cx="18" cy="18" r="16" fill="none" stroke="rgba(255,255,255,0.1)" strokeWidth="3"></circle>
                                                        <circle 
                                                            cx="18" cy="18" r="16" 
                                                            fill="none" 
                                                            stroke="#ff0055" 
                                                            strokeWidth="3"
                                                            strokeDasharray={`${(votingTimer/30)*100} ${100-((votingTimer/30)*100)}`}
                                                            strokeDashoffset="0"
                                                            strokeLinecap="round"
                                                        ></circle>
                                                    </svg>
                                                    <div className="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-yellow-400">
                                                        {votingTimer}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {!hasVoted ? (
                                                <>
                                                    <div className="grid grid-cols-2 gap-3">
                                                        {room.players.filter(p => p.status === 'active').map(p => (
                                                            <button key={p.uid} onClick={() => submitVote(p.uid)}
                                                                className={`p-4 rounded-xl border text-sm font-bold transition-all bg-white/5 border-white/10 hover:border-pink-400 hover:bg-pink-500/10`}
                                                            >
                                                                {p.name}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </>
                                            ) : (
                                                <div className="text-center space-y-4 py-4">
                                                    <div className="text-green-400 font-bold">{t.voteDone}</div>
                                                    <div className="text-xs text-gray-500">{t.voteWait}</div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
