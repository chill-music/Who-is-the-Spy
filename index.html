<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PRO SPY | Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Noto+Sans+Arabic:wght@400;700;900&display=swap');
        
        :root {
            --primary: #00f2ff;
            --accent: #7000ff;
            --bg: #050505;
        }

        body { 
            background-color: var(--bg); 
            color: #ffffff;
            font-family: 'Space Grotesk', 'Noto Sans Arabic', sans-serif;
            margin: 0;
            overflow-x: hidden;
            user-select: none;
        }

        .bg-grid {
            background-image: 
                linear-gradient(to right, rgba(112, 0, 255, 0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(112, 0, 255, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            position: fixed;
            inset: 0;
            z-index: -1;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
        }

        @keyframes revealUp {
            0% { opacity: 0; transform: translateY(20px) scale(0.95); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-reveal { animation: revealUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -10px var(--accent);
            filter: brightness(1.1);
        }

        .user-badge {
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0% { border-color: rgba(0, 242, 255, 0.2); box-shadow: 0 0 0 0 rgba(0, 242, 255, 0.2); }
            50% { border-color: rgba(0, 242, 255, 0.8); box-shadow: 0 0 15px 0 rgba(0, 242, 255, 0.4); }
            100% { border-color: rgba(0, 242, 255, 0.2); box-shadow: 0 0 0 0 rgba(0, 242, 255, 0.2); }
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    <div id="root"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyApAJaNfF0YHupunLRlK3jRYvttxczWShY",
            authDomain: "who-is-the-spy-919b9.firebaseapp.com",
            projectId: "who-is-the-spy-919b9",
            storageBucket: "who-is-the-spy-919b9.firebasestorage.app",
            messagingSenderId: "607075438373",
            appId: "1:607075438373:web:a03e9fb8b243cd993e14cc"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'pro_spy_v2_ultimate';
        const GEMINI_KEY = ""; 

        const TRANSLATIONS = {
            en: {
                appName: "PRO SPY", tagline: "TRUST NO ONE", nickname: "Operator Alias",
                create: "CREATE HQ", join: "JOIN OPS", codePlaceholder: "ACCESS CODE",
                players: "AGENTS", start: "LAUNCH", spyTitle: "IDENTITY: SPY",
                spyDesc: "Objective corrupted. Infiltrate.", citizenTitle: "IDENTITY: AGENT",
                objective: "MISSION OBJECTIVE", voting: "TARGET LOCK",
                timer: "LOCKDOWN:", sec: "S", copied: "COPIED", copy: "COPY",
                waiting: "Awaiting Command...", loading: "LOADING...",
                you: "YOU", newRound: "NEW MISSION", langBtn: "العربية",
                yourChoice: "PENDING:", confirmedChoice: "LOCKED:",
                noChoice: "NO SELECTION", lockIn: "CONFIRM", locked: "LOCKED"
            },
            ar: {
                appName: "برو جاسوس", tagline: "لا تثق بأحد", nickname: "اسم العميل",
                create: "إنشاء المقر", join: "انضمام", codePlaceholder: "رمز الدخول",
                players: "العملاء", start: "بدء المهمة", spyTitle: "الهوية: جاسوس",
                spyDesc: "بيانات تالفة. تسلل.", citizenTitle: "الهوية: عميل",
                objective: "هدف المهمة", voting: "تحديد الهدف",
                timer: "الإغلاق:", sec: "ث", copied: "تم النسخ", copy: "نسخ",
                waiting: "بانتظار الأوامر...", loading: "جاري التحميل...",
                you: "أنت", newRound: "مهمة جديدة", langBtn: "English",
                yourChoice: "المختار:", confirmedChoice: "المؤكد:",
                noChoice: "لم يتم الاختيار", lockIn: "تأكيد", locked: "تم الحجز"
            }
        };

        // قاعدة بيانات كبيرة من الأسئلة المحلية لمنع التكرار
        const LOCAL_SCENARIOS = [
            { loc_ar: "محطة الفضاء الدولية", words_ar: ["أكسجين", "جاذبية", "مدار", "روبوت"], loc_en: "International Space Station", words_en: ["Oxygen", "Gravity", "Orbit", "Robot"] },
            { loc_ar: "غواصة نووية", words_ar: ["عمق", "ضغط", "طوربيد", "سونار"], loc_en: "Nuclear Submarine", words_en: ["Depth", "Pressure", "Torpedo", "Sonar"] },
            { loc_ar: "كازينو سري", words_ar: ["رهان", "بطاقات", "رقائق", "حراس"], loc_en: "Secret Casino", words_en: ["Bet", "Cards", "Chips", "Guards"] },
            { loc_ar: "مختبر أبحاث", words_ar: ["تجربة", "عينة", "مجهر", "مختبر"], loc_en: "Research Lab", words_en: ["Experiment", "Sample", "Microscope", "Lab"] },
            { loc_ar: "قاعدة عسكرية", words_ar: ["جنود", "طائرات", "رادار", "خندق"], loc_en: "Military Base", words_en: ["Soldiers", "Aircraft", "Radar", "Trench"] },
            { loc_ar: "مطار دولي", words_ar: ["جواز", "طائرة", "باسبورت", "بوابة"], loc_en: "International Airport", words_en: ["Passport", "Plane", "Boarding", "Gate"] },
            { loc_ar: "سفينة قراصنة", words_ar: ["كنز", "سيف", "شراع", "بحار"], loc_en: "Pirate Ship", words_en: ["Treasure", "Sword", "Sail", "Sailor"] },
            { loc_ar: "مستشفى", words_ar: ["طبيب", "ممرض", "عملية", "دواء"], loc_en: "Hospital", words_en: ["Doctor", "Nurse", "Surgery", "Medicine"] },
            { loc_ar: "مطعم فاخر", words_ar: ["نادل", "قائمة", "منديل", "حلوى"], loc_en: "Fancy Restaurant", words_en: ["Waiter", "Menu", "Napkin", "Dessert"] },
            { loc_ar: "بنك مركزي", words_ar: ["خزنة", "مال", "حراس", "قروض"], loc_en: "Central Bank", words_en: ["Vault", "Money", "Guards", "Loans"] },
            { loc_ar: "مصنع سيارات", words_ar: ["تجميع", "محرك", "إطارات", "روبوت"], loc_en: "Car Factory", words_en: ["Assembly", "Engine", "Tires", "Robot"] },
            { loc_ar: "مدرسة", words_ar: ["معلم", "طلاب", "سبورة", "امتحان"], loc_en: "School", words_en: ["Teacher", "Students", "Board", "Exam"] },
            { loc_ar: "مسرح", words_ar: ["ممثل", "ستائر", "مقاعد", "إضاءة"], loc_en: "Theater", words_en: ["Actor", "Curtains", "Seats", "Lighting"] },
            { loc_ar: "فندق 5 نجوم", words_ar: ["استقبال", "جناح", "مفتاح", "خدمة"], loc_en: "5 Star Hotel", words_en: ["Reception", "Suite", "Key", "Service"] },
            { loc_ar: "سجن شديد الحراسة", words_ar: ["زنزانة", "حراس", "قضبان", "هروب"], loc_en: "High Security Prison", words_en: ["Cell", "Guards", "Bars", "Escape"] },
            { loc_ar: "محطة قطارات", words_ar: ["تذاكر", "رصيف", "قطار", "مواعيد"], loc_en: "Train Station", words_en: ["Tickets", "Platform", "Train", "Schedule"] },
            { loc_ar: "ملعب كرة قدم", words_ar: ["حكم", "هدف", "جمهور", "فريق"], loc_en: "Football Stadium", words_en: ["Referee", "Goal", "Crowd", "Team"] },
            { loc_ar: "مركز تسوق", words_ar: ["محلات", "عربات", "خصومات", "طوابق"], loc_en: "Shopping Mall", words_en: ["Stores", "Carts", "Discounts", "Floors"] },
            { loc_ar: "شاطئ استوائي", words_ar: ["رمال", "أمواج", "شمس", "قوارب"], loc_en: "Tropical Beach", words_en: ["Sand", "Waves", "Sun", "Boats"] },
            { loc_ar: "مكتبة عامة", words_ar: ["كتب", "صمت", "رفوف", "استعارة"], loc_en: "Public Library", words_en: ["Books", "Silence", "Shelves", "Borrowing"] },
            { loc_ar: "صالة رياضية", words_ar: ["أثقال", "تمارين", "مدرب", "معدات"], loc_en: "Gym", words_en: ["Weights", "Exercises", "Trainer", "Equipment"] },
            { loc_ar: "حديقة حيوان", words_ar: ["أقفاص", "حيوانات", "زوار", "طعام"], loc_en: "Zoo", words_en: ["Cages", "Animals", "Visitors", "Food"] },
            { loc_ar: "مسبح أولمبي", words_ar: ["سباق", "غوص", "حوارات", "مدرب"], loc_en: "Olympic Pool", words_en: ["Race", "Diving", "Lanes", "Coach"] },
            { loc_ar: "مزرعة", words_ar: ["حيوانات", "حصاد", "تراكتور", "بئر"], loc_en: "Farm", words_en: ["Animals", "Harvest", "Tractor", "Well"] },
            { loc_ar: "مخيم صيفي", words_ar: ["خيام", "نار", "أنشطة", "طبيعة"], loc_en: "Summer Camp", words_en: ["Tents", "Fire", "Activities", "Nature"] },
            { loc_ar: "دار أيتام", words_ar: ["أطفال", "رعاة", "غرف", "ألعاب"], loc_en: "Orphanage", words_en: ["Children", "Caregivers", "Rooms", "Toys"] },
            { loc_ar: "مركز شرطة", words_ar: ["ضباط", "زنزانة", "تحقيق", "قضية"], loc_en: "Police Station", words_en: ["Officers", "Cell", "Investigation", "Case"] },
            { loc_ar: "محطة إطفاء", words_ar: ["شاحنة", "خرطوم", "إنذار", "طوارئ"], loc_en: "Fire Station", words_en: ["Truck", "Hose", "Alarm", "Emergency"] },
            { loc_ar: "مكتب محاماة", words_ar: ["قضايا", "ملفات", "محكمة", "عقود"], loc_en: "Law Firm", words_en: ["Cases", "Files", "Court", "Contracts"] },
            { loc_ar: "وكالة سفر", words_ar: ["حجز", "طيران", "فنادق", "تأشيرات"], loc_en: "Travel Agency", words_en: ["Booking", "Flights", "Hotels", "Visas"] },
            { loc_ar: "مصحة نفسية", words_ar: ["مرضى", "أطباء", "جلسات", "علاج"], loc_en: "Psychiatric Ward", words_en: ["Patients", "Doctors", "Sessions", "Treatment"] },
            { loc_ar: "منصة نفط", words_ar: ["حفر", "أنابيب", "عمال", "معدات"], loc_en: "Oil Rig", words_en: ["Drilling", "Pipes", "Workers", "Equipment"] },
            { loc_ar: "محطة تلفزيون", words_ar: ["تصوير", "برامج", "مخرج", "إضاءة"], loc_en: "TV Station", words_en: ["Filming", "Shows", "Director", "Lighting"] },
            { loc_ar: "متحف", words_ar: ["معروضات", "حراس", "تذاكر", "جولات"], loc_en: "Museum", words_en: ["Exhibits", "Guards", "Tickets", "Tours"] },
            { loc_ar: "ملاهي ليلية", words_ar: ["أضواء", "موسيقى", "رقص", "مشروبات"], loc_en: "Nightclub", words_en: ["Lights", "Music", "Dancing", "Drinks"] },
            { loc_ar: "قصر ملكي", words_ar: ["حراس", "عرش", "خدم", "كنوز"], loc_en: "Royal Palace", words_en: ["Guards", "Throne", "Servants", "Treasures"] },
            { loc_ar: "مأوى مشردون", words_ar: ["طعام", "أسرّة", "ملابس", "تبرعات"], loc_en: "Homeless Shelter", words_en: ["Food", "Beds", "Clothes", "Donations"] },
            { loc_ar: "خيمة سيرك", words_ar: ["بهلوان", "حيوانات", "موسيقى", "جمهور"], loc_en: "Circus Tent", words_en: ["Acrobat", "Animals", "Music", "Audience"] },
            { loc_ar: "منارة قديمة", words_ar: ["ضوء", "سلم", "بحر", "سفن"], loc_en: "Old Lighthouse", words_en: ["Light", "Stairs", "Sea", "Ships"] },
            { loc_ar: "محطة مترو", words_ar: ["تذاكر", "قطارات", "رصيف", "جمهور"], loc_en: "Subway Station", words_en: ["Tickets", "Trains", "Platform", "Crowd"] },
            { loc_ar: "مقهى أدبي", words_ar: ["كتب", "قهوة", "نقاشات", "شعراء"], loc_en: "Literary Cafe", words_en: ["Books", "Coffee", "Discussions", "Poets"] },
            { loc_ar: "محكمة", words_ar: ["قاضي", "محامي", "شهود", "قضية"], loc_en: "Courtroom", words_en: ["Judge", "Lawyer", "Witnesses", "Case"] },
            { loc_ar: "صيدلية", words_ar: ["أدوية", "وصفات", "صيدلي", "رفوف"], loc_en: "Pharmacy", words_en: ["Medicines", "Prescriptions", "Pharmacist", "Shelves"] },
            { loc_ar: "ورشة ميكانيكا", words_ar: ["سيارات", "أدوات", "زيت", "إصلاح"], loc_en: "Mechanic Workshop", words_en: ["Cars", "Tools", "Oil", "Repair"] },
            { loc_ar: "خباز تقليدي", words_ar: ["عجين", "فرن", "خبز", "دقيق"], loc_en: "Traditional Bakery", words_en: ["Dough", "Oven", "Bread", "Flour"] },
            { loc_ar: "ستوديو تصوير", words_ar: ["كاميرات", "إضاءة", "موديل", "خلفيات"], loc_en: "Photo Studio", words_en: ["Cameras", "Lighting", "Model", "Backgrounds"] },
            { loc_ar: "مركز اتصالات", words_ar: ["هواتف", "أجهزة", "إشارات", "كابلات"], loc_en: "Communication Center", words_en: ["Phones", "Devices", "Signals", "Cables"] },
            { loc_ar: "معرض سيارات", words_ar: ["سيارات", "بائع", "زوار", "عروض"], loc_en: "Car Showroom", words_en: ["Cars", "Salesman", "Visitors", "Deals"] },
            { loc_ar: "مصنع شوكولاتة", words_ar: ["كاكاو", "قوالب", "تغليف", "حلوى"], loc_en: "Chocolate Factory", words_en: ["Cocoa", "Molds", "Packaging", "Sweets"] }
        ];

        // دالة للحصول على سيناريو جديد غير مكرر
        async function fetchScenario(usedLocations = []) {
            // فلترة السيناريوهات المستخدمة
            const availableScenarios = LOCAL_SCENARIOS.filter(s => 
                !usedLocations.includes(s.loc_ar) && !usedLocations.includes(s.loc_en)
            );
            
            // إذا نفدت السيناريوهات، أعد تعيين القائمة
            if (availableScenarios.length === 0) {
                return LOCAL_SCENARIOS[Math.floor(Math.random() * LOCAL_SCENARIOS.length)];
            }
            
            // اختيار سيناريو عشوائي من المتاحة
            return availableScenarios[Math.floor(Math.random() * availableScenarios.length)];
        }

        function App() {
            const [lang, setLang] = useState('en');
            const [user, setUser] = useState(null);
            const [room, setRoom] = useState(null);
            const [roomId, setRoomId] = useState('');
            const [inputCode, setInputCode] = useState('');
            const [nickname, setNickname] = useState(localStorage.getItem('pro_spy_nick') || '');
            const [loading, setLoading] = useState(false);
            const [timeLeft, setTimeLeft] = useState(0);
            const [copyStatus, setCopyStatus] = useState(false);
            const [isLocked, setIsLocked] = useState(false);
            const [tempVote, setTempVote] = useState(null);
            const lastAutoVoteRef = useRef(false);

            const t = TRANSLATIONS[lang];

            useEffect(() => {
                const unsub = auth.onAuthStateChanged(async (u) => { if (u) setUser(u); else await auth.signInAnonymously(); });
                return unsub;
            }, []);

            useEffect(() => {
                if (!user || !roomId) return;
                const unsub = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId)
                    .onSnapshot(doc => {
                        const data = doc.exists ? doc.data() : null;
                        setRoom(data);
                        if (data?.status === 'waiting') { 
                            setIsLocked(false); 
                            setTempVote(null);
                            lastAutoVoteRef.current = false;
                        }
                    });
                return unsub;
            }, [user, roomId]);

            // Timer logic
            useEffect(() => {
                let timer;
                if (room?.status === 'playing' && room?.timerStart) {
                    timer = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - room.timerStart) / 1000);
                        const remaining = Math.max(0, 20 - elapsed);
                        setTimeLeft(remaining);
                    }, 1000);
                }
                return () => clearInterval(timer);
            }, [room?.status, room?.timerStart]);

            // Auto-vote for players who didn't vote when time runs out
            useEffect(() => {
                if (room?.status === 'playing' && timeLeft === 0 && !lastAutoVoteRef.current && room?.scenario && user?.uid) {
                    lastAutoVoteRef.current = true;
                    
                    const currentPlayer = room.players.find(p => p.uid === user.uid);
                    const isSpy = room.spyId === user.uid;
                    
                    // فقط للاعبين غير الجاسوس الذين لم يختاروا
                    if (!isSpy && currentPlayer && !currentPlayer.vote) {
                        const words = lang === 'ar' ? room.scenario.words_ar : room.scenario.words_en;
                        const randomWord = words[Math.floor(Math.random() * words.length)];
                        
                        // تحديث التصويت تلقائياً
                        const updated = room.players.map(p => 
                            p.uid === user.uid ? { ...p, vote: randomWord } : p
                        );
                        
                        db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId)
                            .update({ players: updated });
                    }
                }
            }, [timeLeft, room?.status, room?.players, room?.scenario, user?.uid, room?.spyId, lang, roomId]);

            const majorityWord = useMemo(() => {
                if (!room?.players || !room?.scenario) return null;
                const wordsList = lang === 'ar' ? room.scenario.words_ar : room.scenario.words_en;
                const counts = {};
                let totalVotes = 0;
                room.players.forEach(p => { if (p.vote) { counts[p.vote] = (counts[p.vote] || 0) + 1; totalVotes++; } });
                if (totalVotes === 0) return wordsList[Math.floor(Math.abs(room.timerStart % wordsList.length))];
                let max = 0, winners = [];
                for (const word in counts) {
                    if (counts[word] > max) { max = counts[word]; winners = [word]; }
                    else if (counts[word] === max) winners.push(word);
                }
                return winners[0];
            }, [room?.players, room?.scenario, lang]);

            const handleCreate = async () => {
                if (!nickname.trim()) return;
                setLoading(true);
                const id = Math.random().toString(36).substring(2, 7).toUpperCase();
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(id).set({
                    id, admin: user.uid, status: 'waiting',
                    players: [{ uid: user.uid, name: nickname, vote: null }],
                    scenario: null, spyId: null, timerStart: null,
                    usedLocations: [] // قائمة المواقع المستخدمة
                });
                setRoomId(id);
                setLoading(false);
            };

            const handleJoin = async () => {
                const code = inputCode.toUpperCase();
                if (!nickname.trim() || !code) return;
                setLoading(true);
                const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(code);
                const snap = await ref.get();
                if (snap.exists) {
                    const data = snap.data();
                    if (!data.players.find(p => p.uid === user.uid)) {
                        await ref.update({ players: [...data.players, { uid: user.uid, name: nickname, vote: null }] });
                    }
                    setRoomId(code);
                }
                setLoading(false);
            };

            const startMission = async () => {
                if (room.admin !== user.uid) return;
                setLoading(true);
                
                // الحصول على المواقع المستخدمة سابقاً
                const usedLocations = room.usedLocations || [];
                
                // جلب سيناريو جديد غير مكرر
                const scenario = await fetchScenario(usedLocations);
                const spy = room.players[Math.floor(Math.random() * room.players.length)];
                
                // إضافة الموقع الجديد للقائمة المستخدمة
                const newUsedLocations = [...usedLocations, scenario.loc_ar, scenario.loc_en];
                
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                    status: 'playing', 
                    scenario, 
                    spyId: spy.uid, 
                    timerStart: Date.now(),
                    players: room.players.map(p => ({ ...p, vote: null })),
                    usedLocations: newUsedLocations
                });
                
                lastAutoVoteRef.current = false;
                setLoading(false);
            };

            const confirmVote = async () => {
                if (!tempVote || isLocked || timeLeft <= 0) return;
                setIsLocked(true);
                const updated = room.players.map(p => p.uid === user.uid ? { ...p, vote: tempVote } : p);
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({ players: updated });
            };

            return (
                <div className="min-h-screen p-4 md:p-8 flex flex-col items-center" dir={lang === 'ar' ? 'rtl' : 'ltr'}>
                    <div className="w-full max-w-lg space-y-6">
                        
                        <header className="flex justify-between items-center animate-reveal">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 glass flex items-center justify-center border-cyan-500/40">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" className="text-cyan-400">
                                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                    </svg>
                                </div>
                                <h1 className="text-3xl font-black tracking-tighter">{t.appName}</h1>
                            </div>
                            <button onClick={() => setLang(lang === 'en' ? 'ar' : 'en')} className="glass px-4 py-2 text-[10px] font-bold uppercase tracking-wider">{t.langBtn}</button>
                        </header>

                        {!room ? (
                            <main className="glass p-8 space-y-8 animate-reveal">
                                <div className="space-y-2">
                                    <label className="text-[10px] font-black opacity-40 uppercase mr-2">{t.nickname}</label>
                                    <input className="w-full bg-black/40 border border-white/10 p-4 rounded-xl font-bold focus:border-cyan-500 outline-none transition-all" value={nickname} onChange={e => { setNickname(e.target.value); localStorage.setItem('pro_spy_nick', e.target.value); }} />
                                </div>
                                <div className="space-y-4">
                                    <button onClick={handleCreate} disabled={loading || !nickname} className="btn-primary w-full py-4 rounded-xl font-black text-sm uppercase">{t.create}</button>
                                    <div className="flex gap-2">
                                        <input className="flex-1 bg-black/40 border border-white/10 p-4 rounded-xl font-mono text-center font-black uppercase text-sm" placeholder={t.codePlaceholder} value={inputCode} onChange={e => setInputCode(e.target.value.toUpperCase())} />
                                        <button onClick={handleJoin} disabled={loading || !nickname || !inputCode} className="glass px-6 font-black text-xs">{t.join}</button>
                                    </div>
                                </div>
                            </main>
                        ) : (
                            <div className="space-y-4 animate-reveal">
                                <div className="glass p-4 flex justify-between items-center">
                                    <div className="flex items-center gap-2">
                                        <span className="text-sm font-black text-cyan-400">{room.id}</span>
                                        <button onClick={() => { navigator.clipboard.writeText(room.id); setCopyStatus(true); setTimeout(()=>setCopyStatus(false),2000); }} className="text-[8px] bg-white/5 p-1 rounded uppercase">{copyStatus ? 'OK' : 'Copy'}</button>
                                    </div>
                                    <div className="text-[10px] font-black opacity-40 uppercase">{t.players}: {room.players.length}</div>
                                </div>

                                {room.status === 'waiting' ? (
                                    <div className="glass p-6 space-y-6">
                                        <div className="grid grid-cols-2 gap-2">
                                            {room.players.map((p, i) => (
                                                <div key={i} className={`p-3 rounded-xl border flex items-center justify-between text-[11px] font-black transition-all ${p.uid === user.uid ? 'bg-cyan-500/10 border-cyan-500/50 user-badge' : 'bg-white/5 border-white/5 opacity-60'}`}>
                                                    <span className="truncate">{p.name}</span>
                                                    {p.uid === user.uid && <span className="text-[8px] bg-cyan-500 text-black px-1 rounded animate-pulse ml-1">{t.you}</span>}
                                                </div>
                                            ))}
                                        </div>
                                        {room.admin === user.uid ? <button onClick={startMission} className="btn-primary w-full py-4 rounded-xl font-black uppercase">{t.start}</button> : <div className="text-center text-[10px] opacity-30 animate-pulse font-black uppercase tracking-[0.2em]">{t.waiting}</div>}
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        <div className={`p-8 rounded-[2rem] border-b-8 text-center transition-all animate-reveal ${room.spyId === user.uid ? 'bg-red-950/40 border-red-700' : 'bg-cyan-950/40 border-cyan-700'}`}>
                                            <h2 className="text-2xl font-black italic mb-4 uppercase">{room.spyId === user.uid ? t.spyTitle : t.citizenTitle}</h2>
                                            {room.spyId !== user.uid ? <div className="text-5xl font-black tracking-tight">{lang === 'ar' ? room.scenario?.loc_ar : room.scenario?.loc_en}</div> : <div className="bg-black/40 p-3 rounded-2xl text-[11px] italic opacity-70">{t.spyDesc}</div>}
                                        </div>

                                        <div className="glass p-6 space-y-6">
                                            <div className="flex justify-between items-center"><h3 className="font-black text-sm uppercase tracking-widest">{t.voting}</h3><div className="text-xl font-black text-cyan-400">{timeLeft}{t.sec}</div></div>

                                            <div className="grid grid-cols-2 gap-2">
                                                {(room.spyId !== user.uid ? (lang === 'ar' ? room.scenario?.words_ar : room.scenario?.words_en) : ["?","?","?","?"])?.map((word, idx) => (
                                                    <button key={idx} onClick={() => !isLocked && room.spyId !== user.uid && setTempVote(word)} disabled={timeLeft <= 0 || room.spyId === user.uid || isLocked} 
                                                        className={`p-4 rounded-xl border-2 font-black transition-all text-xs ${tempVote === word ? 'bg-cyan-500 text-black border-cyan-400' : 'bg-white/5 border-white/5 opacity-70'}`}>
                                                        {word}
                                                    </button>
                                                ))}
                                            </div>

                                            {room.spyId !== user.uid && (
                                                <div className="space-y-3">
                                                    <div className="bg-black/40 p-4 rounded-xl border border-white/5">
                                                        <span className="text-[9px] font-black opacity-30 uppercase">{timeLeft > 0 ? t.yourChoice : t.confirmedChoice}</span>
                                                        <div className="text-lg font-black text-cyan-400">{timeLeft > 0 ? (tempVote || "...") : majorityWord}</div>
                                                    </div>
                                                    {timeLeft > 0 && !isLocked && <button onClick={confirmVote} disabled={!tempVote} className="btn-primary w-full py-3 rounded-xl font-black text-xs">{t.lockIn}</button>}
                                                </div>
                                            )}

                                            {room.admin === user.uid && timeLeft <= 0 && <button onClick={startMission} className="w-full bg-white/5 py-4 rounded-xl font-black border border-white/10 text-xs uppercase">{t.newRound}</button>}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        <footer className="text-center opacity-10 font-mono text-[8px] tracking-[0.5em] py-8 uppercase">V2.2.0 // NO_REPEAT_SCENARIOS</footer>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
