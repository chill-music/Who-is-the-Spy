<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PRO SPY | Covert Operations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;600;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0b;
            --fg: #e8e8e8;
            --muted: #4a4a4f;
            --accent: #ff6b35;
            --accent-dim: rgba(255, 107, 53, 0.15);
            --card: #141416;
            --border: #2a2a2e;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #eab308;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body { 
            background: var(--bg);
            color: var(--fg);
            font-family: 'Outfit', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Atmospheric Background */
        .bg-atmosphere {
            position: fixed;
            inset: 0;
            z-index: -1;
            background: 
                radial-gradient(ellipse 80% 50% at 50% -20%, rgba(255, 107, 53, 0.08), transparent),
                radial-gradient(ellipse 60% 40% at 80% 100%, rgba(255, 107, 53, 0.05), transparent),
                var(--bg);
        }

        .bg-atmosphere::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            opacity: 0.03;
            pointer-events: none;
        }

        /* Scan Lines */
        .scan-lines {
            position: fixed;
            inset: 0;
            z-index: 1000;
            pointer-events: none;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.03) 2px,
                rgba(0, 0, 0, 0.03) 4px
            );
        }

        /* Typography */
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .font-display { font-family: 'Outfit', sans-serif; }

        /* Card Styles */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            border-color: rgba(255, 107, 53, 0.3);
        }

        /* Button Styles */
        .btn {
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--accent);
            color: #0a0a0b;
            font-weight: 700;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px -8px rgba(255, 107, 53, 0.5);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--fg);
        }

        .btn-secondary:hover:not(:disabled) {
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Input Styles */
        .input-field {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--fg);
            transition: all 0.2s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }

        .input-field::placeholder {
            color: var(--muted);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes radar {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        .animate-slide-in {
            animation: slideIn 0.4s ease-out forwards;
        }

        .animate-pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        .animate-shake {
            animation: shake 0.3s ease-in-out;
        }

        /* Stagger delays */
        .delay-1 { animation-delay: 0.1s; opacity: 0; }
        .delay-2 { animation-delay: 0.2s; opacity: 0; }
        .delay-3 { animation-delay: 0.3s; opacity: 0; }
        .delay-4 { animation-delay: 0.4s; opacity: 0; }

        /* Timer Ring */
        .timer-ring {
            transform: rotate(-90deg);
        }

        .timer-ring circle {
            transition: stroke-dashoffset 1s linear;
        }

        /* Player Badge */
        .player-badge {
            position: relative;
            overflow: hidden;
        }

        .player-badge.is-you::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 107, 53, 0.1), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Word Button */
        .word-btn {
            position: relative;
            overflow: hidden;
        }

        .word-btn.selected {
            background: var(--accent);
            color: var(--bg);
            border-color: var(--accent);
        }

        .word-btn.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Identity Card */
        .identity-card {
            position: relative;
            overflow: hidden;
        }

        .identity-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .identity-card.spy::before {
            background: linear-gradient(90deg, var(--danger), #ff8c00);
        }

        .identity-card.agent::before {
            background: linear-gradient(90deg, var(--success), #00ff88);
        }

        /* Status Indicator */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.online {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        .status-dot.waiting {
            background: var(--warning);
            animation: pulse 1.5s infinite;
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--muted);
        }
    </style>
</head>
<body>
    <div class="bg-atmosphere"></div>
    <div class="scan-lines"></div>
    <div id="root"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyApAJaNfF0YHupunLRlK3jRYvttxczWShY",
            authDomain: "who-is-the-spy-919b9.firebaseapp.com",
            projectId: "who-is-the-spy-919b9",
            storageBucket: "who-is-the-spy-919b9.firebasestorage.app",
            messagingSenderId: "607075438373",
            appId: "1:607075438373:web:a03e9fb8b243cd993e14cc"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'pro_spy_v3_tactical';

        const TRANSLATIONS = {
            en: {
                appName: "PRO SPY",
                tagline: "COVERT OPERATIONS",
                nickname: "CALLSIGN",
                create: "ESTABLISH HQ",
                join: "INFILTRATE",
                codePlaceholder: "MISSION CODE",
                players: "OPERATIVES",
                start: "COMMENCE OPERATION",
                spyTitle: "YOU ARE THE SPY",
                spyDesc: "Blend in. Identify the location. Eliminate suspicion.",
                citizenTitle: "YOU ARE AN AGENT",
                objective: "MISSION LOCATION",
                voting: "INTELLIGENCE CHECK",
                timer: "COUNTDOWN",
                sec: "s",
                copied: "COPIED",
                copy: "COPY",
                waiting: "Awaiting team assembly...",
                loading: "PROCESSING...",
                you: "YOU",
                newRound: "NEW OPERATION",
                langBtn: "العربية",
                yourChoice: "SELECTED:",
                confirmedChoice: "CONFIRMED:",
                noChoice: "NO SELECTION",
                lockIn: "CONFIRM INTEL",
                locked: "INTEL LOCKED",
                instructionSpy: "Discover the location without exposing yourself",
                instructionAgent: "Share your word to identify the spy",
                wordHint: "YOUR WORD",
                roundComplete: "ROUND COMPLETE",
                adminOnly: "Only Commander can start"
            },
            ar: {
                appName: "برو جاسوس",
                tagline: "عمليات سرية",
                nickname: "الاسم الرمزي",
                create: "إنشاء المقر",
                join: "التسلل",
                codePlaceholder: "رمز المهمة",
                players: "العملاء",
                start: "بدء العملية",
                spyTitle: "أنت الجاسوس",
                spyDesc: "اندس بينهم. اكتشف المكان. تجنب الاكتشاف.",
                citizenTitle: "أنت عميل",
                objective: "موقع المهمة",
                voting: "فحص المعلومات",
                timer: "العد التنازلي",
                sec: "ث",
                copied: "تم النسخ",
                copy: "نسخ",
                waiting: "في انتظار الفريق...",
                loading: "جاري المعالجة...",
                you: "أنت",
                newRound: "عملية جديدة",
                langBtn: "English",
                yourChoice: "المختار:",
                confirmedChoice: "المؤكد:",
                noChoice: "لم يتم الاختيار",
                lockIn: "تأكيد المعلومة",
                locked: "تم التثبيت",
                instructionSpy: "اكتشف المكان دون كشف نفسك",
                instructionAgent: "شارك كلمتك لتحديد الجاسوس",
                wordHint: "كلمتك",
                roundComplete: "انتهت الجولة",
                adminOnly: "فقط القائد يمكنه البدء"
            }
        };

        // Default scenarios for fallback
        const DEFAULT_SCENARIOS = [
            { loc_ar: "محطة فضاء دولية", words_ar: ["أكسجين", "جاذبية", "مدار", "صاروخ"], loc_en: "International Space Station", words_en: ["Oxygen", "Gravity", "Orbit", "Rocket"] },
            { loc_ar: "غواصة نووية", words_ar: ["عمق", "ضغط", "طوربيد", "سونار"], loc_en: "Nuclear Submarine", words_en: ["Depth", "Pressure", "Torpedo", "Sonar"] },
            { loc_ar: "كازينو underground", words_ar: ["رهان", "بطاقات", "رقائق", "حراس"], loc_en: "Underground Casino", words_en: ["Bet", "Cards", "Chips", "Guards"] },
            { loc_ar: "مختبر سري", words_ar: ["تجربة", "عينة", "حجرات", "بكتيريا"], loc_en: "Secret Laboratory", words_en: ["Experiment", "Sample", "Chambers", "Bacteria"] },
            { loc_ar: "قاعدة عسكرية مهجورة", words_ar: ["خنادق", "ألغام", "رادار", "طائرات"], loc_en: "Abandoned Military Base", words_en: ["Trenches", "Mines", "Radar", "Aircraft"] }
        ];

        function App() {
            const [lang, setLang] = useState('ar');
            const [user, setUser] = useState(null);
            const [room, setRoom] = useState(null);
            const [roomId, setRoomId] = useState('');
            const [inputCode, setInputCode] = useState('');
            const [nickname, setNickname] = useState(() => localStorage.getItem('pro_spy_nick') || '');
            const [loading, setLoading] = useState(false);
            const [timeLeft, setTimeLeft] = useState(0);
            const [copyStatus, setCopyStatus] = useState(false);
            const [isLocked, setIsLocked] = useState(false);
            const [tempVote, setTempVote] = useState(null);
            const [error, setError] = useState(null);
            const [connecting, setConnecting] = useState(true);
            const timerRef = useRef(null);

            const t = TRANSLATIONS[lang];
            const ROUND_DURATION = 45; // seconds

            // Auth initialization
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(
                    async (u) => {
                        if (u) {
                            setUser(u);
                        } else {
                            try {
                                await auth.signInAnonymously();
                            } catch (err) {
                                console.error('Auth error:', err);
                                setError('Authentication failed');
                            }
                        }
                        setConnecting(false);
                    },
                    (err) => {
                        console.error('Auth state error:', err);
                        setError('Connection error');
                        setConnecting(false);
                    }
                );
                return unsubscribe;
            }, []);

            // Room subscription
            useEffect(() => {
                if (!user || !roomId) return;
                
                const unsubscribe = db
                    .collection('artifacts')
                    .doc(appId)
                    .collection('public')
                    .doc('data')
                    .collection('rooms')
                    .doc(roomId)
                    .onSnapshot(
                        (doc) => {
                            if (doc.exists) {
                                const data = doc.data();
                                setRoom(data);
                                if (data?.status === 'waiting') {
                                    setIsLocked(false);
                                    setTempVote(null);
                                }
                            } else {
                                setRoom(null);
                                setError('Room not found');
                            }
                        },
                        (err) => {
                            console.error('Firestore error:', err);
                            setError('Connection lost');
                        }
                    );
                    
                return unsubscribe;
            }, [user, roomId]);

            // Timer logic
            useEffect(() => {
                if (room?.status === 'playing' && room?.timerStart) {
                    const updateTimer = () => {
                        const elapsed = Math.floor((Date.now() - room.timerStart) / 1000);
                        const remaining = Math.max(0, ROUND_DURATION - elapsed);
                        setTimeLeft(remaining);
                    };
                    
                    updateTimer();
                    timerRef.current = setInterval(updateTimer, 1000);
                } else {
                    if (timerRef.current) {
                        clearInterval(timerRef.current);
                        timerRef.current = null;
                    }
                    setTimeLeft(0);
                }
                
                return () => {
                    if (timerRef.current) {
                        clearInterval(timerRef.current);
                    }
                };
            }, [room?.status, room?.timerStart]);

            // Timer progress (0 to 1)
            const timerProgress = useMemo(() => {
                return timeLeft / ROUND_DURATION;
            }, [timeLeft]);

            // Majority word calculation
            const majorityWord = useMemo(() => {
                if (!room?.players || !room?.scenario) return null;
                const wordsList = lang === 'ar' ? room.scenario.words_ar : room.scenario.words_en;
                
                const counts = {};
                let totalVotes = 0;
                
                room.players.forEach(p => {
                    if (p.vote) {
                        counts[p.vote] = (counts[p.vote] || 0) + 1;
                        totalVotes++;
                    }
                });
                
                if (totalVotes === 0) {
                    return null;
                }
                
                let maxCount = 0;
                let winner = wordsList[0];
                
                for (const word in counts) {
                    if (counts[word] > maxCount) {
                        maxCount = counts[word];
                        winner = word;
                    }
                }
                
                return winner;
            }, [room?.players, room?.scenario, lang]);

            const handleCreate = async () => {
                if (!nickname.trim() || loading) return;
                
                setLoading(true);
                setError(null);
                
                try {
                    const id = Math.random().toString(36).substring(2, 7).toUpperCase();
                    const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(id);
                    
                    await ref.set({
                        id,
                        admin: user.uid,
                        status: 'waiting',
                        players: [{ uid: user.uid, name: nickname.trim(), vote: null, joinedAt: Date.now() }],
                        scenario: null,
                        spyId: null,
                        timerStart: null,
                        createdAt: Date.now()
                    });
                    
                    setRoomId(id);
                } catch (err) {
                    console.error('Create room error:', err);
                    setError('Failed to create room');
                } finally {
                    setLoading(false);
                }
            };

            const handleJoin = async () => {
                const code = inputCode.toUpperCase().trim();
                if (!nickname.trim() || !code || loading) return;
                
                setLoading(true);
                setError(null);
                
                try {
                    const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(code);
                    const snap = await ref.get();
                    
                    if (!snap.exists) {
                        setError('Room not found');
                        setLoading(false);
                        return;
                    }
                    
                    const data = snap.data();
                    
                    if (data.status !== 'waiting') {
                        setError('Game already in progress');
                        setLoading(false);
                        return;
                    }
                    
                    const existingPlayer = data.players.find(p => p.uid === user.uid);
                    if (!existingPlayer) {
                        await ref.update({
                            players: firebase.firestore.FieldValue.arrayUnion({
                                uid: user.uid,
                                name: nickname.trim(),
                                vote: null,
                                joinedAt: Date.now()
                            })
                        });
                    }
                    
                    setRoomId(code);
                } catch (err) {
                    console.error('Join room error:', err);
                    setError('Failed to join room');
                } finally {
                    setLoading(false);
                }
            };

            const startMission = async () => {
                if (room.admin !== user.uid || loading) return;
                
                setLoading(true);
                setError(null);
                
                try {
                    // Use default scenario for reliability
                    const scenario = DEFAULT_SCENARIOS[Math.floor(Math.random() * DEFAULT_SCENARIOS.length)];
                    const spy = room.players[Math.floor(Math.random() * room.players.length)];
                    
                    await db
                        .collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId)
                        .update({
                            status: 'playing',
                            scenario,
                            spyId: spy.uid,
                            timerStart: Date.now(),
                            players: room.players.map(p => ({ ...p, vote: null }))
                        });
                } catch (err) {
                    console.error('Start mission error:', err);
                    setError('Failed to start mission');
                } finally {
                    setLoading(false);
                }
            };

            const confirmVote = async () => {
                if (!tempVote || isLocked || timeLeft <= 0 || loading) return;
                
                setLoading(true);
                
                try {
                    const updated = room.players.map(p => 
                        p.uid === user.uid ? { ...p, vote: tempVote } : p
                    );
                    
                    await db
                        .collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId)
                        .update({ players: updated });
                    
                    setIsLocked(true);
                } catch (err) {
                    console.error('Vote error:', err);
                    setError('Failed to submit vote');
                } finally {
                    setLoading(false);
                }
            };

            const copyCode = useCallback(() => {
                if (room?.id) {
                    navigator.clipboard.writeText(room.id);
                    setCopyStatus(true);
                    setTimeout(() => setCopyStatus(false), 2000);
                }
            }, [room?.id]);

            const isSpy = room?.spyId === user?.uid;
            const isAdmin = room?.admin === user?.uid;
            const currentWord = isSpy ? null : (lang === 'ar' ? room?.scenario?.words_ar : room?.scenario?.words_en);

            // Loading screen
            if (connecting) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="text-center space-y-4 animate-fade-in">
                            <div className="w-16 h-16 mx-auto border-2 border-[var(--accent)] border-t-transparent rounded-full animate-spin" />
                            <p className="font-mono text-sm text-[var(--muted)]">ESTABLISHING SECURE CONNECTION...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div 
                    className="min-h-screen p-4 md:p-8 flex flex-col items-center" 
                    dir={lang === 'ar' ? 'rtl' : 'ltr'}
                    style={{ maxWidth: '100vw' }}
                >
                    <div className="w-full max-w-lg space-y-6">
                        
                        {/* Header */}
                        <header className="flex justify-between items-center animate-fade-in">
                            <div className="flex items-center gap-3">
                                <div className="relative">
                                    <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-[var(--accent)] to-orange-600 flex items-center justify-center">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" className="text-black">
                                            <circle cx="12" cy="12" r="10"/>
                                            <circle cx="12" cy="12" r="3"/>
                                            <line x1="12" y1="2" x2="12" y2="5"/>
                                            <line x1="12" y1="19" x2="12" y2="22"/>
                                            <line x1="2" y1="12" x2="5" y2="12"/>
                                            <line x1="19" y1="12" x2="22" y2="12"/>
                                        </svg>
                                    </div>
                                    <div className="absolute -top-1 -right-1 w-3 h-3 bg-[var(--success)] rounded-full border-2 border-[var(--bg)]" />
                                </div>
                                <div>
                                    <h1 className="text-2xl font-black tracking-tight">{t.appName}</h1>
                                    <p className="text-[10px] font-mono text-[var(--muted)] tracking-widest">{t.tagline}</p>
                                </div>
                            </div>
                            <button 
                                onClick={() => setLang(lang === 'en' ? 'ar' : 'en')}
                                className="btn btn-secondary px-4 py-2 rounded-lg text-xs font-mono"
                                aria-label="Switch language"
                            >
                                {t.langBtn}
                            </button>
                        </header>

                        {/* Error Alert */}
                        {error && (
                            <div className="card p-4 border-red-500/50 bg-red-500/10 animate-shake" role="alert">
                                <div className="flex items-center gap-2">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-red-400">
                                        <circle cx="12" cy="12" r="10"/>
                                        <line x1="12" y1="8" x2="12" y2="12"/>
                                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                                    </svg>
                                    <span className="text-sm text-red-400">{error}</span>
                                    <button onClick={() => setError(null)} className="ml-auto text-red-400 hover:text-red-300">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                            <line x1="18" y1="6" x2="6" y2="18"/>
                                            <line x1="6" y1="6" x2="18" y2="18"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Main Content */}
                        {!room ? (
                            <main className="card p-6 space-y-6 animate-fade-in delay-1">
                                <div className="space-y-2">
                                    <label className="text-xs font-mono text-[var(--muted)] uppercase tracking-wider">
                                        {t.nickname}
                                    </label>
                                    <input 
                                        className="input-field w-full p-4 text-base font-semibold"
                                        value={nickname}
                                        onChange={(e) => {
                                            const val = e.target.value;
                                            setNickname(val);
                                            localStorage.setItem('pro_spy_nick', val);
                                        }}
                                        placeholder={lang === 'ar' ? 'أدخل اسمك الرمزي' : 'Enter your callsign'}
                                        maxLength={20}
                                        aria-label={t.nickname}
                                    />
                                </div>
                                
                                <div className="space-y-3">
                                    <button 
                                        onClick={handleCreate} 
                                        disabled={loading || !nickname.trim()}
                                        className="btn btn-primary w-full py-4 rounded-xl text-sm font-bold uppercase tracking-wider"
                                    >
                                        {loading ? t.loading : t.create}
                                    </button>
                                    
                                    <div className="flex gap-2">
                                        <input 
                                            className="input-field flex-1 p-4 text-center font-mono uppercase tracking-widest text-sm"
                                            placeholder={t.codePlaceholder}
                                            value={inputCode}
                                            onChange={(e) => setInputCode(e.target.value.toUpperCase())}
                                            maxLength={6}
                                            aria-label={t.codePlaceholder}
                                        />
                                        <button 
                                            onClick={handleJoin} 
                                            disabled={loading || !nickname.trim() || !inputCode.trim()}
                                            className="btn btn-secondary px-6 rounded-xl text-xs font-bold"
                                        >
                                            {t.join}
                                        </button>
                                    </div>
                                </div>
                            </main>
                        ) : (
                            <div className="space-y-4 animate-fade-in">
                                {/* Room Info */}
                                <div className="card p-4">
                                    <div className="flex justify-between items-center">
                                        <div className="flex items-center gap-3">
                                            <div className="font-mono text-lg font-bold tracking-widest text-[var(--accent)]">
                                                {room.id}
                                            </div>
                                            <button 
                                                onClick={copyCode}
                                                className="btn btn-secondary px-3 py-1 rounded-md text-[10px] font-mono uppercase"
                                                aria-label={copyStatus ? t.copied : t.copy}
                                            >
                                                {copyStatus ? t.copied : t.copy}
                                            </button>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <div className="status-dot online" />
                                            <span className="text-xs font-mono text-[var(--muted)]">
                                                {t.players}: {room.players?.length || 0}
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                {room.status === 'waiting' ? (
                                    /* Waiting Room */
                                    <div className="card p-6 space-y-6 animate-fade-in delay-2">
                                        <div className="grid grid-cols-2 gap-2">
                                            {room.players?.map((player, idx) => (
                                                <div 
                                                    key={player.uid}
                                                    className={`player-badge card p-3 flex items-center justify-between ${
                                                        player.uid === user.uid ? 'is-you border-[var(--accent)]' : ''
                                                    }`}
                                                    style={{ animationDelay: `${idx * 0.05}s` }}
                                                >
                                                    <span className="text-sm font-semibold truncate">
                                                        {player.name}
                                                    </span>
                                                    {player.uid === user.uid && (
                                                        <span className="text-[9px] font-bold bg-[var(--accent)] text-black px-2 py-0.5 rounded uppercase">
                                                            {t.you}
                                                        </span>
                                                    )}
                                                    {player.uid === room.admin && (
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-[var(--warning)]">
                                                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                                        </svg>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                        
                                        {isAdmin ? (
                                            <button 
                                                onClick={startMission}
                                                disabled={loading || room.players?.length < 3}
                                                className="btn btn-primary w-full py-4 rounded-xl text-sm font-bold uppercase tracking-wider"
                                            >
                                                {loading ? t.loading : t.start}
                                            </button>
                                        ) : (
                                            <div className="text-center py-4">
                                                <div className="inline-flex items-center gap-2 text-xs text-[var(--muted)]">
                                                    <div className="status-dot waiting" />
                                                    <span className="font-mono">{t.waiting}</span>
                                                </div>
                                                <p className="text-[10px] text-[var(--muted)] mt-2 opacity-60">{t.adminOnly}</p>
                                            </div>
                                        )}
                                        
                                        {room.players?.length < 3 && (
                                            <p className="text-center text-xs text-[var(--warning)]">
                                                {lang === 'ar' ? 'يحتاج 3 لاعبين على الأقل' : 'Minimum 3 players required'}
                                            </p>
                                        )}
                                    </div>
                                ) : (
                                    /* Game Room */
                                    <div className="space-y-4">
                                        {/* Identity Card */}
                                        <div className={`identity-card card p-6 animate-fade-in delay-1 ${isSpy ? 'spy' : 'agent'}`}>
                                            <div className="text-center space-y-4">
                                                <div className={`inline-flex items-center gap-2 px-4 py-2 rounded-full text-xs font-bold uppercase tracking-wider ${
                                                    isSpy ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'
                                                }`}>
                                                    <div className={`w-2 h-2 rounded-full ${isSpy ? 'bg-red-400' : 'bg-green-400'}`} />
                                                    {isSpy ? t.spyTitle : t.citizenTitle}
                                                </div>
                                                
                                                {isSpy ? (
                                                    <div className="space-y-3">
                                                        <div className="text-4xl">?</div>
                                                        <p className="text-sm text-[var(--muted)] italic">{t.spyDesc}</p>
                                                        <p className="text-xs text-[var(--warning)]">{t.instructionSpy}</p>
                                                    </div>
                                                ) : (
                                                    <div className="space-y-4">
                                                        <div>
                                                            <p className="text-[10px] font-mono text-[var(--muted)] uppercase mb-1">{t.objective}</p>
                                                            <p className="text-2xl font-black">
                                                                {lang === 'ar' ? room.scenario?.loc_ar : room.scenario?.loc_en}
                                                            </p>
                                                        </div>
                                                        <div className="pt-2 border-t border-[var(--border)]">
                                                            <p className="text-[10px] font-mono text-[var(--muted)] uppercase mb-1">{t.wordHint}</p>
                                                            <p className="text-xl font-bold text-[var(--accent)]">
                                                                {lang === 'ar' ? room.scenario?.words_ar?.[0] : room.scenario?.words_en?.[0]}
                                                            </p>
                                                        </div>
                                                        <p className="text-xs text-[var(--muted)]">{t.instructionAgent}</p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* Timer & Voting */}
                                        <div className="card p-6 space-y-6 animate-fade-in delay-2">
                                            {/* Timer */}
                                            <div className="flex items-center justify-between">
                                                <h3 className="text-sm font-bold uppercase tracking-wider">{t.voting}</h3>
                                                <div className="flex items-center gap-3">
                                                    <div className="relative w-12 h-12">
                                                        <svg className="timer-ring w-full h-full" viewBox="0 0 36 36">
                                                            <circle
                                                                cx="18"
                                                                cy="18"
                                                                r="16"
                                                                fill="none"
                                                                stroke="var(--border)"
                                                                strokeWidth="3"
                                                            />
                                                            <circle
                                                                cx="18"
                                                                cy="18"
                                                                r="16"
                                                                fill="none"
                                                                stroke={timeLeft > 10 ? 'var(--accent)' : timeLeft > 5 ? 'var(--warning)' : 'var(--danger)'}
                                                                strokeWidth="3"
                                                                strokeDasharray={`${timerProgress * 100.53} 100.53`}
                                                                strokeLinecap="round"
                                                            />
                                                        </svg>
                                                        <div className="absolute inset-0 flex items-center justify-center">
                                                            <span className={`font-mono font-bold text-sm ${
                                                                timeLeft <= 5 ? 'text-red-400 animate-pulse' : ''
                                                            }`}>
                                                                {timeLeft}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <span className="text-xs font-mono text-[var(--muted)]">{t.sec}</span>
                                                </div>
                                            </div>

                                            {/* Word Selection */}
                                            <div className="grid grid-cols-2 gap-2">
                                                {(isSpy 
                                                    ? ['?', '?', '?', '?'] 
                                                    : (lang === 'ar' ? room.scenario?.words_ar : room.scenario?.words_en) || []
                                                )?.map((word, idx) => (
                                                    <button
                                                        key={idx}
                                                        onClick={() => !isLocked && !isSpy && timeLeft > 0 && setTempVote(word)}
                                                        disabled={timeLeft <= 0 || isSpy || isLocked}
                                                        className={`word-btn card p-3 text-sm font-semibold transition-all ${
                                                            tempVote === word ? 'selected' : ''
                                                        } ${isLocked || timeLeft <= 0 ? 'locked' : ''}`}
                                                        aria-pressed={tempVote === word}
                                                    >
                                                        {word}
                                                    </button>
                                                ))}
                                            </div>

                                            {/* Vote Status */}
                                            {!isSpy && (
                                                <div className="space-y-3">
                                                    <div className="card p-4 bg-black/30">
                                                        <p className="text-[10px] font-mono text-[var(--muted)] uppercase mb-1">
                                                            {timeLeft > 0 ? t.yourChoice : t.confirmedChoice}
                                                        </p>
                                                        <p className="text-lg font-bold text-[var(--accent)]">
                                                            {timeLeft > 0 
                                                                ? (tempVote || '...') 
                                                                : (majorityWord || t.noChoice)
                                                            }
                                                        </p>
                                                    </div>
                                                    
                                                    {timeLeft > 0 && !isLocked && (
                                                        <button
                                                            onClick={confirmVote}
                                                            disabled={!tempVote || loading}
                                                            className="btn btn-primary w-full py-3 rounded-xl text-sm font-bold uppercase"
                                                        >
                                                            {loading ? t.loading : t.lockIn}
                                                        </button>
                                                    )}
                                                    
                                                    {isLocked && timeLeft > 0 && (
                                                        <div className="text-center py-2">
                                                            <span className="inline-flex items-center gap-2 text-xs text-[var(--success)]">
                                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                                    <polyline points="20 6 9 17 4 12"/>
                                                                </svg>
                                                                {t.locked}
                                                            </span>
                                                        </div>
                                                    )}
                                                </div>
                                            )}

                                            {/* New Round Button */}
                                            {isAdmin && timeLeft <= 0 && (
                                                <button
                                                    onClick={startMission}
                                                    disabled={loading}
                                                    className="btn btn-secondary w-full py-4 rounded-xl text-sm font-bold uppercase tracking-wider"
                                                >
                                                    {t.newRound}
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Footer */}
                        <footer className="text-center py-8">
                            <p className="font-mono text-[10px] text-[var(--muted)] tracking-widest opacity-40">
                                V3.0.0 // TACTICAL ESPIONAGE SYSTEM
                            </p>
                        </footer>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
