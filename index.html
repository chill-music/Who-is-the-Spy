<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Who is the Spy? | Game</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Noto+Sans+Arabic:wght@300;400;600;800&display=swap');
        
        :root {
            --font-en: 'Inter', sans-serif;
            --font-ar: 'Noto Sans Arabic', sans-serif;
        }

        body { 
            background-color: #020617; 
            margin: 0; 
            overflow-x: hidden;
            color: #f8fafc;
        }

        .font-game { font-family: var(--font-en); }
        .font-game-ar { font-family: var(--font-ar); }

        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(51, 65, 85, 0.5);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Animations */
        @keyframes float-rotate {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-8px) rotate(10deg); }
        }
        
        @keyframes name-glow {
            0%, 100% { filter: drop-shadow(0 0 2px #38bdf8); opacity: 1; }
            50% { filter: drop-shadow(0 0 10px #38bdf8); opacity: 0.8; }
        }

        .animated-logo-icon {
            animation: float-rotate 3s ease-in-out infinite;
        }

        .animated-logo-text {
            animation: name-glow 2s ease-in-out infinite;
            background: linear-gradient(to right, #38bdf8, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .spy-gradient {
            background: radial-gradient(circle at top right, rgba(56, 189, 248, 0.15), transparent 40%),
                        radial-gradient(circle at bottom left, rgba(99, 102, 241, 0.15), transparent 40%);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>
<body class="font-game">
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyApAJaNfF0YHupunLRlK3jRYvttxczWShY",
            authDomain: "who-is-the-spy-919b9.firebaseapp.com",
            projectId: "who-is-the-spy-919b9",
            storageBucket: "who-is-the-spy-919b9.firebasestorage.app",
            messagingSenderId: "607075438373",
            appId: "1:607075438373:web:a03e9fb8b243cd993e14cc"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'who_is_spy_v1';
        const GEMINI_API_KEY = ""; // Managed by environment

        const TRANSLATIONS = {
            en: {
                appName: "PRO SPY",
                tagline: "Who is the traitor?",
                enterNick: "Enter your codename",
                createBtn: "Establish New HQ",
                joinBtn: "Join Operation",
                roomCode: "Access Code",
                waiting: "Waiting for agents...",
                players: "Active Agents",
                startBtn: "Initiate Mission",
                spyTitle: "YOU ARE THE SPY",
                spyDesc: "Your goal: Blend in and don't get caught. Try to guess the location.",
                citizenTitle: "YOU ARE AN AGENT",
                location: "Mission Objective:",
                copied: "Code Copied!",
                copy: "Copy Code",
                newRound: "New Operation",
                serverStatus: "SECURE CONNECTION",
                instructions: "MISSION BRIEFING",
                instr1: "1. Everyone knows the location except the Spy.",
                instr2: "2. Ask questions to find out who's acting suspicious.",
                instr3: "3. If you vote the Spy out, Agents win.",
                langSwitch: "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"
            },
            ar: {
                appName: "Ø¨Ø±Ùˆ Ø¬Ø§Ø³ÙˆØ³",
                tagline: "Ù…Ù† Ù‡Ùˆ Ø§Ù„Ø®Ø§Ø¦Ù†ØŸ",
                enterNick: "Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø­Ø±ÙƒÙŠ",
                createBtn: "Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù‚Ø± Ø¬Ø¯ÙŠØ¯",
                joinBtn: "Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¹Ù…Ù„ÙŠØ©",
                roomCode: "Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„",
                waiting: "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...",
                players: "Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù†Ø´Ø·ÙˆÙ†",
                startBtn: "Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©",
                spyTitle: "Ø£Ù†Øª Ø§Ù„Ø¬Ø§Ø³ÙˆØ³",
                spyDesc: "Ù‡Ø¯ÙÙƒ: Ø§Ù„Ø§Ù†Ø¯Ù…Ø§Ø¬ ÙˆØ¹Ø¯Ù… Ø§Ù„Ø§Ù†ÙƒØ´Ø§Ù. Ø­Ø§ÙˆÙ„ ØªØ®Ù…ÙŠÙ† Ø§Ù„Ù…ÙƒØ§Ù†.",
                citizenTitle: "Ø£Ù†Øª Ø¹Ù…ÙŠÙ„ Ù…ÙŠØ¯Ø§Ù†ÙŠ",
                location: "Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ù‡Ù…Ø©:",
                copied: "ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²!",
                copy: "Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²",
                newRound: "Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©",
                serverStatus: "Ø§ØªØµØ§Ù„ Ø¢Ù…Ù†",
                instructions: "ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø©",
                instr1: "Ù¡. Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙŠØ¹Ø±Ù Ø§Ù„Ù…ÙƒØ§Ù† Ù…Ø§Ø¹Ø¯Ø§ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³.",
                instr2: "Ù¢. Ø§Ø·Ø±Ø­ÙˆØ§ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„ÙƒØ´Ù Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡.",
                instr3: "Ù£. Ø¥Ø°Ø§ ØªÙ… ÙƒØ´Ù Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ØŒ ÙŠÙÙˆØ² Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡.",
                langSwitch: "English"
            }
        };

        async function getNewLocation() {
            try {
                const prompt = "Generate one unique location for a 'spy game'. Provide it in this JSON format: {\"ar\": \"Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ\", \"en\": \"Location name in English\"}. Make it creative.";
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const data = await response.json();
                return JSON.parse(data.candidates[0].content.parts[0].text);
            } catch (error) {
                const backups = [{ar: "Ù…Ø­Ø·Ø© ÙØ¶Ø§Ø¡", en: "Space Station"}, {ar: "Ù…ØªØ­Ù Ø§Ù„Ù„ÙˆÙØ±", en: "Louvre Museum"}];
                return backups[Math.floor(Math.random() * backups.length)];
            }
        }

        function App() {
            const [lang, setLang] = useState('en');
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [nickname, setNickname] = useState(localStorage.getItem('spy_nick') || '');
            const [gameData, setGameData] = useState(null);
            const [roomCodeInput, setRoomCodeInput] = useState('');
            const [actionLoading, setActionLoading] = useState(false);
            const [copyFeedback, setCopyFeedback] = useState(false);

            const t = TRANSLATIONS[lang];

            useEffect(() => {
                const unsub = auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        setUser(u);
                        setAuthLoading(false);
                    } else {
                        await auth.signInAnonymously();
                    }
                });
                return unsub;
            }, []);

            useEffect(() => {
                if (!gameData?.id) return;
                const unsub = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(gameData.id)
                    .onSnapshot((doc) => {
                        if (doc.exists) setGameData(doc.data());
                    });
                return unsub;
            }, [gameData?.id]);

            const createRoom = async () => {
                if (!nickname.trim() || !user) return;
                setActionLoading(true);
                const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                const newGame = {
                    id: code,
                    admin: user.uid,
                    players: [{ uid: user.uid, name: nickname }],
                    status: 'waiting',
                    spyId: null,
                    location: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(code).set(newGame);
                setGameData(newGame);
                setActionLoading(false);
            };

            const joinRoom = async () => {
                const code = roomCodeInput.trim().toUpperCase();
                if (!nickname.trim() || !code || !user) return;
                setActionLoading(true);
                const roomRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(code);
                const doc = await roomRef.get();
                if (doc.exists) {
                    const data = doc.data();
                    if (!data.players.find(p => p.uid === user.uid)) {
                        const updatedPlayers = [...data.players, { uid: user.uid, name: nickname }];
                        await roomRef.update({ players: updatedPlayers });
                    }
                    setGameData(doc.data());
                }
                setActionLoading(false);
            };

            const startGame = async () => {
                if (gameData.players.length < 3) return;
                setActionLoading(true);
                const location = await getNewLocation();
                const spyIndex = Math.floor(Math.random() * gameData.players.length);
                const spyId = gameData.players[spyIndex].uid;
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(gameData.id).update({
                    status: 'playing',
                    spyId: spyId,
                    location: location
                });
                setActionLoading(false);
            };

            const resetGame = async () => {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(gameData.id).update({
                    status: 'waiting',
                    spyId: null,
                    location: null
                });
            };

            const copyCode = () => {
                const el = document.createElement('textarea');
                el.value = gameData.id;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                setCopyFeedback(true);
                setTimeout(() => setCopyFeedback(false), 2000);
            };

            if (authLoading) return (
                <div className="min-h-screen bg-[#020617] flex items-center justify-center">
                    <div className="w-8 h-8 border-4 border-sky-500 border-t-transparent rounded-full animate-spin"></div>
                </div>
            );

            return (
                <div className={`min-h-screen spy-gradient p-4 md:p-8 flex flex-col items-center ${lang === 'ar' ? 'font-game-ar' : 'font-game'}`} dir={lang === 'ar' ? 'rtl' : 'ltr'}>
                    
                    <div className="w-full max-w-md">
                        {/* Header */}
                        <div className="flex justify-between items-center mb-10">
                            <div className="flex items-center gap-3">
                                <div className="w-12 h-12 bg-sky-500 rounded-xl flex items-center justify-center shadow-lg shadow-sky-500/20 animated-logo-icon">
                                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5">
                                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h1 className="text-2xl font-black tracking-tighter animated-logo-text">{t.appName}</h1>
                                    <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest leading-none">{t.tagline}</p>
                                </div>
                            </div>
                            <button 
                                onClick={() => setLang(lang === 'en' ? 'ar' : 'en')}
                                className="px-4 py-2 bg-slate-800/50 hover:bg-slate-800 rounded-full border border-slate-700 text-[10px] font-bold transition-all"
                            >
                                {t.langSwitch}
                            </button>
                        </div>

                        {!gameData ? (
                            <div className="space-y-6">
                                <div className="glass-panel rounded-3xl p-6 space-y-4">
                                    <div className="space-y-1">
                                        <label className="text-[10px] text-sky-400 font-black uppercase ml-1 tracking-widest">{t.enterNick}</label>
                                        <input 
                                            type="text" 
                                            value={nickname}
                                            onChange={(e) => {setNickname(e.target.value); localStorage.setItem('spy_nick', e.target.value);}}
                                            className="w-full bg-slate-900/50 border border-slate-700 p-4 rounded-2xl outline-none focus:border-sky-500 transition-all font-bold text-center"
                                        />
                                    </div>

                                    <div className="grid grid-cols-1 gap-3 pt-2">
                                        <button 
                                            onClick={createRoom}
                                            disabled={actionLoading || !nickname}
                                            className="w-full bg-sky-600 hover:bg-sky-500 py-4 rounded-2xl font-bold transition-all shadow-lg shadow-sky-600/20 active:scale-95 text-sm"
                                        >
                                            {actionLoading ? '...' : t.createBtn}
                                        </button>
                                        
                                        <div className="relative flex items-center py-2">
                                            <div className="flex-grow border-t border-slate-800"></div>
                                            <span className="flex-shrink mx-4 text-slate-600 text-[10px] font-bold uppercase">OR</span>
                                            <div className="flex-grow border-t border-slate-800"></div>
                                        </div>

                                        <div className="flex gap-2">
                                            <input 
                                                type="text" 
                                                placeholder={t.roomCode}
                                                value={roomCodeInput}
                                                onChange={(e) => setRoomCodeInput(e.target.value)}
                                                className="w-full bg-slate-900/50 border border-slate-700 px-4 rounded-2xl outline-none focus:border-sky-500 font-mono text-center tracking-widest"
                                            />
                                            <button 
                                                onClick={joinRoom}
                                                disabled={actionLoading || !nickname || !roomCodeInput}
                                                className="bg-slate-800 hover:bg-slate-700 px-6 py-4 rounded-2xl font-bold text-sm transition-all"
                                            >
                                                {t.joinBtn}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-6">
                                <div className="glass-panel rounded-2xl p-4 flex justify-between items-center">
                                    <div className="flex flex-col">
                                        <span className="text-[10px] text-slate-500 font-bold uppercase">{t.roomCode}</span>
                                        <span className="text-xl font-mono font-black text-sky-400 tracking-tighter">{gameData.id}</span>
                                    </div>
                                    <button 
                                        onClick={copyCode}
                                        className={`px-4 py-2 rounded-xl text-[10px] font-bold transition-all ${copyFeedback ? 'bg-green-500 text-white' : 'bg-slate-800 text-slate-300'}`}
                                    >
                                        {copyFeedback ? t.copied : t.copy}
                                    </button>
                                </div>

                                {gameData.status === 'waiting' ? (
                                    <div className="glass-panel rounded-3xl p-6 space-y-6">
                                        <div className="flex justify-between items-center">
                                            <h3 className="text-xs font-black uppercase tracking-widest text-sky-500">{t.players}</h3>
                                            <span className="bg-slate-800 px-3 py-1 rounded-full text-[10px] font-bold">{gameData.players.length}</span>
                                        </div>

                                        <div className="grid grid-cols-2 gap-3 max-h-60 overflow-y-auto custom-scrollbar">
                                            {gameData.players.map((p, i) => (
                                                <div key={i} className={`p-3 rounded-xl border flex items-center gap-2 ${p.uid === user.uid ? 'bg-sky-500/10 border-sky-500/50' : 'bg-slate-800/30 border-slate-700'}`}>
                                                    <div className={`w-2 h-2 rounded-full ${p.uid === user.uid ? 'bg-sky-400' : 'bg-slate-600'}`}></div>
                                                    <span className="text-xs font-bold truncate">{p.name} {p.uid === user.uid && "(You)"}</span>
                                                </div>
                                            ))}
                                        </div>

                                        {gameData.admin === user.uid ? (
                                            <button 
                                                onClick={startGame}
                                                disabled={gameData.players.length < 3 || actionLoading}
                                                className={`w-full py-4 rounded-2xl font-bold transition-all text-sm ${gameData.players.length < 3 ? 'bg-slate-800 text-slate-500 cursor-not-allowed' : 'bg-white text-black hover:bg-sky-400'}`}
                                            >
                                                {actionLoading ? '...' : t.startBtn}
                                            </button>
                                        ) : (
                                            <div className="text-center py-4 text-xs font-bold text-slate-500 italic animate-pulse">
                                                {t.waiting}
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="space-y-6">
                                        <div className={`glass-panel rounded-3xl p-8 border-t-4 text-center ${gameData.spyId === user.uid ? 'border-red-500' : 'border-sky-500'}`}>
                                            <div className="mb-6 inline-block p-4 rounded-full bg-slate-900 shadow-inner">
                                                {gameData.spyId === user.uid ? (
                                                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="2">
                                                        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                                        <line x1="1" y1="1" x2="23" y2="23"/>
                                                    </svg>
                                                ) : (
                                                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#0ea5e9" strokeWidth="2">
                                                        <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                                                    </svg>
                                                )}
                                            </div>

                                            <h2 className={`text-2xl font-black mb-2 uppercase tracking-tight ${gameData.spyId === user.uid ? 'text-red-500' : 'text-sky-500'}`}>
                                                {gameData.spyId === user.uid ? t.spyTitle : t.citizenTitle}
                                            </h2>
                                            
                                            <p className="text-slate-400 text-sm mb-8 leading-relaxed px-4">
                                                {gameData.spyId === user.uid ? t.spyDesc : t.location}
                                            </p>

                                            {gameData.spyId !== user.uid && (
                                                <div className="bg-sky-500/10 border border-sky-500/20 p-6 rounded-2xl">
                                                    <span className="text-3xl font-black text-white tracking-tight">
                                                        {lang === 'ar' ? gameData.location?.ar : gameData.location?.en}
                                                    </span>
                                                </div>
                                            )}
                                        </div>

                                        <div className="glass-panel rounded-3xl p-6 text-[11px] text-slate-500 leading-loose space-y-1">
                                            <p className="font-black text-sky-500 mb-2 uppercase tracking-widest">{t.instructions}</p>
                                            <p>{t.instr1}</p>
                                            <p>{t.instr2}</p>
                                            <p>{t.instr3}</p>
                                        </div>

                                        {gameData.admin === user.uid && (
                                            <button 
                                                onClick={resetGame}
                                                className="w-full bg-slate-800 border border-slate-700 py-3 rounded-xl font-bold hover:bg-slate-700 active:scale-95 transition-all text-sm"
                                            >
                                                ðŸ”„ {t.newRound}
                                            </button>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                        
                        <div className="mt-12 text-center text-[10px] text-slate-700 font-mono tracking-widest uppercase">
                            {t.serverStatus} | ID: {user.uid.substr(0,8)}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
