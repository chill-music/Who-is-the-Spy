<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Who is the Spy? - ŸÖŸÜ ŸáŸà ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap');
        body { font-family: 'Noto Sans Arabic', sans-serif; background-color: #020617; margin: 0; }
        #root { min-height: 100vh; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">
    <div id="root">
        <div class="flex items-center justify-center h-screen">
            <div class="text-center">
                <div class="text-xl font-bold animate-pulse text-blue-500 mb-2">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±...</div>
                <div class="text-sm text-slate-500">ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑŸÉ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyApAJaNfF0YHupunLRlK3jRYvttxczWShY",
            authDomain: "who-is-the-spy-919b9.firebaseapp.com",
            projectId: "who-is-the-spy-919b9",
            storageBucket: "who-is-the-spy-919b9.firebasestorage.app",
            messagingSenderId: "607075438373",
            appId: "1:607075438373:web:a03e9fb8b243cd993e14cc",
            measurementId: "G-6FVJR2VXN3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'spy-game-919b9';

        const { useState, useEffect } = React;

        const translations = {
            en: {
                title: "Who is the Spy?", subtitle: "A game of wits and deception", joinRoom: "Join an existing room",
                roomCodePlaceholder: "Room Code", or: "OR", createRoom: "Create New Room", roomCode: "Room Code",
                players: "Players", playerList: "Player List", waiting: "Waiting for players...",
                waitingAdmin: "Waiting for admin to start...", startBtn: "Start Game", spyTitle: "You are the Spy!",
                spyDesc: "Guess the word without being caught.", spyMission: "Stay mysterious",
                citizenTitle: "You are a Citizen", locationIs: "Location:", secretWord: "Secret word:",
                instructions: "Instructions:", instr1: "Talk about it without naming it.",
                newRound: "New Round", errorJoin: "Room not found",
                errorStart: "Need 3+ players", loading: "Connecting...",
            },
            ar: {
                title: "ŸÖŸÜ ŸáŸà ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ÿü", subtitle: "ŸÑÿπÿ®ÿ© ÿßŸÑÿ∞ŸÉÿßÿ° ŸàÿßŸÑÿ™ŸÖŸàŸäŸá ÿßŸÑÿ¨ŸÖÿßÿπŸäÿ©", joinRoom: "ÿßŸÜÿ∂ŸÖ ŸÑÿ∫ÿ±ŸÅÿ© ŸÖŸàÿ¨ŸàÿØÿ©",
                roomCodePlaceholder: "ÿ±ŸÖÿ≤ ÿßŸÑÿ∫ÿ±ŸÅÿ©", or: "ÿ£Ÿà", createRoom: "ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ© ÿ¨ÿØŸäÿØÿ©", roomCode: "ÿ±ŸÖÿ≤ ÿßŸÑÿ∫ÿ±ŸÅÿ©",
                players: "ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ", playerList: "ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≠ÿ∂Ÿàÿ±", waiting: "ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ...",
                waitingAdmin: "ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÖÿ≥ÿ§ŸàŸÑ ŸÑÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ©...", startBtn: "ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®ÿ© ÿßŸÑÿ¢ŸÜ", spyTitle: "ÿ£ŸÜÿ™ ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥!",
                spyDesc: "ÿ≠ÿßŸàŸÑ ŸÖÿπÿ±ŸÅÿ© ÿßŸÑŸÉŸÑŸÖÿ© ÿØŸàŸÜ ÿ£ŸÜ ŸäŸÜÿ™ÿ®Ÿá ÿ£ÿ≠ÿØ.", spyMission: "ÿßŸÑŸÖŸáŸÖÿ©: ÿßÿ®ŸÇŸé ÿ∫ÿßŸÖÿ∂ÿßŸã",
                citizenTitle: "ÿ£ŸÜÿ™ ŸÖŸàÿßÿ∑ŸÜ", locationIs: "ÿßŸÑŸÖŸàŸÇÿπ ŸáŸà:", secretWord: "ÿßŸÑŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±Ÿäÿ©:",
                instructions: "ÿßŸÑÿ™ÿπŸÑŸäŸÖÿßÿ™:", instr1: "ÿ™ÿ≠ÿØÿ´Ÿàÿß ÿπŸÜ ÿßŸÑŸÖŸàŸÇÿπ ÿØŸàŸÜ ÿ∞ŸÉÿ± ÿßÿ≥ŸÖŸá ŸÖÿ®ÿßÿ¥ÿ±ÿ©.",
                newRound: "ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ©", errorJoin: "ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©",
                errorStart: "ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ 3 ŸÑÿßÿπÿ®ŸäŸÜ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ ŸÑŸÑÿ®ÿØÿ°", loading: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ™ÿµÿßŸÑ...",
            }
        };

        const LOCATIONS = [
            { en: "Hospital", ar: "ÿßŸÑŸÖÿ≥ÿ™ÿ¥ŸÅŸâ", words: { en: ["Doctor", "Nurse"], ar: ["ÿ∑ÿ®Ÿäÿ®", "ŸÖŸÖÿ±ÿ∂ÿ©"] } },
            { en: "School", ar: "ÿßŸÑŸÖÿØÿ±ÿ≥ÿ©", words: { en: ["Teacher", "Student"], ar: ["ŸÖÿπŸÑŸÖ", "ÿ∑ÿßŸÑÿ®"] } },
            { en: "Restaurant", ar: "ÿßŸÑŸÖÿ∑ÿπŸÖ", words: { en: ["Waiter", "Chef"], ar: ["ŸÜÿßÿØŸÑ", "ÿ∑ÿ®ÿßÿÆ"] } },
            { en: "Airport", ar: "ÿßŸÑŸÖÿ∑ÿßÿ±", words: { en: ["Pilot", "Passport"], ar: ["ÿ∑Ÿäÿßÿ±", "ÿ¨Ÿàÿßÿ≤ ÿ≥ŸÅÿ±"] } },
            { en: "Forest", ar: "ÿßŸÑÿ∫ÿßÿ®ÿ©", words: { en: ["Trees", "Camping"], ar: ["ÿ¥ÿ¨ÿ±", "ÿ™ÿÆŸäŸäŸÖ"] } },
            { en: "Cinema", ar: "ÿßŸÑÿ≥ŸäŸÜŸÖÿß", words: { en: ["Popcorn", "Movie"], ar: ["ŸÅÿ¥ÿßÿ±", "ŸÅŸäŸÑŸÖ"] } },
            { en: "Gym", ar: "ÿßŸÑŸÜÿßÿØŸä ÿßŸÑÿ±Ÿäÿßÿ∂Ÿä", words: { en: ["Coach", "Weight"], ar: ["ŸÖÿØÿ±ÿ®", "Ÿàÿ≤ŸÜ"] } },
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [lang, setLang] = useState('ar');
            const [roomId, setRoomId] = useState('');
            const [gameData, setGameData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const t = translations[lang];

            useEffect(() => {
                auth.signInAnonymously().catch(err => console.error("Auth Error:", err));
                const unsubscribe = auth.onAuthStateChanged(u => {
                    setUser(u);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !roomId || roomId.length < 3) return;
                const roomRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId.toUpperCase());
                const unsubscribe = roomRef.onSnapshot((docSnap) => {
                    if (docSnap.exists) {
                        setGameData(docSnap.data());
                    } else {
                        setGameData(null);
                    }
                }, (err) => console.error("Firestore Error:", err));
                return () => unsubscribe();
            }, [user, roomId]);

            const createRoom = async () => {
                if (!user) return;
                setLoading(true);
                const newId = Math.random().toString(36).substring(2, 7).toUpperCase();
                const roomRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(newId);
                try {
                    await roomRef.set({
                        id: newId, admin: user.uid, players: [{ uid: user.uid, name: `Player ${user.uid.substring(0, 4)}` }],
                        status: 'waiting', spyId: null, location: null, word: null, createdAt: Date.now()
                    });
                    setRoomId(newId);
                } catch (e) {
                    setError("Error creating room");
                    console.error(e);
                }
                setLoading(false);
            };

            const joinRoom = async (id) => {
                if (!user || !id) return;
                setLoading(true);
                const normalizedId = id.toUpperCase();
                const roomRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(normalizedId);
                try {
                    const snap = await roomRef.get();
                    if (snap.exists) {
                        const data = snap.data();
                        if (!data.players.find(p => p.uid === user.uid)) {
                            await roomRef.update({ 
                                players: firebase.firestore.FieldValue.arrayUnion({ uid: user.uid, name: `Player ${user.uid.substring(0, 4)}` }) 
                            });
                        }
                        setRoomId(normalizedId);
                    } else setError(t.errorJoin);
                } catch (e) {
                    setError("Join failed");
                    console.error(e);
                }
                setLoading(false);
            };

            const startGame = async () => {
                if (!gameData || gameData.players.length < 3) { setError(t.errorStart); return; }
                const loc = LOCATIONS[Math.floor(Math.random() * LOCATIONS.length)];
                const wordIdx = Math.floor(Math.random() * loc.words.en.length);
                const roomRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId);
                await roomRef.update({
                    status: 'playing', location: { en: loc.en, ar: loc.ar },
                    word: { en: loc.words.en[wordIdx], ar: loc.words.ar[wordIdx] },
                    spyId: gameData.players[Math.floor(Math.random() * gameData.players.length)].uid
                });
            };

            const resetGame = async () => {
                const roomRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId);
                await roomRef.update({ status: 'waiting', spyId: null, location: null, word: null });
            };

            if (!user) return (
                <div className="flex items-center justify-center h-screen bg-slate-950 text-white font-bold">
                    <div className="text-center">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                        {t.loading}
                    </div>
                </div>
            );

            return (
                <div className={`min-h-screen bg-slate-950 text-slate-100 p-4 transition-all ${lang === 'ar' ? 'text-right' : 'text-left'}`} dir={lang === 'ar' ? 'rtl' : 'ltr'}>
                    <div className="max-w-md mx-auto">
                        <div className="flex justify-between items-center mb-6 pt-4">
                            <div className="flex items-center gap-2">
                                <div className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                                <span className="text-[10px] text-slate-500 uppercase">Online</span>
                            </div>
                            <button onClick={() => setLang(l => l === 'en' ? 'ar' : 'en')} className="bg-slate-800 px-4 py-2 rounded-full border border-slate-700 text-sm">
                                {lang === 'en' ? 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©' : 'English'}
                            </button>
                        </div>

                        <header className="text-center mb-8">
                            <h1 className="text-4xl font-bold text-red-500 mb-2">üïµÔ∏è {t.title}</h1>
                            <p className="text-slate-400">{t.subtitle}</p>
                        </header>

                        {error && <div className="bg-red-900/50 border border-red-500 p-3 rounded-lg mb-4 text-sm flex justify-between items-center">
                            <span>{error}</span>
                            <button onClick={() => setError(null)} className="bg-red-500 px-2 rounded ml-2">X</button>
                        </div>}

                        {!gameData ? (
                            <div className="space-y-6 bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-2xl">
                                <div className="space-y-2">
                                    <label className="text-sm text-slate-400">{t.joinRoom}</label>
                                    <div className="flex gap-2">
                                        <input type="text" placeholder={t.roomCodePlaceholder} className="bg-slate-800 border border-slate-700 p-3 rounded-xl flex-1 uppercase outline-none focus:border-blue-500" value={roomId} onChange={(e) => setRoomId(e.target.value)} />
                                        <button onClick={() => joinRoom(roomId)} className="bg-blue-600 hover:bg-blue-700 px-4 rounded-xl transition-colors">Join</button>
                                    </div>
                                </div>
                                <div className="relative py-2 text-center text-slate-500 text-sm">--- {t.or} ---</div>
                                <button onClick={createRoom} className="w-full bg-red-600 hover:bg-red-700 font-bold py-4 rounded-xl shadow-lg transition-transform active:scale-95">{t.createRoom}</button>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 flex justify-between shadow-lg">
                                    <div><p className="text-xs text-slate-500">{t.roomCode}</p><p className="text-2xl font-bold text-blue-400">{gameData.id}</p></div>
                                    <div className="text-center"><p className="text-xs text-slate-500">{t.players}</p><p className="text-xl font-bold">{gameData.players.length}</p></div>
                                </div>

                                <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-800">
                                    <h3 className="text-sm text-slate-400 mb-3">{t.playerList}</h3>
                                    <div className="grid grid-cols-2 gap-2">
                                        {gameData.players.map((p) => (
                                            <div key={p.uid} className={`p-2 rounded-lg text-sm truncate border ${p.uid === user.uid ? 'border-blue-500 bg-blue-500/10' : 'border-slate-800 bg-slate-800/50'}`}>
                                                {p.name} {p.uid === gameData.admin && 'üëë'}
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {gameData.status === 'waiting' ? (
                                    <div className="text-center py-8">
                                        {gameData.admin === user.uid ? 
                                            <button onClick={startGame} className="w-full bg-green-600 hover:bg-green-700 py-4 rounded-xl font-bold shadow-lg transition-transform active:scale-95">{t.startBtn}</button> : 
                                            <div className="flex flex-col items-center">
                                                <div className="animate-bounce mb-2 text-blue-500 text-2xl">‚è≥</div>
                                                <p className="text-slate-400 italic">{t.waitingAdmin}</p>
                                            </div>
                                        }
                                    </div>
                                ) : (
                                    <div className="space-y-4 animate-in fade-in zoom-in duration-300">
                                        <div className={`p-6 rounded-2xl border-2 text-center shadow-2xl ${gameData.spyId === user.uid ? 'border-red-500 bg-red-950/20' : 'border-blue-500 bg-blue-950/20'}`}>
                                            {gameData.spyId === user.uid ? (
                                                <>
                                                    <h2 className="text-3xl font-black text-red-500 mb-2 uppercase">{t.spyTitle}</h2>
                                                    <p className="text-slate-300">{t.spyDesc}</p>
                                                    <div className="mt-6 px-8 py-3 bg-red-600 rounded-full inline-block font-bold shadow-lg animate-pulse">{t.spyMission}</div>
                                                </>
                                            ) : (
                                                <>
                                                    <h2 className="text-3xl font-black text-blue-500 mb-2 uppercase">{t.citizenTitle}</h2>
                                                    <p className="text-slate-400">{t.locationIs}</p>
                                                    <div className="text-4xl font-bold text-white my-6 bg-slate-800/50 py-4 rounded-xl">{gameData.location[lang]}</div>
                                                    <p className="text-slate-300">{t.secretWord} <span className="text-yellow-400 font-bold border-b border-yellow-400">{gameData.word[lang]}</span></p>
                                                </>
                                            )}
                                        </div>
                                        {gameData.admin === user.uid && (
                                            <button onClick={resetGame} className="w-full bg-slate-800 hover:bg-slate-700 py-3 rounded-xl text-slate-300 border border-slate-700 mt-4 transition-colors">
                                                üîÑ {t.newRound}
                                            </button>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                        <footer className="mt-12 text-center text-slate-800 text-[10px] tracking-widest uppercase">
                            Connection ID: {user.uid.substring(0, 10)}...
                        </footer>
                    </div>
                </div>
            );
        }

        // Render with delay safety
        setTimeout(() => {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        }, 100);
    </script>
</body>
</html>
