<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PRO SPY | Covert Arena</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üïµÔ∏è</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #05050a;
            --bg-card: rgba(20, 20, 30, 0.85);
            --primary: #00f2ff;
            --secondary: #7000ff;
            --accent: #ff0055;
            --gold: #ffd700;
            --text-main: #ffffff;
            --text-muted: #8b8b9e;
            --border: rgba(255, 255, 255, 0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Outfit', sans-serif; min-height: 100vh; overflow-x: hidden; position: relative; }
        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .glass-panel { background: var(--bg-card); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
        .font-tech { font-family: 'Rajdhani', sans-serif; }
        @keyframes pulse-glow { 0% { text-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary); } 50% { text-shadow: 0 0 20px var(--primary), 0 0 40px var(--primary), 0 0 60px var(--secondary); } 100% { text-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary); } }
        @keyframes rotate-border { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pop-in { 0% { transform: scale(0); opacity: 0; } 70% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; } }
        .animate-fade-in { animation: fade-in-up 0.6s ease-out forwards; }
        .animate-pop { animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .logo-container { position: relative; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; }
        .logo-border { position: absolute; inset: 0; border-radius: 12px; border: 2px solid transparent; border-top-color: var(--primary); border-right-color: var(--secondary); animation: rotate-border 3s linear infinite; }
        .game-title { font-family: 'Rajdhani', sans-serif; font-weight: 700; letter-spacing: 2px; background: linear-gradient(to right, #fff, var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: pulse-glow 3s infinite alternate; }
        .btn-neon { position: relative; background: linear-gradient(90deg, var(--secondary), var(--primary)); color: white; font-weight: 700; transition: all 0.3s; overflow: hidden; }
        .btn-neon:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 0 20px var(--primary); }
        .btn-neon:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); transition: 0.3s; }
        .btn-ghost:hover { border-color: var(--primary); color: var(--primary); }
        .btn-vote { background: linear-gradient(90deg, #ff0055, #ff3366); color: white; }
        .btn-success { background: linear-gradient(90deg, #10b981, #22c55e); color: white; }
        .btn-danger { background: linear-gradient(90deg, #ef4444, #dc2626); color: white; }
        .btn-gold { background: linear-gradient(90deg, #b8860b, var(--gold)); color: #000; }
        .btn-google { background: white; color: #333; font-weight: bold; }
        .input-dark { background: rgba(0, 0, 0, 0.6); border: 1px solid var(--border); color: white; transition: 0.2s; }
        .input-dark:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 15px rgba(0, 242, 255, 0.2); }
        .input-locked { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.05); color: rgba(255, 255, 255, 0.6); cursor: not-allowed; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--secondary); border-radius: 2px; }
        .player-card { transition: all 0.3s; position: relative; border: 1px solid transparent; cursor: pointer; }
        .player-card:hover { border-color: rgba(255,255,255,0.2); }
        .player-card.active { background: rgba(0, 242, 255, 0.1); border-color: var(--primary); }
        .player-card.eliminated, .player-card.ghost { opacity: 0.6; filter: grayscale(80%); }
        .player-card.ghost { border-color: var(--text-muted); }
        .timer-bar-container { width: 60px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .timer-bar-fill { height: 100%; background: var(--primary); transition: width 1s linear; }
        .identity-square { width: 100%; max-width: 280px; aspect-ratio: 1 / 1; margin: 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; border-radius: 20px; position: relative; overflow: hidden; transition: all 0.5s ease; }
        .identity-spy { border: 2px solid var(--accent); background: radial-gradient(circle at center, rgba(255, 0, 85, 0.15), transparent 70%); box-shadow: 0 0 40px rgba(255, 0, 85, 0.3); }
        .identity-agent { border: 2px solid #10b981; background: radial-gradient(circle at center, rgba(16, 185, 129, 0.1), transparent 70%); box-shadow: 0 0 40px rgba(16, 185, 129, 0.2); }
        .identity-informant { border: 2px solid #3b82f6; background: radial-gradient(circle at center, rgba(59, 130, 246, 0.15), transparent 70%); box-shadow: 0 0 40px rgba(59, 130, 246, 0.3); }
        .identity-mrwhite { border: 2px solid var(--gold); background: radial-gradient(circle at center, rgba(255, 215, 0, 0.15), transparent 70%); box-shadow: 0 0 40px rgba(255, 215, 0, 0.3); }
        .emoji-btn { font-size: 20px; cursor: pointer; transition: transform 0.2s; }
        .emoji-btn:hover { transform: scale(1.2); }
        .word-vote-card { background: rgba(255, 255, 255, 0.05); border: 2px solid transparent; transition: all 0.3s; position: relative; }
        .word-vote-card.selected { border-color: var(--primary); background: rgba(0, 242, 255, 0.1); transform: scale(1.02); }
        .voter-name { position: absolute; bottom: -8px; right: 10px; font-size: 10px; background: var(--secondary); padding: 2px 6px; border-radius: 8px; color: white; }
        .vote-request-banner { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 50; width: 90%; max-width: 500px; }
        .xp-bar-bg { background: rgba(255,255,255,0.1); }
        .xp-bar-fill { background: linear-gradient(90deg, var(--secondary), var(--primary)); transition: width 0.5s ease; }
        .achievement-card { transition: all 0.3s; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; position: relative; }
        .achievement-card.locked { filter: grayscale(100%); opacity: 0.4; }
        .achievement-card.unlocked { border-color: var(--primary); box-shadow: 0 0 15px rgba(0, 242, 255, 0.2); }
        .dropdown-menu { position: absolute; top: 100%; right: 0; margin-top: 8px; min-width: 180px; z-index: 9999; }
        .error-msg { color: #ff4d4d; font-size: 12px; margin-top: 5px; text-align: center; }
        .alert-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .nav-tab { padding: 8px 16px; border-bottom: 2px solid transparent; transition: 0.3s; color: #888; cursor: pointer; position: relative; }
        .nav-tab:hover { color: #fff; }
        .nav-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .status-online { width: 10px; height: 10px; background: #10b981; border-radius: 50%; display: inline-block; box-shadow: 0 0 5px #10b981; }
        .status-offline { width: 10px; height: 10px; background: #555; border-radius: 50%; display: inline-block; }
        .leaderboard-row { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .leaderboard-row:hover { background: rgba(255,255,255,0.03); }
        .invite-bubble { background: linear-gradient(135deg, rgba(112, 0, 255, 0.2), rgba(0, 242, 255, 0.2)); border: 1px solid var(--primary); border-radius: 12px; padding: 10px; text-align: center; margin: 5px 0; }
        .ach-tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); border: 1px solid var(--primary); padding: 8px; border-radius: 8px; width: 150px; font-size: 10px; text-align: center; z-index: 10; pointer-events: none; opacity: 0; transition: opacity 0.2s; }
        .achievement-card:hover .ach-tooltip, .achievement-card:active .ach-tooltip { opacity: 1; }
        .notification-badge { position: absolute; top: -5px; right: -5px; width: 18px; height: 18px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; border: 2px solid var(--bg-dark); }
        .chat-msg-row { display: flex; gap: 10px; margin-bottom: 16px; }
        .chat-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.1); flex-shrink: 0; cursor: pointer; transition: 0.2s; }
        .chat-avatar:hover { border-color: var(--primary); transform: scale(1.1); }
        .chat-content { flex: 1; display: flex; flex-direction: column; max-width: 80%; }
        .chat-header { display: flex; align-items: baseline; gap: 8px; margin-bottom: 4px; }
        .chat-username { font-size: 13px; font-weight: 700; color: var(--primary); }
        .chat-timestamp { font-size: 10px; color: var(--text-muted); }
        .chat-bubble { padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.4; word-wrap: break-word; max-width: 100%; display: inline-block; }
        .chat-bubble-me { background: linear-gradient(135deg, rgba(112, 0, 255, 0.25), rgba(0, 242, 255, 0.25)); border: 1px solid var(--primary); border-bottom-right-radius: 2px; align-self: flex-end; }
        .chat-bubble-other { background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255,255,255,0.05); border-bottom-left-radius: 2px; }
        .emoji-picker-container { position: absolute; bottom: 70px; right: 10px; width: 280px; background: rgba(10,10,20,0.98); border: 1px solid var(--border); border-radius: 12px; padding: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 20; }
        .emoji-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; max-height: 200px; overflow-y: auto; margin-top: 8px; padding-right: 4px; }
        .emoji-item { font-size: 22px; padding: 5px; cursor: pointer; text-align: center; border-radius: 6px; transition: 0.2s; }
        .emoji-item:hover { background: rgba(255,255,255,0.1); transform: scale(1.1); }
        .profile-header { display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 20px; }
        .profile-avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--primary); margin-bottom: 10px; }
        .profile-name { font-size: 22px; font-weight: 800; }
        .profile-id-box { background: rgba(255,255,255,0.05); padding: 4px 10px; border-radius: 20px; display: inline-flex; align-items: center; gap: 5px; margin-top: 5px; cursor: pointer; transition: 0.2s; }
        .profile-id-box:hover { background: rgba(0, 242, 255, 0.1); }
        .profile-id-text { font-family: monospace; font-size: 12px; color: var(--text-muted); }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .info-box { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); }
        .info-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; display: block; }
        .info-value { font-size: 14px; font-weight: 600; }
        .guest-banner { background: rgba(255, 255, 255, 0.05); border: 1px dashed var(--text-muted); padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 20px; }
        .guest-banner h3 { color: var(--primary); margin-bottom: 5px; }
        .friend-unread-badge { position: absolute; top: 8px; right: 8px; min-width: 20px; height: 20px; background: var(--accent); border-radius: 10px; font-size: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; color: white; padding: 0 4px; box-shadow: 0 0 10px rgba(255,0,85,0.5); }
        .role-icon { position: absolute; top: 10px; left: 10px; font-size: 24px; filter: drop-shadow(0 0 5px rgba(255,255,255,0.5)); }
    </style>
</head>
<body>
    <canvas id="bg-canvas"></canvas>
    <div id="root"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyApAJaNfF0YHupunLRlK3jRYvttxczWShY",
            authDomain: "who-is-the-spy-919b9.firebaseapp.com",
            projectId: "who-is-the-spy-919b9",
            storageBucket: "who-is-the-spy-919b9.firebasestorage.app",
            messagingSenderId: "607075438373",
            appId: "1:607075438373:web:a03e9fb8b243cd993e14cc"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'pro_spy_v23_advanced_modes';
        const usersCollection = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users');
        const reportsCollection = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('reports');
        const chatsCollection = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('private_chats');
        const roomsCollection = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms');

        // --- Content ---
        const ACHIEVEMENTS = [
            { id: 'first_win', name_en: "First Blood", name_ar: "ÿ£ŸàŸÑ ÿØŸÖ", icon: "ü©∏", desc_en: "Win your first game.", desc_ar: "ÿßŸÅŸàÿ≤ ÿßŸàŸÑ ŸÑÿπÿ®ÿ© ŸÑŸÉ." },
            { id: 'wins_5', name_en: "Rookie Spy", name_ar: "ÿ¨ÿßÿ≥Ÿàÿ≥ ŸÖÿ®ÿ™ÿØÿ¶", icon: "üïµÔ∏è", desc_en: "Win 5 games.", desc_ar: "ÿßŸÅŸàÿ≤ 5 ŸÖÿ±ÿßÿ™." },
            { id: 'wins_10', name_en: "Field Agent", name_ar: "ÿπŸÖŸäŸÑ ŸÖŸäÿØÿßŸÜŸä", icon: "üî´", desc_en: "Win 10 games.", desc_ar: "ÿßŸÅŸàÿ≤ 10 ŸÖÿ±ÿßÿ™." },
            { id: 'wins_20', name_en: "Master of Disguise", name_ar: "ÿ≥ŸäÿØ ÿßŸÑÿ™ŸÜŸÉÿ±", icon: "üé≠", desc_en: "Win 20 games.", desc_ar: "ÿßŸÅŸàÿ≤ 20 ŸÖÿ±ÿ©." },
            { id: 'wins_50', name_en: "Shadow Legend", name_ar: "ÿ£ÿ≥ÿ∑Ÿàÿ±ÿ© ÿßŸÑÿ∏ŸÑ", icon: "üëÅÔ∏è", desc_en: "Win 50 games.", desc_ar: "ÿßŸÅŸàÿ≤ 50 ŸÖÿ±ÿ©." },
            { id: 'wins_100', name_en: "Immortal", name_ar: "ÿÆÿßŸÑÿØ", icon: "üëë", special: true, desc_en: "Win 100 games.", desc_ar: "ÿßŸÅŸàÿ≤ 100 ŸÖÿ±ÿ©." }
        ];
        
        const SCENARIOS = [
            { loc_ar: "ŸÖÿ≠ÿ∑ÿ© ŸÅÿ∂ÿßÿ°", words_ar: ["ŸÅÿ∂ÿßÿ°", "ÿµÿßÿ±ŸàÿÆ", "zero-g", "ŸÇŸÖÿ±"], loc_en: "Space Station", words_en: ["Space", "Rocket", "Zero-g", "Moon"] },
            { loc_ar: "ÿ∫Ÿàÿßÿµÿ© ŸÜŸàŸàŸäÿ©", words_ar: ["ÿπŸÖŸÇ", "ŸÖÿßÿ°", "ÿ∂ÿ∫ÿ∑", "ÿ≥ŸàŸÜÿßÿ±"], loc_en: "Nuclear Submarine", words_en: ["Depth", "Water", "Pressure", "Sonar"] },
            { loc_ar: "ŸÇÿµÿ± ŸÖŸÑŸÉŸä", words_ar: ["ÿ™ÿßÿ¨", "ÿ≠ÿ±ÿßÿ≥", "ÿπÿ±Ÿàÿ¥", "ÿÆÿØŸÖ"], loc_en: "Royal Palace", words_en: ["Crown", "Guards", "Throne", "Servants"] },
            { loc_ar: "ÿ®ŸÜŸÉ ŸÖÿ±ŸÉÿ≤Ÿä", words_ar: ["ÿÆÿ≤ŸÜÿ©", "ŸÖÿßŸÑ", "ÿ±ÿµÿßÿµ", "ŸÖŸÅÿ™ÿßÿ≠"], loc_en: "Central Bank", words_en: ["Vault", "Money", "Lead", "Key"] },
            { loc_ar: "ŸÖÿ≥ÿ™ÿ¥ŸÅŸâ ŸÖŸáÿ¨Ÿàÿ±", words_ar: ["ÿ£ÿ¥ÿ®ÿßÿ≠", "ÿ£ÿ∑ÿ®ÿßÿ°", "ÿ∏ŸÑÿßŸÖ", "ÿ≠ŸÇŸÜ"], loc_en: "Abandoned Hospital", words_en: ["Ghosts", "Doctors", "Dark", "Syringe"] },
            { loc_ar: "ŸÇÿ∑ÿßÿ± ŸÑŸäŸÑŸä", words_ar: ["ÿØÿ±ÿ¨ÿßÿ™", "ÿ™ÿ∞ÿßŸÉÿ±", "ŸÜŸàŸÖ", "ŸÖŸÖÿ±"], loc_en: "Night Train", words_en: ["Bunks", "Tickets", "Sleep", "Aisle"] },
            { loc_ar: "ÿ¨ÿ≤Ÿäÿ±ÿ© ŸÉŸÜÿ≤", words_ar: ["ÿÆÿ±Ÿäÿ∑ÿ©", "ÿ≠ŸÅÿ±", "ÿ∞Ÿáÿ®", "ŸÇÿ±ÿßÿµŸÜÿ©"], loc_en: "Treasure Island", words_en: ["Map", "Dig", "Gold", "Pirates"] },
            { loc_ar: "ŸÖÿµŸÜÿπ ÿ±Ÿàÿ®Ÿàÿ™ÿßÿ™", words_ar: ["ÿ£ÿ≥ŸÑÿßŸÉ", "ÿµŸäÿßŸÜÿ©", "ÿ®ÿ±ŸÖÿ¨ÿ©", "ŸÖÿπÿßÿØŸÜ"], loc_en: "Robot Factory", words_en: ["Wires", "Maintenance", "Coding", "Metal"] }
        ];

        const EMOJI_LIST = ['üòÄ', 'üòÇ', 'üòç', 'ü§î', 'üòé', 'ü§´', 'üò°', 'ü§¢', 'üò¥', 'ü§Ø', 'üò§', 'ü•∫', 'üò±', 'ü§¨', 'üíÄ', 'üëª', 'üëæ', 'ü§ñ', 'üí©', 'üòà', 'üëÅÔ∏è', 'üß†', 'ü¶∑', 'ü¶¥', 'üëÄ', 'üëä', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'üëå', 'ü§ô', 'üëà', 'üëâ', '‚òùÔ∏è', 'üëÜ', 'üëá', '‚úã', 'ü§ö', 'üñêÔ∏è', 'üññ', 'üëã', 'ü§ù', '‚úä', 'ü§õ', 'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'üôè', 'üí™'];
        const MAX_ROUNDS = 3;

        // --- Helpers ---
        const generateUID = () => Math.floor(100000 + Math.random() * 900000).toString();
        const calculateLevel = (xp) => Math.floor(xp / 100) + 1;
        const calculateXPProgress = (xp) => (xp % 100);
        const getChatId = (id1, id2) => [id1, id2].sort().join('_');
        
        const formatTime = (timestamp) => {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        };
        
        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        };

        const getTimeRemaining = (lastChanged) => {
            if (!lastChanged) return "0d 0h"; 
            const lastChangeDate = lastChanged.toDate ? lastChanged.toDate() : new Date(lastChanged);
            const nextChangeDate = new Date(lastChangeDate);
            nextChangeDate.setMonth(nextChangeDate.getMonth() + 1);
            const now = new Date();
            const diff = nextChangeDate - now;
            if (diff <= 0) return "0d 0h";
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            return `${days}d ${hours}h`;
        };

        // --- Audio ---
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null; 
        const initAudio = () => { if (!audioCtx) audioCtx = new AudioCtx(); };
        const playSound = (type) => {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
            osc.connect(gainNode); gainNode.connect(audioCtx.destination);
            if (type === 'click') { osc.frequency.value = 800; osc.type = 'sine'; gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); osc.start(); osc.stop(audioCtx.currentTime + 0.1); }
            else if (type === 'success') { osc.frequency.value = 600; osc.type = 'sine'; gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(1200, audioCtx.currentTime + 0.15); gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3); osc.start(); osc.stop(audioCtx.currentTime + 0.3); }
            else if (type === 'notification') { osc.type = 'sine'; osc.frequency.setValueAtTime(880, audioCtx.currentTime); osc.frequency.setValueAtTime(1320, audioCtx.currentTime + 0.1); gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5); osc.start(audioCtx.currentTime); osc.stop(audioCtx.currentTime + 0.5); }
        };

        // --- Translations ---
        const TRANSLATIONS = {
            en: {
                appName: "PRO SPY", tagline: "COVERT ARENA",
                nickname: "OPERATOR NAME", create: "CREATE GAME", join: "JOIN OPS", browse: "BROWSE ROOMS",
                codePlaceholder: "ENTER CODE", players: "OPERATIVES", start: "LAUNCH MISSION",
                langBtn: "ÿßŸÑÿπÿ±ÿ®Ÿäÿ©", loading: "PROCESSING...", you: "YOU",
                statusSpy: "SPY", statusAgent: "AGENT", statusInformant: "INFORMANT", statusMrWhite: "MR. WHITE", statusGhost: "GHOST",
                round: "ROUND", skip: "SKIP TURN", vote: "VOTE TO EJECT",
                chatPlaceholder: "Type message...", send: "SEND",
                waiting: "Awaiting host...", location: "LOCATION",
                spectator: "SPECTATOR",
                confirm: "CONFIRM VOTE", 
                spyWin: "SPY WINS!", agentsWin: "AGENTS WIN!", mrWhiteWin: "MR. WHITE WINS!",
                playAgain: "PLAY AGAIN", connecting: "Connecting...",
                startVoting: "START VOTING", votingStarted: "VOTING INITIATED",
                voteRequestTitle: "VOTING REQUEST", voteRequestDesc: "wants to start voting.",
                agree: "AGREE", decline: "DECLINE",
                endVoting: "END VOTING NOW", votesTitle: "VOTES:",
                roundsFormat: (c, m) => `ROUND ${c}/${m}`,
                wordSelectionTitle: "SELECT KEYWORD", wordSelectionDesc: "Choose a keyword for this round", finishSelection: "FINISH SELECTION", selectedWord: "Selected Keyword",
                loginGoogle: "Login", myAccount: "My Account", logout: "Logout", profile: "Profile", guest: "Guest", linkGuessCard: "GUESS MY CARD",
                level: "Level", wins: "Wins", losses: "Losses", winRate: "Win Rate", totalGames: "Games", achievements: "Achievements", id: "ID",
                enterCodeError: "Please enter a room code.", changeName: "Change Name", nameChangeLimit: "Once a month", copied: "Copied!", save: "Save", or: "OR", needPlayers: "Minimum players not met!", ok: "OK",
                tabLobby: "Lobby", tabLeaderboard: "Leaderboard", tabFriends: "Friends",
                addFriend: "Add Friend", friendIdPlaceholder: "Enter Friend ID",
                online: "Online", offline: "Offline", noFriends: "No friends yet.",
                friendAdded: "Friend Added!", friendNotFound: "User not found.", requestSent: "Request Sent!",
                incomingRequests: "Incoming Requests", noRequests: "No pending requests.",
                accept: "Accept", reject: "Reject",
                sendMessage: "Send", chatPlaceholder: "Message...",
                inviteBtn: "Invite", invitedYou: "invited you to play.", joinInvite: "Join?",
                inviteFriends: "Invite Friends",
                accountInfo: "Account Information",
                email: "Email",
                memberSince: "Member Since",
                nameChangeCountdown: "Name Change In",
                canChangeNow: "Can change now!",
                selectEmoji: "Emoji",
                guestTitle: "GUEST ACCOUNT",
                guestDesc: "Register to save progress and add friends.",
                kd: "K/D Ratio", stats: "Stats", noPermission: "Feature unavailable for guests.",
                normalMode: "NORMAL MODE", advancedMode: "ADVANCED MODE (6+)",
                modeNormalDesc: "Classic Spy vs Agents. 3-10 Players.",
                modeAdvDesc: "Special Roles included! 6-10 Players.",
                privateRoom: "Private Room", password: "Password", publicRoom: "Public Room",
                noRooms: "No active games found.", lobbyTitle: "GAME LOBBY",
                mrWhiteInstruction: "Guess the location to win!",
                informantInstruction: "You know a neighbor!",
                ghostInstruction: "You are now a Ghost. You can watch but cannot act.",
                guessLocation: "GUESS LOCATION"
            },
            ar: {
                appName: "ÿ®ÿ±Ÿà ÿ¨ÿßÿ≥Ÿàÿ≥", tagline: "ÿ≥ÿßÿ≠ÿ© ÿßŸÑÿπŸÖŸÑŸäÿßÿ™",
                nickname: "ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ", create: "ÿ•ŸÜÿ¥ÿßÿ° ŸÑÿπÿ®ÿ©", join: "ÿßŸÜÿ∂ŸÖÿßŸÖ", browse: "ÿßÿ≥ÿ™ÿπÿ±ÿßÿ∂ ÿßŸÑÿ∫ÿ±ŸÅ",
                codePlaceholder: "ÿ£ÿØÿÆŸÑ ÿßŸÑŸÉŸàÿØ", players: "ÿßŸÑÿπŸÖŸÑÿßÿ°", start: "ÿ®ÿØÿ° ÿßŸÑŸÖŸáŸÖÿ©",
                langBtn: "English", loading: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...", you: "ÿ£ŸÜÿ™",
                statusSpy: "ÿ¨ÿßÿ≥Ÿàÿ≥", statusAgent: "ÿπŸÖŸäŸÑ", statusInformant: "ÿßŸÑŸÖÿÆÿ®ÿ±", statusMrWhite: "ÿßŸÑÿ≥ŸäÿØ", statusGhost: "ÿ¥ÿ®ÿ≠",
                round: "ÿßŸÑÿ¨ŸàŸÑÿ©", skip: "ÿ™ÿÆÿ∑Ÿä ÿßŸÑÿØŸàÿ±", vote: "ÿ™ÿµŸàŸäÿ™ ŸÑŸÑÿ∑ÿ±ÿØ",
                chatPlaceholder: "ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©...", send: "ÿ•ÿ±ÿ≥ÿßŸÑ",
                waiting: "ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÖÿ∂ŸäŸÅ...", location: "ÿßŸÑŸÖŸàŸÇÿπ",
                spectator: "ŸÖÿ¥ÿßŸáÿØ",
                confirm: "ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ™ÿµŸàŸäÿ™",
                spyWin: "ŸÅÿßÿ≤ ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥!", agentsWin: "ŸÅÿßÿ≤ ÿßŸÑÿπŸÖŸÑÿßÿ°!", mrWhiteWin: "ŸÅÿßÿ≤ ÿßŸÑÿ≥ŸäÿØ!",
                playAgain: "ŸÑÿπÿ® ŸÖÿ¨ÿØÿØÿßŸã", connecting: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ£ŸÖŸäŸÜ...",
                startVoting: "ÿ®ÿØÿ° ÿßŸÑÿ™ÿµŸàŸäÿ™", votingStarted: "ÿ®ÿØÿ£ ÿßŸÑÿ™ÿµŸàŸäÿ™",
                voteRequestTitle: "ÿ∑ŸÑÿ® ÿ™ÿµŸàŸäÿ™", voteRequestDesc: "Ÿäÿ±ŸäÿØ ÿ®ÿØÿ° ÿßŸÑÿ™ÿµŸàŸäÿ™.",
                agree: "ŸÖŸàÿßŸÅŸÇ", decline: "ÿ±ŸÅÿ∂",
                endVoting: "ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿ™ÿµŸàŸäÿ™ ÿßŸÑÿ¢ŸÜ", votesTitle: "ÿßŸÑÿ£ÿµŸàÿßÿ™:",
                roundsFormat: (c, m) => `ÿßŸÑÿ¨ŸàŸÑÿ© ${c}/${m}`,
                wordSelectionTitle: "ÿßÿÆÿ™ÿ± ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±", wordSelectionDesc: "ÿßÿÆÿ™ÿ± ŸÉŸÑŸÖÿ© ÿ≥ÿ± ŸÑŸáÿ∞Ÿá ÿßŸÑÿ¨ŸàŸÑÿ©", finishSelection: "ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ±", selectedWord: "ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±",
                loginGoogle: "ÿØÿÆŸàŸÑ", myAccount: "ÿ≠ÿ≥ÿßÿ®Ÿä", logout: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨", profile: "ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä", guest: "ÿ≤ÿßÿ¶ÿ±", linkGuessCard: "ÿÆŸÖŸÜ ŸÉÿ±ÿ™Ÿä",
                level: "ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ", wins: "ŸÅŸàÿ≤", losses: "ÿÆÿ≥ÿßÿ±ÿ©", winRate: "ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÅŸàÿ≤", totalGames: "ÿßŸÑŸÖÿ®ÿßÿ±Ÿäÿßÿ™", achievements: "ÿßŸÑÿ•ŸÜÿ¨ÿßÿ≤ÿßÿ™", id: "ÿßŸÑÿ±ŸÇŸÖ",
                enterCodeError: "ÿ®ÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ©.", changeName: "ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿßÿ≥ŸÖ", nameChangeLimit: "ŸÖÿ±ÿ© ÿ¥Ÿáÿ±ŸäÿßŸã", copied: "ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ!", save: "ÿ≠ŸÅÿ∏", or: "ÿ£Ÿà", needPlayers: "ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸäŸäŸÜ!", ok: "ÿ≠ÿ≥ŸÜÿßŸã",
                tabLobby: "ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©", tabLeaderboard: "ÿßŸÑŸÖÿ™ÿµÿØÿ±ŸäŸÜ", tabFriends: "ÿßŸÑÿ£ÿµÿØŸÇÿßÿ°",
                addFriend: "ÿ£ÿ∂ÿßŸÅÿ© ÿµÿØŸäŸÇ", friendIdPlaceholder: "ÿ£ÿØÿÆŸÑ ID ÿßŸÑÿµÿØŸäŸÇ",
                online: "ŸÖÿ™ÿµŸÑ", offline: "ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ", noFriends: "ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£ÿµÿØŸÇÿßÿ°.",
                friendAdded: "ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©!", friendNotFound: "ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ.", requestSent: "ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®!",
                incomingRequests: "ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿµÿØÿßŸÇÿ©", noRequests: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™.",
                accept: "ŸÇÿ®ŸàŸÑ", reject: "ÿ±ŸÅÿ∂",
                sendMessage: "ÿ•ÿ±ÿ≥ÿßŸÑ", chatPlaceholder: "ÿ±ÿ≥ÿßŸÑÿ©...",
                inviteBtn: "ÿØÿπŸàÿ©", invitedYou: "ÿØÿπÿßŸÉ ŸÑŸÑÿπÿ®.", joinInvite: "ÿßŸÜÿ∂ŸÖÿßŸÖÿü",
                inviteFriends: "ÿØÿπŸàÿ© ÿ£ÿµÿØŸÇÿßÿ°",
                accountInfo: "ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ®",
                email: "ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä",
                memberSince: "ÿπÿ∂Ÿà ŸÖŸÜÿ∞",
                nameChangeCountdown: "ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿπÿØ",
                canChangeNow: "ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ¢ŸÜ!",
                selectEmoji: "ÿ•ŸäŸÖŸàÿ¨Ÿä",
                guestTitle: "ÿ≠ÿ≥ÿßÿ® ÿ≤ÿßÿ¶ÿ±",
                guestDesc: "ÿ≥ÿ¨ŸÑ ŸÑÿ≠ŸÅÿ∏ ÿ™ŸÇÿØŸÖŸÉ Ÿàÿ•ÿ∂ÿßŸÅÿ© ÿ£ÿµÿØŸÇÿßÿ°.",
                kd: "ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÄ KD", stats: "ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™", noPermission: "ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠ ŸÑŸÑÿ≤Ÿàÿßÿ±.",
                normalMode: "ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿπÿßÿØŸä", advancedMode: "ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ (6+)",
                modeNormalDesc: "ÿ¨ÿßÿ≥Ÿàÿ≥ ÿ∂ÿØ ÿπŸÖŸÑÿßÿ°. 3-10 ŸÑÿßÿπÿ®ŸäŸÜ.",
                modeAdvDesc: "ÿ£ÿØŸàÿßÿ± ÿÆÿßÿµÿ©! 6-10 ŸÑÿßÿπÿ®ŸäŸÜ.",
                privateRoom: "ÿ∫ÿ±ŸÅÿ© ÿÆÿßÿµÿ©", password: "ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±", publicRoom: "ÿ∫ÿ±ŸÅÿ© ÿπÿßŸÖÿ©",
                noRooms: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ŸÑÿπÿßÿ® ŸÜÿ¥ÿ∑ÿ©.", lobbyTitle: "ÿ∫ÿ±ŸÅÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±",
                mrWhiteInstruction: "ÿÆŸÖŸÜ ÿßŸÑŸÖŸÉÿßŸÜ ŸÑÿ™ŸÅŸàÿ≤!",
                informantInstruction: "ÿ™ÿπÿ±ŸÅ ÿπŸÑŸâ ÿ¨ÿßÿ±ŸÉ!",
                ghostInstruction: "ÿ£ŸÜÿ™ ÿßŸÑÿ¢ŸÜ ÿ¥ÿ®ÿ≠. ŸäŸÖŸÉŸÜŸÉ ÿßŸÑŸÖÿ¥ÿßŸáÿØÿ© ŸÅŸÇÿ∑.",
                guessLocation: "ÿÆŸÖŸÜ ÿßŸÑŸÖŸÉÿßŸÜ"
            }
        };

        // --- Components ---
        const GuestBanner = ({ lang }) => {
            const t = TRANSLATIONS[lang];
            return (
                <div className="guest-banner">
                    <h3 className="text-lg font-bold">{t.guestTitle}</h3>
                    <p className="text-xs text-gray-400">{t.guestDesc}</p>
                </div>
            );
        };

        const UserProfileModal = ({ show, onClose, targetUID, lang, onAddFriend, isFriend, currentUserData }) => {
            const t = TRANSLATIONS[lang];
            const [profileData, setProfileData] = useState(null);
            const [msg, setMsg] = useState('');

            useEffect(() => {
                if (show && targetUID) {
                    usersCollection.doc(targetUID).get().then(doc => {
                        if (doc.exists) setProfileData(doc.data());
                    });
                }
            }, [show, targetUID]);

            if (!show || !profileData) return null;

            const level = calculateLevel(profileData.stats?.xp || 0);
            const wins = profileData.stats?.wins || 0;
            const losses = profileData.stats?.losses || 0;
            const totalGames = wins + losses;
            const kd = totalGames > 0 ? ((wins / totalGames)).toFixed(2) : "0.00";
            const isTargetGuest = profileData.isAnonymous;

            const handleSendRequest = async () => {
                if (isFriend || currentUserData.isAnonymous) return;
                await usersCollection.doc(targetUID).update({
                    friendRequests: firebase.firestore.FieldValue.arrayUnion(currentUserData.uid)
                });
                setMsg(t.requestSent);
                setTimeout(() => setMsg(''), 2000);
            };

            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] p-4" onClick={onClose}>
                    <div className="glass-panel rounded-2xl p-6 w-full max-w-sm animate-pop" onClick={e => e.stopPropagation()}>
                        <div className="profile-header">
                            <img src={profileData.photoURL || `https://ui-avatars.com/api/?name=${profileData.displayName}&background=random`} className="profile-avatar" alt=""/>
                            <div className="profile-name">{profileData.displayName}</div>
                            <div className="profile-id-box" onClick={() => { navigator.clipboard.writeText(profileData.customId); setMsg(t.copied); setTimeout(()=>setMsg(''),1500) }}>
                                <span className="profile-id-text">ID: #{profileData.customId}</span>
                                <svg className="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            </div>
                        </div>
                        {msg && <div className="text-center text-xs text-cyan-400 mb-4">{msg}</div>}
                        <div className="info-grid">
                            <div className="info-box"><span className="info-label">{t.level}</span><span className="info-value text-primary">{level}</span></div>
                            <div className="info-box"><span className="info-label">{t.kd}</span><span className="info-value">{kd}</span></div>
                            <div className="info-box"><span className="info-label">{t.wins}</span><span className="info-value text-green-400">{wins}</span></div>
                            <div className="info-box"><span className="info-label">{t.losses}</span><span className="info-value text-red-400">{losses}</span></div>
                        </div>
                        {targetUID !== currentUserData.uid && !isTargetGuest && (
                            !currentUserData.isAnonymous ? (
                                <button onClick={handleSendRequest} disabled={msg || isFriend} className={`w-full py-2 rounded-lg font-bold text-xs ${isFriend ? 'bg-gray-700 text-gray-400' : 'btn-neon'}`}>
                                    {isFriend ? "Already Friends" : (msg || t.addFriend)}
                                </button>
                            ) : (<div className="text-center text-xs text-gray-500 mt-2">{t.noPermission}</div>)
                        )}
                    </div>
                </div>
            );
        };

        const MyAccountPage = ({ show, onClose, userData, user, lang, onUpdate }) => {
            const t = TRANSLATIONS[lang];
            const [newName, setNewName] = useState('');
            const [msg, setMsg] = useState('');
            const isGuest = userData?.isAnonymous;

            useEffect(() => {
                if (userData) setNewName(userData.displayName || '');
            }, [userData]);

            if (!show || !userData) return null;

            const level = calculateLevel(userData.stats?.xp || 0);
            const xpProgress = calculateXPProgress(userData.stats?.xp || 0);
            const timeRemaining = getTimeRemaining(userData.lastChangedName);
            const canChange = timeRemaining === "0d 0h";

            const handleChangeName = async () => {
                if(!newName.trim()) return;
                if (!canChange) { setMsg(t.nameChangeLimit); return; }
                await usersCollection.doc(userData.uid).update({ displayName: newName, lastChangedName: firebase.firestore.FieldValue.serverTimestamp() });
                setMsg("Updated!");
                if (onUpdate) onUpdate();
            };

            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4 overflow-y-auto" onClick={onClose}>
                    <div className="glass-panel rounded-2xl p-6 w-full max-w-md animate-pop my-8" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-primary">{t.myAccount}</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-white text-2xl">&times;</button>
                        </div>
                        {isGuest && <GuestBanner lang={lang} />}
                        <div className="profile-header mb-6">
                            <img src={userData.photoURL || `https://ui-avatars.com/api/?name=${userData.displayName}&background=random`} className="profile-avatar" alt=""/>
                            <div className="profile-name">{userData.displayName}</div>
                            <div className="profile-id-box" onClick={() => { navigator.clipboard.writeText(userData.customId); setMsg(t.copied); setTimeout(()=>setMsg(''),1500) }}>
                                <span className="profile-id-text">ID: #{userData.customId}</span>
                                <svg className="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            </div>
                        </div>
                        <div className="space-y-4 mb-6">
                            <div className="info-grid">
                                <div className="info-box col-span-2"><span className="info-label">{t.email}</span><span className="info-value text-sm">{user.email}</span></div>
                                <div className="info-box col-span-2"><span className="info-label">{t.memberSince}</span><span className="info-value text-xs">{formatDate(userData.createdAt)}</span></div>
                            </div>
                        </div>
                        {!isGuest && (
                            <div className="mb-6 glass-panel p-3 rounded-lg border border-white/10">
                                <label className="text-[10px] text-gray-400 uppercase">{t.changeName}</label>
                                <div className="flex gap-2 mt-1">
                                    <input className="input-dark flex-1 p-2 rounded text-xs" value={newName} onChange={e => setNewName(e.target.value)} />
                                    <button onClick={handleChangeName} disabled={!canChange} className={`px-3 rounded text-xs font-bold ${canChange ? 'btn-neon' : 'bg-gray-700 text-gray-400 cursor-not-allowed'}`}>{t.save}</button>
                                </div>
                                <p className="text-[10px] text-gray-500 mt-1">{canChange ? t.canChangeNow : `${t.nameChangeCountdown}: ${timeRemaining}`}</p>
                            </div>
                        )}
                        {msg && !msg.includes('Copied') && <div className="text-center text-xs text-cyan-400 mb-2">{msg}</div>}
                        <div className="mb-6 glass-panel rounded-xl p-4 border border-white/10">
                            <div className="flex justify-between items-center mb-2">
                                <span className="font-bold text-primary">{t.level} {level}</span>
                                <span className="text-xs text-gray-400">{xpProgress}/100 XP</span>
                            </div>
                            <div className="w-full h-2 xp-bar-bg rounded-full overflow-hidden">
                                <div className="h-full xp-bar-fill" style={{ width: `${xpProgress}%` }}></div>
                            </div>
                        </div>
                        <div className="grid grid-cols-3 gap-4 mb-6">
                            <div className="text-center"><div className="text-3xl font-bold text-green-400">{userData.stats?.wins || 0}</div><div className="text-[10px] text-gray-500 uppercase">{t.wins}</div></div>
                            <div className="text-center"><div className="text-3xl font-bold text-red-400">{userData.stats?.losses || 0}</div><div className="text-[10px] text-gray-500 uppercase">{t.losses}</div></div>
                            <div className="text-center"><div className="text-3xl font-bold text-cyan-400">{(userData.stats?.wins || 0) + (userData.stats?.losses || 0)}</div><div className="text-[10px] text-gray-500 uppercase">{t.totalGames}</div></div>
                        </div>
                         <div>
                            <h3 className="text-sm font-bold text-gray-400 mb-3">{t.achievements}</h3>
                            <div className="grid grid-cols-3 gap-2">
                                {ACHIEVEMENTS.map(ach => {
                                    const isUnlocked = (userData.achievements || []).includes(ach.id);
                                    return (
                                        <div key={ach.id} className={`achievement-card rounded-lg p-2 text-center ${isUnlocked ? 'unlocked' : 'locked'}`}>
                                            <div className="text-2xl mb-1">{ach.icon}</div>
                                            <div className="text-[10px] font-bold truncate">{lang === 'ar' ? ach.name_ar : ach.name_en}</div>
                                            <div className="ach-tooltip">{lang === 'ar' ? ach.desc_ar : ach.desc_en}</div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const PrivateChatModal = ({ show, onClose, friendData, currentUser, lang, onInvite, roomId, onJoinInvite }) => {
            const t = TRANSLATIONS[lang];
            const [messages, setMessages] = useState([]);
            const [newMsg, setNewMsg] = useState('');
            const [showEmojis, setShowEmojis] = useState(false);
            const chatId = (friendData && currentUser) ? getChatId(currentUser.uid, friendData.uid) : null;
            
            useEffect(() => {
                if(show && chatId) {
                    const unsub = chatsCollection.doc(chatId).collection('messages').orderBy('timestamp', 'asc').onSnapshot(snap => {
                        setMessages(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    });
                    
                    chatsCollection.doc(chatId).set({
                        [`unread.${currentUser.uid}`]: 0
                    }, { merge: true });

                    return unsub;
                }
            }, [show, chatId]);

            const handleSend = async (text) => {
                const msgText = text || newMsg;
                if(!msgText.trim() || !chatId) return;
                const msg = {
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName,
                    text: msgText,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'text'
                };
                
                const batch = db.batch();
                const msgRef = chatsCollection.doc(chatId).collection('messages').doc();
                batch.set(msgRef, msg);
                
                const chatRef = chatsCollection.doc(chatId);
                batch.set(chatRef, {
                    members: [currentUser.uid, friendData.uid],
                    lastMessage: msgText,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    [`unread.${friendData.uid}`]: firebase.firestore.FieldValue.increment(1)
                }, { merge: true });
                
                await batch.commit();
                
                setNewMsg('');
                setShowEmojis(false);
            };
            
            const handleInvite = async () => {
                if(!chatId) return;
                const inviteMsg = {
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName,
                    text: `${currentUser.displayName} ${t.invitedYou}`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'invite',
                    roomId: roomId
                };
                
                const batch = db.batch();
                const msgRef = chatsCollection.doc(chatId).collection('messages').doc();
                batch.set(msgRef, inviteMsg);
                
                const chatRef = chatsCollection.doc(chatId);
                batch.set(chatRef, {
                    members: [currentUser.uid, friendData.uid],
                    lastMessage: t.inviteBtn,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    [`unread.${friendData.uid}`]: firebase.firestore.FieldValue.increment(1)
                }, { merge: true });

                await batch.commit();
            };
            
            if(!show || !friendData || !currentUser) return null;
            
            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-[100] p-4" onClick={()=>{onClose(); setShowEmojis(false);}}>
                    <div className="glass-panel rounded-2xl w-full max-w-lg h-[600px] flex flex-col animate-pop relative" onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b border-white/10 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <img src={friendData.photoURL} className="w-10 h-10 rounded-full border-2 border-cyan-400"/>
                                <div>
                                    <h3 className="font-bold">{friendData.displayName}</h3>
                                    <span className="text-xs text-gray-400">Lvl {calculateLevel(friendData.stats?.xp)}</span>
                                </div>
                            </div>
                            <button onClick={onClose} className="text-xl text-gray-400 hover:text-white">&times;</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {messages.map(m => (
                                <div key={m.id} className={`chat-msg-row ${m.senderId === currentUser.uid ? 'flex-row-reverse' : ''}`}>
                                    <img src={m.senderId === currentUser.uid ? currentUser.photoURL : friendData.photoURL} className="chat-avatar" alt=""/>
                                    <div className="chat-content">
                                        <div className={`chat-header ${m.senderId === currentUser.uid ? 'justify-end' : ''}`}>
                                            <span className="chat-username">{m.senderName}</span>
                                            <span className="chat-timestamp">{formatTime(m.timestamp)}</span>
                                        </div>
                                        <div className={`chat-bubble ${m.senderId === currentUser.uid ? 'chat-bubble-me' : 'chat-bubble-other'}`}>
                                            {m.type === 'invite' ? (
                                                <div className="invite-bubble">
                                                    <p className="text-sm">{m.text}</p>
                                                    {m.senderId !== currentUser.uid && m.roomId && (
                                                        <button onClick={() => onJoinInvite(m.roomId)} className="btn-neon px-4 py-1 rounded text-xs mt-2">{t.joinInvite}</button>
                                                    )}
                                                </div>
                                            ) : ( <p>{m.text}</p> )}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                        {showEmojis && (
                            <div className="emoji-picker-container">
                                <div className="flex justify-between items-center mb-1">
                                    <span className="text-xs text-gray-400">{t.selectEmoji}</span>
                                    <button onClick={() => setShowEmojis(false)} className="text-xs text-gray-500 hover:text-white">&times;</button>
                                </div>
                                <div className="emoji-grid">
                                    {EMOJI_LIST.map(emoji => (
                                        <span key={emoji} onClick={() => handleSend(emoji)} className="emoji-item">{emoji}</span>
                                    ))}
                                </div>
                            </div>
                        )}
                        <div className="p-4 border-t border-white/10 relative">
                            {roomId && !currentUser.isAnonymous && (<button onClick={handleInvite} className="btn-success w-full py-2 rounded text-xs mb-2">{t.inviteBtn} ({t.inviteFriends})</button>)}
                            <div className="flex gap-2 items-center">
                                <button onClick={() => setShowEmojis(!showEmojis)} className="btn-ghost p-2 rounded-full text-xl">üòÄ</button>
                                <input className="input-dark flex-1 p-2 rounded-full text-sm" placeholder={t.chatPlaceholder} value={newMsg} onChange={e => setNewMsg(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleSend()} />
                                <button onClick={() => handleSend()} className="btn-neon px-4 rounded-full">{t.send}</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        const GameChatMessage = ({ msg, currentUser, players, onAvatarClick }) => {
            const sender = players.find(p => p.uid === msg.sender);
            const isMe = msg.sender === currentUser.uid;
            
            if(msg.sender === 'system') return <div className="text-center text-[10px] text-gray-500 my-2">{msg.text}</div>;
            
            return (
                <div className={`chat-msg-row ${isMe ? 'flex-row-reverse' : ''}`}>
                    <img src={sender?.photo || `https://ui-avatars.com/api/?name=${sender?.name}`} className="chat-avatar" alt="" onClick={() => onAvatarClick(msg.sender)} />
                    <div className="chat-content">
                        <div className={`chat-header ${isMe ? 'justify-end' : ''}`}>
                            <span className="chat-username">{msg.name}</span>
                            <span className="chat-timestamp">{formatTime(msg.time)}</span>
                        </div>
                        <div className={`chat-bubble ${isMe ? 'chat-bubble-me' : 'chat-bubble-other'}`}><p>{msg.text}</p></div>
                    </div>
                </div>
            );
        };
        
        const LobbyBrowserModal = ({ show, onClose, lang, onJoinRoom }) => {
            const t = TRANSLATIONS[lang];
            const [rooms, setRooms] = useState([]);
            const [passwordInput, setPasswordInput] = useState('');
            const [selectedRoom, setSelectedRoom] = useState(null);
            
            useEffect(() => {
                if(show) {
                    const unsub = roomsCollection.where('status', '==', 'waiting').onSnapshot(snap => {
                        setRooms(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    });
                    return unsub;
                }
            }, [show]);
            
            const handleJoinClick = (room) => {
                if(room.isPrivate) {
                    setSelectedRoom(room);
                } else {
                    onJoinRoom(room.id, null);
                    onClose();
                }
            };
            
            const handlePasswordSubmit = () => {
                if(selectedRoom && selectedRoom.password === passwordInput) {
                    onJoinRoom(selectedRoom.id, passwordInput);
                    onClose();
                } else {
                    alert("Wrong Password!");
                }
            };
            
            if(!show) return null;
            
            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4" onClick={onClose}>
                    <div className="glass-panel rounded-2xl p-6 w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col animate-pop" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-primary">{t.lobbyTitle}</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-white text-2xl">&times;</button>
                        </div>
                        
                        {selectedRoom && (
                            <div className="mb-4 p-4 border border-white/10 rounded-lg bg-black/20">
                                <p className="text-sm mb-2">Enter password for <span className="font-bold">{selectedRoom.id}</span></p>
                                <div className="flex gap-2">
                                    <input type="password" className="input-dark flex-1 p-2 rounded" placeholder="Password" value={passwordInput} onChange={e => setPasswordInput(e.target.value)} />
                                    <button onClick={handlePasswordSubmit} className="btn-neon px-4 rounded">{t.join}</button>
                                    <button onClick={() => setSelectedRoom(null)} className="btn-ghost px-2 rounded">&times;</button>
                                </div>
                            </div>
                        )}
                        
                        <div className="flex-1 overflow-y-auto space-y-2">
                            {rooms.length === 0 && <div className="text-center text-gray-500 py-10">{t.noRooms}</div>}
                            {rooms.map(r => (
                                <div key={r.id} className="flex justify-between items-center p-3 bg-white/5 rounded-lg hover:bg-white/10 transition">
                                    <div>
                                        <div className="flex items-center gap-2">
                                            <span className="font-mono text-primary font-bold">{r.id}</span>
                                            {r.isPrivate && <span className="text-[10px] bg-yellow-500/20 text-yellow-400 px-1 rounded">üîí {t.privateRoom}</span>}
                                            <span className={`text-[10px] ${r.mode === 'advanced' ? 'bg-purple-500/20 text-purple-400' : 'bg-blue-500/20 text-blue-400'} px-1 rounded`}>{r.mode === 'advanced' ? t.advancedMode : t.normalMode}</span>
                                        </div>
                                        <div className="text-xs text-gray-400">{r.players?.length || 0} {t.players}</div>
                                    </div>
                                    <button onClick={() => handleJoinClick(r)} className="btn-neon px-4 py-1 rounded text-xs">{t.join}</button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [lang, setLang] = useState('en');
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [room, setRoom] = useState(null);
            const [roomId, setRoomId] = useState('');
            const [inputCode, setInputCode] = useState('');
            const [nickname, setNickname] = useState(() => localStorage.getItem('pro_spy_nick') || '');
            const [loading, setLoading] = useState(false);
            const [chatMsg, setChatMsg] = useState('');
            const [turnTimer, setTurnTimer] = useState(30);
            const [votingTimer, setVotingTimer] = useState(30);
            const [wordSelTimer, setWordSelTimer] = useState(30);
            
            // Game Setup State
            const [showSetupModal, setShowSetupModal] = useState(false);
            const [setupMode, setSetupMode] = useState('normal'); // 'normal' or 'advanced'
            const [isPrivate, setIsPrivate] = useState(false);
            const [password, setPassword] = useState('');
            
            // UI State
            const [activeView, setActiveView] = useState('lobby');
            const [showDropdown, setShowDropdown] = useState(false);
            const [joinError, setJoinError] = useState('');
            const [alertMessage, setAlertMessage] = useState(null);
            const [leaderboardData, setLeaderboardData] = useState([]);
            const [friendsData, setFriendsData] = useState([]);
            const [addFriendId, setAddFriendId] = useState('');
            const [friendSearchMsg, setFriendSearchMsg] = useState('');
            const [friendRequests, setFriendRequests] = useState([]);
            const [showChat, setShowChat] = useState(false);
            const [chatFriend, setChatFriend] = useState(null);
            const [showMyAccount, setShowMyAccount] = useState(false);
            const [showUserProfile, setShowUserProfile] = useState(false);
            const [targetProfileUID, setTargetProfileUID] = useState(null);
            const [chatsMeta, setChatsMeta] = useState({});
            const [totalUnread, setTotalUnread] = useState(0);
            const [openChatId, setOpenChatId] = useState(null);
            const [showLobby, setShowLobby] = useState(false);
            
            const t = TRANSLATIONS[lang];
            const isLoggedIn = user && !user.isAnonymous;
            const isGuest = user && user.isAnonymous;

            // --- Effects ---
            useEffect(() => {
                const canvas = document.getElementById('bg-canvas');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                let width, height, particles = [];
                let mouse = { x: null, y: null };
                const particleCount = 60;
                const resize = () => { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; };
                const handleMouseMove = (e) => { mouse.x = e.clientX; mouse.y = e.clientY; };
                window.addEventListener('resize', resize); window.addEventListener('mousemove', handleMouseMove); resize();
                class Particle {
                    constructor() { this.x = Math.random() * width; this.y = Math.random() * height; this.vx = (Math.random() - 0.5) * 0.5; this.vy = (Math.random() - 0.5) * 0.5; this.size = Math.random() * 2; }
                    update() {
                        this.x += this.vx; this.y += this.vy;
                        if (this.x < 0 || this.x > width) this.vx *= -1;
                        if (this.y < 0 || this.y > height) this.vy *= -1;
                        if (mouse.x != null) { let dx = mouse.x - this.x; let dy = mouse.y - this.y; let dist = Math.sqrt(dx*dx + dy*dy); if (dist < 150) { const force = (150 - dist) / 150; this.x -= dx * force * 0.02; this.y -= dy * force * 0.02; } }
                    }
                    draw() { ctx.fillStyle = 'rgba(0, 242, 255, 0.5)'; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); }
                }
                for(let i=0; i<particleCount; i++) particles.push(new Particle());
                let animId;
                const animate = () => {
                    ctx.clearRect(0, 0, width, height); ctx.strokeStyle = 'rgba(112, 0, 255, 0.1)'; ctx.lineWidth = 1;
                    for (let i = 0; i < particles.length; i++) {
                        particles[i].update(); particles[i].draw();
                        for (let j = i; j < particles.length; j++) { let dx = particles[i].x - particles[j].x; let dy = particles[i].y - particles[j].y; let dist = Math.sqrt(dx*dx + dy*dy); if (dist < 120) { ctx.beginPath(); ctx.moveTo(particles[i].x, particles[i].y); ctx.lineTo(particles[j].x, particles[j].y); ctx.stroke(); } }
                    }
                    animId = requestAnimationFrame(animate);
                };
                animate();
                return () => { cancelAnimationFrame(animId); window.removeEventListener('resize', resize); window.removeEventListener('mousemove', handleMouseMove); };
            }, []);

            useEffect(() => {
                const unsubAuth = auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        setUser(u);
                        const userRef = usersCollection.doc(u.uid);
                        const doc = await userRef.get();
                        if (!doc.exists) {
                             const newUserData = {
                                uid: u.uid, email: u.email, displayName: u.displayName || u.uid.substring(0,5),
                                photoURL: u.photoURL, customId: generateUID(),
                                stats: { wins: 0, losses: 0, xp: 0 }, achievements: [], friends: [], friendRequests: [],
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                lastChangedName: null, lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                                isAnonymous: u.isAnonymous
                            };
                            await userRef.set(newUserData);
                            setUserData(newUserData);
                            if (u.displayName) setNickname(u.displayName);
                        }
                        const unsubSnap = userRef.onSnapshot(snap => {
                            if (snap.exists) {
                                setUserData(snap.data());
                                if (snap.data().displayName) setNickname(snap.data().displayName);
                            }
                        });
                        return () => unsubSnap();
                    } else { setUser(null); setUserData(null); }
                });
                return unsubAuth;
            }, []);

            useEffect(() => {
                if (!user) return;
                const interval = setInterval(() => {
                    usersCollection.doc(user.uid).update({ lastActive: firebase.firestore.FieldValue.serverTimestamp() });
                }, 60000);
                return () => clearInterval(interval);
            }, [user]);

            useEffect(() => {
                if (!user || !roomId) return;
                const unsub = roomsCollection.doc(roomId).onSnapshot(doc => { if (doc.exists) setRoom(doc.data()); else setRoom(null); });
                return unsub;
            }, [user, roomId]);

            useEffect(() => {
                if (activeView === 'leaderboard') {
                    usersCollection.orderBy('stats.wins', 'desc').limit(100).get().then(snap => {
                        const data = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(d => !d.isAnonymous);
                        setLeaderboardData(data);
                    });
                }
            }, [activeView]);

            useEffect(() => {
                if (activeView === 'friends' && userData) {
                    if (userData.friends?.length > 0) {
                        usersCollection.where(firebase.firestore.FieldPath.documentId(), 'in', userData.friends).get().then(snap => {
                            setFriendsData(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                        });
                    } else { setFriendsData([]); }
                    
                    if (userData.friendRequests?.length > 0) {
                        usersCollection.where(firebase.firestore.FieldPath.documentId(), 'in', userData.friendRequests).get().then(snap => {
                            setFriendRequests(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                        });
                    } else { setFriendRequests([]); }
                }
            }, [activeView, userData?.friends, userData?.friendRequests]);

            useEffect(() => {
                if (!user) return;
                const unsub = chatsCollection.where('members', 'array-contains', user.uid).onSnapshot(snap => {
                    let total = 0;
                    const meta = {};
                    snap.docs.forEach(doc => {
                        const d = doc.data();
                        meta[doc.id] = d;
                        const myUnread = d.unread?.[user.uid] || 0;
                        total += myUnread;
                    });
                    setChatsMeta(meta);
                    setTotalUnread(total);
                });
                return unsub;
            }, [user, openChatId]);

            useEffect(() => {
                if (room?.status === 'discussing' && room?.turnEndTime) {
                    const interval = setInterval(() => {
                        const remaining = Math.max(0, Math.floor((room.turnEndTime - Date.now()) / 1000));
                        setTurnTimer(remaining);
                        if (remaining <= 0) { handleSkipTurn(true); clearInterval(interval); }
                    }, 1000);
                    return () => clearInterval(interval);
                } else setTurnTimer(30);
            }, [room?.status, room?.turnEndTime]);

            useEffect(() => {
                if (room?.status === 'voting' && room?.votingEndTime) {
                    const interval = setInterval(() => {
                        const remaining = Math.max(0, Math.floor((room.votingEndTime - Date.now()) / 1000));
                        setVotingTimer(remaining);
                        if (remaining <= 0) { resolveVotes(true); clearInterval(interval); }
                    }, 1000);
                    return () => clearInterval(interval);
                } else setVotingTimer(30);
            }, [room?.status, room?.votingEndTime]);

            useEffect(() => {
                if (room?.status === 'word_selection' && room?.wordSelEndTime) {
                    const interval = setInterval(() => {
                        const remaining = Math.max(0, Math.floor((room.wordSelEndTime - Date.now()) / 1000));
                        setWordSelTimer(remaining);
                        if (remaining <= 0) { finishWordSelection(); clearInterval(interval); }
                    }, 1000);
                    return () => clearInterval(interval);
                } else setWordSelTimer(30);
            }, [room?.status, room?.wordSelEndTime]);

            // --- Actions ---
            const handleGoogleLogin = async () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                try { await auth.signInWithPopup(provider); } catch (e) { console.error(e); }
            };

            const handleLogout = async () => { await auth.signOut(); setShowDropdown(false); setNickname(''); localStorage.removeItem('pro_spy_nick'); };

            const handleCreateGame = async () => {
                if (!nickname.trim()) return;
                playSound('click');
                setLoading(true);
                
                let uid = user?.uid;
                if (!uid) {
                    const anon = await auth.signInAnonymously();
                    uid = anon.user.uid;
                    setUser(anon.user);
                }
                
                const id = Math.random().toString(36).substring(2, 7).toUpperCase();
                await roomsCollection.doc(id).set({
                    id, admin: uid, status: 'waiting',
                    players: [{ uid: uid, name: nickname, status: 'active', photo: userData?.photoURL, role: null }],
                    scenario: null, spyId: null, 
                    currentTurnUID: null, turnEndTime: null, votingEndTime: null, currentRound: 0,
                    messages: [], votes: {}, usedLocations: [], 
                    wordVotes: {}, chosenWord: null, wordSelEndTime: null, votingRequest: null,
                    mode: setupMode, isPrivate: isPrivate, password: isPrivate ? password : null
                });
                setRoomId(id);
                setLoading(false);
                setShowSetupModal(false);
                setActiveView('lobby');
            };

            const handleJoinGame = async (id, pwd) => {
                if (!nickname.trim()) return;
                playSound('click');
                setLoading(true);
                setJoinError('');
                
                let uid = user?.uid;
                if (!uid) {
                    const anon = await auth.signInAnonymously();
                    uid = anon.user.uid;
                    setUser(anon.user);
                }

                const ref = roomsCollection.doc(id.toUpperCase());
                const snap = await ref.get();
                if (snap.exists) {
                    const data = snap.data();
                    if(data.isPrivate && data.password !== pwd) {
                        setJoinError("Incorrect Password");
                        setLoading(false);
                        return;
                    }
                    
                    if(data.mode === 'advanced' && data.players.filter(p=>p.status==='active').length >= 10) {
                        setJoinError("Room is full (Max 10)");
                        setLoading(false);
                        return;
                    }
                    
                    const exists = data.players.find(p => p.uid === uid);
                    if (!exists) {
                        await ref.update({ players: [...data.players, { uid: uid, name: nickname, status: 'active', photo: userData?.photoURL, role: null }] });
                    }
                    setRoomId(id.toUpperCase());
                    setActiveView('lobby');
                } else {
                    setJoinError("Room not found");
                }
                setLoading(false);
            };
            
            const handleJoinFromInvite = async (rId) => {
                setShowChat(false);
                setInputCode(rId);
                setLoading(true);
                let uid = user?.uid;
                if (!uid) { const anon = await auth.signInAnonymously(); uid = anon.user.uid; setUser(anon.user); }
                const ref = roomsCollection.doc(rId);
                const snap = await ref.get();
                if (snap.exists) {
                    const data = snap.data();
                    const exists = data.players.find(p => p.uid === uid);
                    if (!exists) { await ref.update({ players: [...data.players, { uid: uid, name: nickname, status: 'active', photo: userData?.photoURL, role: null }] }); }
                    setRoomId(rId);
                    setActiveView('lobby');
                }
                setLoading(false);
            };

            const startGame = async () => {
                if (room.admin !== user?.uid) return;
                playSound('success');
                
                const activePlayers = room.players.filter(p => p.status === 'active');
                const playerCount = activePlayers.length;
                
                // Mode checks
                if (room.mode === 'advanced' && playerCount < 6) { 
                    setAlertMessage("Advanced mode requires 6+ players!"); 
                    return; 
                }
                if (playerCount < 3) { 
                    setAlertMessage(t.needPlayers); 
                    return; 
                }
                if (playerCount > 10) {
                    setAlertMessage("Max 10 players allowed.");
                    return;
                }

                const used = room.usedLocations || [];
                const avail = SCENARIOS.filter(s => !used.includes(s.loc_en));
                const scenario = (avail.length > 0 ? avail : SCENARIOS)[Math.floor(Math.random() * (avail.length || SCENARIOS.length))];
                const spy = activePlayers[Math.floor(Math.random() * activePlayers.length)];
                
                let roles = {};
                
                if (room.mode === 'advanced') {
                    // Assign Spy
                    roles[spy.uid] = 'spy';
                    
                    // Assign Mr. White (1)
                    let potentialWhites = activePlayers.filter(p => p.uid !== spy.uid);
                    if(potentialWhites.length > 0) {
                        const mrWhite = potentialWhites[Math.floor(Math.random() * potentialWhites.length)];
                        roles[mrWhite.uid] = 'mrwhite';
                        potentialWhites = potentialWhites.filter(p => p.uid !== mrWhite.uid);
                    }
                    
                    // Assign Informant (1)
                    if(potentialWhites.length > 0) {
                        const informant = potentialWhites[Math.floor(Math.random() * potentialWhites.length)];
                        roles[informant.uid] = 'informant';
                    }
                    
                    // Rest are agents
                    activePlayers.forEach(p => { if(!roles[p.uid]) roles[p.uid] = 'agent'; });
                    
                } else {
                    // Normal mode
                    activePlayers.forEach(p => roles[p.uid] = p.uid === spy.uid ? 'spy' : 'agent');
                }
                
                let potentialStarters = activePlayers.filter(p => roles[p.uid] !== 'spy');
                if (potentialStarters.length === 0) potentialStarters = activePlayers; 
                const firstPlayer = potentialStarters[Math.floor(Math.random() * potentialStarters.length)];

                await roomsCollection.doc(roomId).update({
                    status: 'word_selection', scenario, spyId: spy.uid,
                    currentTurnUID: firstPlayer.uid, turnEndTime: null, currentRound: 1, 
                    players: room.players.map(p => ({ ...p, vote: null, role: roles[p.uid] || 'agent' })),
                    usedLocations: firebase.firestore.FieldValue.arrayUnion(scenario.loc_en),
                    messages: [], votes: {}, wordVotes: {}, chosenWord: null, 
                    wordSelEndTime: Date.now() + 30000, votingRequest: null
                });
            };

            const submitWordVote = async (word) => {
                if (!user || !room || room.status !== 'word_selection') return;
                playSound('click');
                const voteUpdate = {}; voteUpdate[`wordVotes.${user.uid}`] = word;
                await roomsCollection.doc(roomId).update(voteUpdate);
            };

            const finishWordSelection = async () => {
                if (!room || room.status !== 'word_selection') return;
                const freshSnap = await roomsCollection.doc(roomId).get();
                const freshData = freshSnap.data();
                const counts = {};
                Object.values(freshData.wordVotes || {}).forEach(v => counts[v] = (counts[v] || 0) + 1);
                let maxCount = 0;
                let chosenWord = (lang === 'ar' ? freshData.scenario.words_ar[0] : freshData.scenario.words_en[0]);
                for (const w in counts) { if (counts[w] > maxCount) { maxCount = counts[w]; chosenWord = w; } }
                await roomsCollection.doc(roomId).update({
                    status: 'discussing', turnEndTime: Date.now() + 30000, chosenWord: chosenWord, wordSelEndTime: null
                });
            };

            const handleSkipTurn = async (forced = false) => {
                if (!room) return;
                if (!forced && room.currentTurnUID !== user?.uid) return;
                if (forced && room.status !== 'discussing') return;
                nextTurn();
            };

            const nextTurn = async () => {
                if (!room) return;
                const activePlayers = room.players.filter(p => p.status === 'active');
                const currentIndex = activePlayers.findIndex(p => p.uid === room.currentTurnUID);
                const nextIndex = (currentIndex + 1) % activePlayers.length;
                await roomsCollection.doc(roomId).update({
                    currentTurnUID: activePlayers[nextIndex].uid, turnEndTime: Date.now() + 30000
                });
            };

            const requestVoting = async () => {
                if (!room || room.status !== 'discussing') return;
                playSound('click');
                if (room.admin === user?.uid) { await triggerVoting(); return; }
                await roomsCollection.doc(roomId).update({
                    votingRequest: { requestedBy: user.uid, votes: { [user.uid]: true } }
                });
            };

            const agreeToVote = async () => {
                if (!room || !room.votingRequest) return;
                playSound('click');
                const currentVotes = room.votingRequest.votes || {};
                const newVotes = { ...currentVotes, [user.uid]: true };
                const activePlayers = room.players.filter(p => p.status === 'active');
                const majorityCount = Math.floor(activePlayers.length / 2) + 1;
                if (user?.uid === room.admin) { await triggerVoting(); return; }
                const agreeCount = Object.values(newVotes).filter(v => v === true).length;
                if (agreeCount >= majorityCount) { await triggerVoting(); } 
                else { await roomsCollection.doc(roomId).update({ "votingRequest.votes": newVotes }); }
            };

            const declineVote = async () => {
                if (!room || !room.votingRequest) return;
                playSound('click');
                const currentVotes = room.votingRequest.votes || {};
                const newVotes = { ...currentVotes, [user.uid]: false };
                const activePlayers = room.players.filter(p => p.status === 'active');
                const majorityCount = Math.floor(activePlayers.length / 2) + 1;
                const declineCount = Object.values(newVotes).filter(v => v === false).length;
                if (declineCount >= majorityCount) {
                    await roomsCollection.doc(roomId).update({ votingRequest: null });
                } else { await roomsCollection.doc(roomId).update({ "votingRequest.votes": newVotes }); }
            };

            const triggerVoting = async () => {
                playSound('click');
                const sysMsg = { sender: 'system', name: 'SYSTEM', text: t.votingStarted, time: Date.now() };
                await roomsCollection.doc(roomId).update({
                    status: 'voting', currentTurnUID: null, turnEndTime: null,
                    votingEndTime: Date.now() + 30000, messages: firebase.firestore.FieldValue.arrayUnion(sysMsg), votingRequest: null
                });
            };

            const sendMessage = async (text) => {
                if (!text.trim() || !user) return;
                playSound('click');
                const msg = { sender: user.uid, name: nickname, text: text, time: Date.now() };
                await roomsCollection.doc(roomId).update({
                    messages: firebase.firestore.FieldValue.arrayUnion(msg)
                });
                setChatMsg('');
            };

            const submitVote = async (targetUID) => {
                if (!targetUID || !user || (room.votes && room.votes[user.uid])) return;
                playSound('click');
                const voteUpdate = {}; voteUpdate[`votes.${user.uid}`] = targetUID;
                await roomsCollection.doc(roomId).update(voteUpdate);
            };

            const endVotingNow = async () => {
                if (room.admin !== user?.uid) return;
                await resolveVotes(true);
            };

            const resolveVotes = async (forced = false) => {
                if (!room || room.status !== 'voting') return;
                const freshSnap = await roomsCollection.doc(roomId).get();
                const freshData = freshSnap.data();
                if (freshData.status !== 'voting') return;

                const activePlayers = freshData.players.filter(p => p.status === 'active');
                const votes = freshData.votes || {};
                const voteCounts = {};
                Object.values(votes).forEach(v => voteCounts[v] = (voteCounts[v] || 0) + 1);
                let maxVotes = 0; let ejectedUID = null; let isTie = false;
                for (const uid in voteCounts) {
                    if (voteCounts[uid] > maxVotes) { maxVotes = voteCounts[uid]; ejectedUID = uid; isTie = false; }
                    else if (voteCounts[uid] === maxVotes) { isTie = true; }
                }
                const majorityNeeded = Math.floor(activePlayers.length / 2) + 1;
                
                if (isTie || maxVotes < majorityNeeded) {
                    const nextRound = (freshData.currentRound || 1) + 1;
                    if (nextRound > MAX_ROUNDS) { await endGame(false); } 
                    else {
                        const firstPlayer = activePlayers.find(p => freshData.players.find(fp=>fp.uid===p.uid)?.role !== 'spy') || activePlayers[0];
                        await roomsCollection.doc(roomId).update({
                            status: 'word_selection', votes: {}, currentRound: nextRound,
                            currentTurnUID: firstPlayer.uid, turnEndTime: null, votingEndTime: null,
                            wordVotes: {}, chosenWord: null, wordSelEndTime: Date.now() + 30000
                        });
                    }
                } else {
                    const newPlayers = freshData.players.map(p => { if (p.uid === ejectedUID) return { ...p, status: freshData.mode === 'advanced' && p.role !== 'spy' ? 'ghost' : 'spectator' }; return p; });
                    const isSpy = ejectedUID === freshData.spyId;
                    const mrWhite = freshData.players.find(p => p.role === 'mrwhite');
                    
                    // Mr. White wins logic handled in Guess button logic, but if voted out he loses normally.
                    if (mrWhite && ejectedUID === mrWhite.uid) {
                         // Mr White loses
                         await endGame(false); // Spy wins
                         await roomsCollection.doc(roomId).update({ players: newPlayers });
                    }
                    else if (isSpy) { 
                        await updateGameStats(freshData.players, freshData.spyId); 
                        await roomsCollection.doc(roomId).update({ players: newPlayers, status: 'finished_spy_caught' });
                    } 
                    else {
                         // Ejected an agent/informant
                         const remainingAgents = newPlayers.filter(p => p.status === 'active' && p.role !== 'spy');
                         // Agents need to find spy. Informants count as agents.
                         if (remainingAgents.length <= 1) { 
                             await endGame(false); // Spy wins
                             await roomsCollection.doc(roomId).update({ players: newPlayers });
                         }
                         else {
                             const nextRound = (freshData.currentRound || 1) + 1;
                             if (nextRound > MAX_ROUNDS) { await endGame(false); await roomsCollection.doc(roomId).update({ players: newPlayers }); }
                             else {
                                 const firstPlayer = newPlayers.filter(p => p.status === 'active').find(p => p.role !== 'spy') || newPlayers.filter(p => p.status === 'active')[0];
                                 await roomsCollection.doc(roomId).update({
                                     players: newPlayers, status: 'word_selection', votes: {},
                                     currentTurnUID: firstPlayer.uid, turnEndTime: null, votingEndTime: null,
                                     currentRound: nextRound, wordVotes: {}, chosenWord: null, wordSelEndTime: Date.now() + 30000
                                 });
                                 return;
                             }
                         }
                    }
                }
            };
            
            // Mr. White Guess Logic
            const handleMrWhiteGuess = async (guess) => {
                if(!room || !user) return;
                const me = room.players.find(p => p.uid === user.uid);
                if(me.role !== 'mrwhite') return;
                
                const correct = (lang === 'ar' ? room.scenario?.loc_ar : room.scenario?.loc_en);
                if(guess === correct) {
                    playSound('success');
                    await roomsCollection.doc(roomId).update({ status: 'finished_mrwhite_wins' });
                } else {
                    // He loses chance? Or just wrong. For simplicity: Nothing happens or he dies?
                    // Let's say he just fails.
                    setAlertMessage("Wrong guess! You remain silent.");
                }
            };

            const updateGameStats = async (players, spyId) => {
                const batch = db.batch();
                const spyWin = room.status === 'finished_spy_wins';
                players.forEach(p => {
                    if(!p.uid) return;
                    const userRef = usersCollection.doc(p.uid);
                    const isWinner = (p.uid === spyId && spyWin) || (p.uid !== spyId && !spyWin);
                    batch.update(userRef, {
                        "stats.wins": firebase.firestore.FieldValue.increment(isWinner ? 1 : 0),
                        "stats.losses": firebase.firestore.FieldValue.increment(!isWinner ? 1 : 0),
                        "stats.xp": firebase.firestore.FieldValue.increment(isWinner ? 50 : 10)
                    });
                });
                await batch.commit();
                checkAchievements(players, spyId);
            };
            
            const checkAchievements = async (players, spyId) => {
                const spyWin = room.status === 'finished_spy_wins';
                await Promise.all(players.map(async (p) => {
                    if(!p || !p.uid || p.isAnonymous) return;
                    const userRef = usersCollection.doc(p.uid);
                    const doc = await userRef.get();
                    if(!doc.exists) return;
                    const data = doc.data();
                    const wins = (data.stats?.wins || 0);
                    const currentAch = data.achievements || [];
                    let newAch = [...currentAch];
                    if(wins >= 1 && !currentAch.includes('first_win')) newAch.push('first_win');
                    if(wins >= 5 && !currentAch.includes('wins_5')) newAch.push('wins_5');
                    if(wins >= 10 && !currentAch.includes('wins_10')) newAch.push('wins_10');
                    if(wins >= 20 && !currentAch.includes('wins_20')) newAch.push('wins_20');
                    if(wins >= 50 && !currentAch.includes('wins_50')) newAch.push('wins_50');
                    if(wins >= 100 && !currentAch.includes('wins_100')) newAch.push('wins_100');
                    if(newAch.length > currentAch.length) { try { await userRef.update({ achievements: newAch }); } catch(err) { console.error("Ach err", err); } }
                }));
            };

            const endGame = async (agentsWin) => {
                playSound(agentsWin ? 'success' : 'fail');
                await roomsCollection.doc(roomId).update({
                    status: agentsWin ? 'finished_spy_caught' : 'finished_spy_wins',
                    turnEndTime: null, votingEndTime: null
                });
            };

            const resetGame = async () => {
                playSound('click');
                await roomsCollection.doc(roomId).update({
                    status: 'waiting', scenario: null, spyId: null, currentTurnUID: null, currentRound: 0,
                    votes: {}, messages: [], votingEndTime: null, turnEndTime: null,
                    players: room.players.map(p => ({ uid: p.uid, name: p.name, status: 'active', photo: p.photo, role: null })),
                    wordVotes: {}, chosenWord: null, wordSelEndTime: null, votingRequest: null
                });
            };
            
            const openProfile = (uid) => {
                if(!uid) return;
                setTargetProfileUID(uid);
                setShowUserProfile(true);
            };
            
            const openChat = (friend) => {
                setChatFriend(friend);
                setShowChat(true);
                const cId = getChatId(user.uid, friend.uid);
                setOpenChatId(cId);
            };
            
            const closeChat = () => {
                setShowChat(false);
                setChatFriend(null);
                setOpenChatId(null);
            }
            
            const handleSendRequest = async () => {
                if (!addFriendId || addFriendId === userData.customId || isGuest) return;
                const snap = await usersCollection.where('customId', '==', addFriendId).get();
                if (snap.empty) { setFriendSearchMsg(t.friendNotFound); return; }
                const friendDoc = snap.docs[0];
                const friendUid = friendDoc.id;
                if (userData.friends?.includes(friendUid)) { setFriendSearchMsg("Already friends!"); return; }
                if (userData.friendRequests?.includes(friendUid)) { setFriendSearchMsg("Request already pending!"); return; }
                await usersCollection.doc(friendUid).update({ friendRequests: firebase.firestore.FieldValue.arrayUnion(user.uid) });
                setFriendSearchMsg(t.requestSent);
                setAddFriendId('');
            };
            
            const handleAcceptRequest = async (fromUid) => {
                await usersCollection.doc(user.uid).update({
                    friends: firebase.firestore.FieldValue.arrayUnion(fromUid),
                    friendRequests: firebase.firestore.FieldValue.arrayRemove(fromUid)
                });
                await usersCollection.doc(fromUid).update({ friends: firebase.firestore.FieldValue.arrayUnion(user.uid) });
            };
            
            const handleRejectRequest = async (fromUid) => {
                await usersCollection.doc(user.uid).update({ friendRequests: firebase.firestore.FieldValue.arrayRemove(fromUid) });
            };

            // Render Helpers
            const isMyTurn = room?.currentTurnUID === user?.uid;
            const me = room?.players?.find(p => p.uid === user?.uid);
            const myRole = me?.role;
            const isSpectator = me?.status === 'spectator' || me?.status === 'ghost';
            const hasVoted = room?.votes?.[user?.uid];
            const hasVotedWord = room?.wordVotes?.[user?.uid];
            const activePlayersCount = room?.players?.filter(p => p.status === 'active').length || 0;
            const voteReq = room?.votingRequest;
            const hasIAgreed = voteReq?.votes?.[user?.uid] === true;
            const hasIDeclined = voteReq?.votes?.[user?.uid] === false;

            // Friend Sort
            const sortedFriends = React.useMemo(() => {
                if (!friendsData) return [];
                const sorted = [...friendsData].sort((a, b) => {
                    const chatA = chatsMeta[getChatId(user?.uid, a.uid)];
                    const chatB = chatsMeta[getChatId(user?.uid, b.uid)];
                    const timeA = chatA?.timestamp?.toMillis() || 0;
                    const timeB = chatB?.timestamp?.toMillis() || 0;
                    return timeB - timeA;
                });
                return sorted;
            }, [friendsData, chatsMeta, user?.uid]);

            return (
                <div className="min-h-screen flex flex-col items-center p-4 md:p-6" dir={lang === 'ar' ? 'rtl' : 'ltr'}>
                    
                    {alertMessage && (
                        <div className="alert-modal" onClick={() => setAlertMessage(null)}>
                            <div className="glass-panel rounded-2xl p-6 w-full max-w-sm animate-pop text-center border border-pink-500" onClick={e => e.stopPropagation()}>
                                <div className="text-4xl mb-4">üö´</div>
                                <p className="text-lg font-bold mb-4">{alertMessage}</p>
                                <button onClick={() => setAlertMessage(null)} className="btn-ghost px-6 py-2 rounded-lg border border-white/20">{t.ok}</button>
                            </div>
                        </div>
                    )}

                    {/* Setup Modal */}
                    {showSetupModal && (
                         <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4" onClick={()=>setShowSetupModal(false)}>
                            <div className="glass-panel rounded-2xl p-6 w-full max-w-md animate-pop" onClick={e => e.stopPropagation()}>
                                <h2 className="text-xl font-bold text-primary mb-4">{t.create}</h2>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-xs text-gray-400 block mb-1">{t.nickname}</label>
                                        <input 
                                            className={`${isLoggedIn ? 'input-locked' : 'input-dark'} w-full p-3 rounded-lg font-bold`}
                                            value={nickname} 
                                            onChange={e => { setNickname(e.target.value); localStorage.setItem('pro_spy_nick', e.target.value); }}
                                            disabled={isLoggedIn}
                                        />
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-2">
                                        <button onClick={() => setSetupMode('normal')} className={`p-3 rounded-lg border-2 ${setupMode === 'normal' ? 'border-cyan-400 bg-cyan-500/10' : 'border-white/10'}`}>
                                            <div className="font-bold">{t.normalMode}</div>
                                            <div className="text-[10px] text-gray-400">{t.modeNormalDesc}</div>
                                        </button>
                                        <button onClick={() => setSetupMode('advanced')} className={`p-3 rounded-lg border-2 ${setupMode === 'advanced' ? 'border-purple-400 bg-purple-500/10' : 'border-white/10'}`}>
                                            <div className="font-bold">{t.advancedMode}</div>
                                            <div className="text-[10px] text-gray-400">{t.modeAdvDesc}</div>
                                        </button>
                                    </div>
                                    
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" id="privateCheck" checked={isPrivate} onChange={(e) => setIsPrivate(e.target.checked)} className="w-4 h-4"/>
                                        <label htmlFor="privateCheck" className="text-sm">{t.privateRoom}</label>
                                    </div>
                                    
                                    {isPrivate && (
                                        <input className="input-dark w-full p-2 rounded" placeholder={t.password} value={password} onChange={e => setPassword(e.target.value)} />
                                    )}
                                    
                                    <button onClick={handleCreateGame} disabled={loading || !nickname} className="btn-neon w-full py-3 rounded-lg font-bold">{loading ? t.loading : t.create}</button>
                                </div>
                            </div>
                         </div>
                    )}

                    <MyAccountPage show={showMyAccount} onClose={() => setShowMyAccount(false)} userData={userData} user={user} lang={lang} onUpdate={async () => { if(user){ const d = await usersCollection.doc(user.uid).get(); setUserData(d.data()); }}}
                    />
                    <UserProfileModal show={showUserProfile} onClose={() => setShowUserProfile(false)} targetUID={targetProfileUID} lang={lang} onAddFriend={handleSendRequest} isFriend={userData?.friends?.includes(targetProfileUID)} currentUserData={userData} />
                    <PrivateChatModal show={showChat} onClose={closeChat} friendData={chatFriend} currentUser={userData} lang={lang} roomId={roomId} onJoinInvite={handleJoinFromInvite} />
                    <LobbyBrowserModal show={showLobby} onClose={() => setShowLobby(false)} lang={lang} onJoinRoom={(id, pwd) => handleJoinGame(id, pwd)} />

                    {room?.status === 'discussing' && voteReq && (
                         <div className="vote-request-banner glass-panel rounded-xl p-4 border-2 border-pink-500 animate-pop">
                            <div className="flex flex-col gap-2">
                                <div className="text-center font-bold text-pink-400">{t.voteRequestTitle}</div>
                                <div className="text-center text-xs text-gray-300">
                                    <span className="font-bold">{room.players.find(p=>p.uid === voteReq.requestedBy)?.name}</span> {t.voteRequestDesc}
                                </div>
                                <div className="flex justify-center gap-2 mt-2">
                                    <button onClick={agreeToVote} disabled={hasIAgreed} className={`btn px-6 py-2 rounded-lg text-xs font-bold ${hasIAgreed ? 'btn-ghost opacity-50' : 'btn-success'}`}>{t.agree}</button>
                                    <button onClick={declineVote} disabled={hasIDeclined} className={`btn px-6 py-2 rounded-lg text-xs font-bold ${hasIDeclined ? 'btn-ghost opacity-50' : 'btn-danger'}`}>{t.decline}</button>
                                </div>
                            </div>
                         </div>
                    )}

                    {/* Header */}
                    <header className="w-full max-w-4xl flex justify-between items-center mb-4 animate-fade-in relative z-50">
                        <div className="flex items-center gap-3">
                            <div className="logo-container">
                                <div className="logo-border"></div>
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" strokeWidth="2">
                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                </svg>
                            </div>
                            <div>
                                <h1 className="game-title text-2xl">{t.appName}</h1>
                                <p className="text-[10px] text-gray-500 tracking-widest font-tech">{t.tagline}</p>
                            </div>
                        </div>
                        
                        <nav className="hidden md:flex gap-1 glass-panel rounded-full p-1 items-center">
                            <button onClick={() => setActiveView('lobby')} className={`nav-tab rounded-full text-xs ${activeView === 'lobby' ? 'active' : ''}`}>{t.tabLobby}</button>
                            <button onClick={() => setActiveView('leaderboard')} className={`nav-tab rounded-full text-xs ${activeView === 'leaderboard' ? 'active' : ''}`}>{t.tabLeaderboard}</button>
                            <button onClick={() => setActiveView('friends')} className={`nav-tab rounded-full text-xs relative ${activeView === 'friends' ? 'active' : ''}`}>
                                {t.tabFriends}
                                {totalUnread > 0 && <span className="notification-badge">{totalUnread}</span>}
                            </button>
                        </nav>

                        <div className="flex gap-2 items-center">
                             <a href="https://guessmycard.mooo.info/" target="_blank" rel="noopener noreferrer" className="btn-ghost px-3 py-1 rounded text-xs font-bold border-gray-700 hover:text-pink-400 hover:border-pink-400">{t.linkGuessCard}</a>
                            <button onClick={() => setLang(lang === 'en' ? 'ar' : 'en')} className="btn-ghost px-4 py-1 rounded text-xs font-bold border-gray-700">{t.langBtn}</button>
                            
                            <div className="relative">
                                {isLoggedIn ? (
                                    <>
                                        <button onClick={() => setShowDropdown(!showDropdown)} className="flex items-center gap-2 btn-ghost px-3 py-1 rounded-full border-gray-700">
                                            <img src={userData?.photoURL || `https://ui-avatars.com/api/?name=${userData?.displayName}`} className="w-6 h-6 rounded-full" alt=""/>
                                            <span className="text-xs font-bold hidden md:block">{t.myAccount}</span>
                                        </button>
                                        {showDropdown && (
                                            <div className="dropdown-menu glass-panel rounded-lg py-2 animate-fade-in">
                                                <button onClick={() => { setShowMyAccount(true); setShowDropdown(false); }} className="w-full text-right px-4 py-2 text-sm hover:bg-white/10">{t.profile}</button>
                                                <button onClick={handleLogout} className="w-full text-right px-4 py-2 text-sm text-red-400 hover:bg-white/10">{t.logout}</button>
                                            </div>
                                        )}
                                    </>
                                ) : (
                                    <button onClick={handleGoogleLogin} className="btn-google px-4 py-1 rounded-full text-xs font-bold flex items-center gap-2">
                                        <svg className="w-4 h-4" viewBox="0 0 21 20" fill="none"><path d="M20.3087 10.2242C20.3087 9.46273 20.2446 8.74991 20.1273 8.08594H10.5V11.9392H15.9715C15.7353 13.1916 15.0216 14.2518 13.9444 14.9582V17.4635H17.2543C19.1883 15.7262 20.3087 13.1977 20.3087 10.2242Z" fill="#4285F4"/><path d="M10.5 19.875C13.1617 19.875 15.3983 18.9749 17.2545 17.4636L13.9446 14.9582C12.9389 15.6222 11.7015 16.0092 10.5 16.0092C7.93332 16.0092 5.72548 14.2615 4.93682 11.9136H1.51758V14.4934C3.3629 18.0879 7.13889 19.875 10.5 19.875Z" fill="#34A853"/><path d="M4.93672 11.9136C4.73672 11.2496 4.62266 10.5469 4.62266 9.82357C4.62266 9.10026 4.73672 8.39751 4.93672 7.73354V5.15375H1.51748C0.774766 6.61518 0.351562 8.20361 0.351562 9.82357C0.351562 11.4435 0.774766 13.0319 1.51748 14.4934L4.93672 11.9136Z" fill="#FBBC05"/><path d="M10.5 3.63864C11.8379 3.63864 13.0392 4.09256 13.9864 4.98477L17.3199 1.65131C15.3941 -0.131629 13.1575 -0.124985 10.5 -0.124985C7.13889 -0.124985 3.3629 1.66216 1.51758 5.25668L4.93682 7.83647C5.72548 5.48861 7.93332 3.63864 10.5 3.63864Z" fill="#EA4335"/></svg>
                                        {t.loginGoogle}
                                    </button>
                                )}
                            </div>
                        </div>
                    </header>

                    <nav className="md:hidden w-full max-w-4xl flex justify-around glass-panel rounded-xl p-1 mb-4">
                         <button onClick={() => setActiveView('lobby')} className={`nav-tab flex-1 text-center ${activeView === 'lobby' ? 'active' : ''}`}>{t.tabLobby}</button>
                         <button onClick={() => setActiveView('leaderboard')} className={`nav-tab flex-1 text-center ${activeView === 'leaderboard' ? 'active' : ''}`}>{t.tabLeaderboard}</button>
                         <button onClick={() => setActiveView('friends')} className={`nav-tab flex-1 text-center relative ${activeView === 'friends' ? 'active' : ''}`}>
                            {t.tabFriends}
                            {totalUnread > 0 && <span className="notification-badge">{totalUnread}</span>}
                         </button>
                    </nav>

                    <main className="w-full max-w-4xl grid grid-cols-1 md:grid-cols-3 gap-4">
                        
                        {activeView === 'leaderboard' && (
                            <div className="md:col-span-3 glass-panel rounded-2xl p-6 animate-fade-in overflow-x-auto">
                                <h2 className="text-xl font-bold mb-4 text-primary">{t.tabLeaderboard}</h2>
                                <div className="min-w-[600px]">
                                    <div className="leaderboard-row border-b border-white/20 font-bold text-xs text-gray-400">
                                        <div className="w-16">{t.rank}</div>
                                        <div className="flex-1">{t.name}</div>
                                        <div className="w-16 text-center">{t.level}</div>
                                        <div className="w-20 text-center">{t.wins}</div>
                                        <div className="w-20 text-center">{t.losses}</div>
                                    </div>
                                    {leaderboardData.map((p, i) => (
                                        <div key={p.uid} onClick={() => openProfile(p.uid)} className={`leaderboard-row cursor-pointer ${p.uid === user?.uid ? 'bg-cyan-500/10' : ''}`}>
                                            <div className="w-16 font-bold text-lg">#{i + 1}</div>
                                            <div className="flex-1 flex items-center gap-2">
                                                <img src={p.photoURL} className="w-6 h-6 rounded-full"/>
                                                <span>{p.displayName}</span>
                                                {p.uid === user?.uid && <span className="text-[8px] bg-blue-500 px-1 rounded">{t.you}</span>}
                                            </div>
                                            <div className="w-16 text-center">{calculateLevel(p.stats?.xp)}</div>
                                            <div className="w-20 text-center text-green-400">{p.stats?.wins || 0}</div>
                                            <div className="w-20 text-center text-red-400">{p.stats?.losses || 0}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeView === 'friends' && (
                            <div className="md:col-span-3 glass-panel rounded-2xl p-6 animate-fade-in space-y-6">
                                <h2 className="text-xl font-bold text-primary">{t.tabFriends}</h2>
                                {isGuest ? (<div className="text-center py-10"><p className="text-gray-400 mb-4">{t.noPermission}</p></div>) : (
                                    <>
                                        <div className="flex gap-2">
                                            <input className="input-dark flex-1 p-2 rounded text-sm" placeholder={t.friendIdPlaceholder} value={addFriendId} onChange={e => setAddFriendId(e.target.value)} />
                                            <button onClick={handleSendRequest} className="btn-neon px-4 rounded text-sm">{t.addFriend}</button>
                                        </div>
                                        {friendSearchMsg && <div className="text-xs text-center text-cyan-400">{friendSearchMsg}</div>}
                                        {friendRequests.length > 0 && (
                                            <div className="border-t border-white/10 pt-4">
                                                <h3 className="text-sm font-bold text-gray-400 mb-2">{t.incomingRequests}</h3>
                                                <div className="space-y-2">
                                                    {friendRequests.map(f => (
                                                        <div key={f.uid} className="flex items-center justify-between p-2 bg-white/5 rounded">
                                                            <div className="flex items-center gap-2">
                                                                <img src={f.photoURL} className="w-8 h-8 rounded-full"/>
                                                                <span>{f.displayName}</span>
                                                            </div>
                                                            <div className="flex gap-2">
                                                                <button onClick={() => handleAcceptRequest(f.uid)} className="btn-success px-3 py-1 rounded text-xs">{t.accept}</button>
                                                                <button onClick={() => handleRejectRequest(f.uid)} className="btn-danger px-3 py-1 rounded text-xs">{t.reject}</button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        <div className="border-t border-white/10 pt-4">
                                            <h3 className="text-sm font-bold text-gray-400 mb-2">{t.tabFriends}</h3>
                                            <div className="space-y-2">
                                                {sortedFriends.length === 0 && <p className="text-center text-gray-500 text-sm py-4">{t.noFriends}</p>}
                                                {sortedFriends.map(f => {
                                                    const isOnline = f.lastActive && (Date.now() - f.lastActive.toMillis() < 120000);
                                                    const chatId = getChatId(user?.uid, f.uid);
                                                    const meta = chatsMeta[chatId];
                                                    const unread = meta?.unread?.[user?.uid] || 0;
                                                    const lastMsg = meta?.lastMessage;
                                                    return (
                                                        <div key={f.uid} className="player-card flex items-center justify-between p-3">
                                                            <div className="flex items-center gap-2 cursor-pointer relative" onClick={() => openProfile(f.uid)}>
                                                                <div className="relative">
                                                                    <img src={f.photoURL} className="w-10 h-10 rounded-full"/>
                                                                    {unread > 0 && <span className="friend-unread-badge">{unread}</span>}
                                                                </div>
                                                                <div>
                                                                    <div className="font-bold">{f.displayName}</div>
                                                                    <div className="text-xs text-gray-400">{lastMsg ? (lastMsg.length > 20 ? lastMsg.substring(0,20)+'...' : lastMsg) : `Lvl ${calculateLevel(f.stats?.xp)}`}</div>
                                                                </div>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <span className={`${isOnline ? 'status-online' : 'status-offline'}`}></span>
                                                                <span className="text-xs mr-2">{isOnline ? t.online : t.offline}</span>
                                                                <button onClick={() => openChat(f)} className="btn-ghost px-3 py-1 rounded text-xs border-blue-500 text-blue-400">Chat</button>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>
                        )}

                        {activeView === 'lobby' && (
                            <>
                                {room && (
                                    <div className="md:col-span-3 flex justify-end mb-2">
                                        <button onClick={() => setActiveView('friends')} className="btn-ghost px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2 relative">
                                            <span>üë•</span> {t.inviteFriends}
                                            {totalUnread > 0 && <span className="notification-badge">{totalUnread}</span>}
                                        </button>
                                    </div>
                                )}

                                {room && (
                                    <div className="glass-panel rounded-2xl p-4 space-y-2 animate-fade-in delay-1">
                                        <h3 className="text-xs font-bold text-gray-400 mb-2 border-b border-gray-800 pb-2 uppercase tracking-wider flex justify-between items-center">
                                            <span>{t.players}</span>
                                            <span className="text-[9px] bg-white/5 px-2 py-0.5 rounded text-cyan-400">{t.roundsFormat(room.currentRound || 1, MAX_ROUNDS)}</span>
                                        </h3>
                                        <div className="space-y-2">
                                            {room.players.map((p, i) => {
                                                const roleIcon = p.role === 'mrwhite' ? '‚ö™' : p.role === 'informant' ? 'üõà' : p.role === 'spy' ? 'üïµÔ∏è' : '';
                                                return (
                                                <div key={i} onClick={() => openProfile(p.uid)} className={`player-card relative p-2 rounded-lg flex items-center justify-between ${p.status === 'ghost' ? 'ghost' : p.status === 'spectator' ? 'eliminated' : ''}`}>
                                                    <div className="flex items-center gap-2 flex-1">
                                                        <img src={p.photo || `https://ui-avatars.com/api/?name=${p.name}`} className="w-6 h-6 rounded-full" alt=""/>
                                                        <span className="font-bold text-sm truncate">{p.name}</span>
                                                        <span className="text-[10px]">{roleIcon}</span>
                                                        {p.uid === user?.uid && <span className="text-[8px] bg-blue-500 px-1 rounded">{t.you}</span>}
                                                    </div>
                                                    {p.uid === room.currentTurnUID && room.status === 'discussing' && (
                                                        <div className="flex items-center gap-1 ml-2">
                                                            <div className="timer-bar-container"><div className="timer-bar-fill" style={{width: `${(turnTimer/30)*100}%`}}></div></div>
                                                            <span className="text-[10px] font-mono text-cyan-400 w-6 text-right">{turnTimer}</span>
                                                        </div>
                                                    )}
                                                </div>
                                            )})}
                                        </div>
                                        {!isSpectator && room.status === 'discussing' && <button onClick={requestVoting} className="btn-vote w-full py-2 rounded-lg font-bold text-xs mt-4 uppercase tracking-wide">{t.startVoting}</button>}
                                    </div>
                                )}

                                <div className={`${room ? 'md:col-span-2' : 'md:col-span-3'} space-y-4`}>
                                    
                                    {!room && (
                                        <div className="glass-panel rounded-2xl p-8 text-center space-y-6 animate-fade-in mx-auto max-w-md w-full">
                                            <div className="space-y-2">
                                                <label className="text-xs text-gray-400 uppercase">{t.nickname}</label>
                                                <input className={`${isLoggedIn ? 'input-locked' : 'input-dark'} w-full p-3 rounded-lg text-center font-bold`} value={nickname} onChange={e => { setNickname(e.target.value); localStorage.setItem('pro_spy_nick', e.target.value); }} disabled={isLoggedIn} />
                                            </div>
                                            <button onClick={() => setShowSetupModal(true)} disabled={loading || !nickname} className="btn-neon w-full py-3 rounded-lg font-bold">{t.create}</button>
                                            <div className="flex flex-col gap-2">
                                                <div className="flex gap-2">
                                                    <input className="input-dark flex-1 p-3 rounded-lg text-center font-mono uppercase" placeholder={t.codePlaceholder} value={inputCode} onChange={e => setInputCode(e.target.value)} />
                                                    <button onClick={() => handleJoinGame(inputCode, null)} disabled={loading || !nickname} className="btn-ghost px-6 rounded-lg font-bold">{t.join}</button>
                                                </div>
                                                <button onClick={() => setShowLobby(true)} className="btn-gold w-full py-2 rounded-lg text-xs font-bold">{t.browse}</button>
                                                {joinError && <div className="error-msg">{joinError}</div>}
                                            </div>
                                        </div>
                                    )}

                                    {room && (
                                        <>
                                            <div className="glass-panel rounded-xl p-3 flex justify-between items-center">
                                                <div className="flex items-center gap-2">
                                                    <span className="font-mono font-bold text-lg tracking-widest text-cyan-400">{room.id}</span>
                                                    <span className={`text-[10px] px-2 py-1 rounded ${room.mode === 'advanced' ? 'bg-purple-500/20 text-purple-300' : 'bg-blue-500/20 text-blue-300'}`}>{room.mode === 'advanced' ? t.advancedMode : t.normalMode}</span>
                                                    {room.isPrivate && <span className="text-[10px] bg-yellow-500/20 text-yellow-300">üîí</span>}
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    <span className="text-xs font-bold bg-white/10 px-2 py-1 rounded text-cyan-400">
                                                        {room.status === 'word_selection' ? 'KEYWORD' : room.status === 'discussing' ? 'DISCUSSION' : room.status.toUpperCase()}
                                                    </span>
                                                </div>
                                            </div>

                                            {room.status === 'waiting' && (
                                                <div className="glass-panel rounded-2xl p-6 text-center animate-fade-in">
                                                    <div className="animate-pulse text-gray-400 text-sm mb-4">{t.waiting}</div>
                                                    {room.admin === user?.uid && (<button onClick={startGame} className="btn-neon w-full py-3 rounded-lg font-bold">{t.start}</button>)}
                                                </div>
                                            )}

                                            {(room.status === 'finished_spy_caught' || room.status === 'finished_spy_wins' || room.status === 'finished_mrwhite_wins') && (
                                                <div className="glass-panel rounded-2xl p-8 text-center animate-fade-in border border-purple-500">
                                                    <h2 className="text-3xl font-black mb-4 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">
                                                        {room.status === 'finished_mrwhite_wins' ? t.mrWhiteWin : (room.status === 'finished_spy_caught' ? t.agentsWin : t.spyWin)}
                                                    </h2>
                                                    <p className="text-gray-400 mb-6">The Spy was: <span className="text-white font-bold">{room.players.find(p => p.role === 'spy')?.name}</span></p>
                                                    {room.admin === user?.uid && (<button onClick={resetGame} className="btn-ghost border-white/20 text-white w-full py-3 rounded-lg">{t.playAgain}</button>)}
                                                </div>
                                            )}

                                            {room.status === 'word_selection' && (
                                                <div className="space-y-4 animate-fade-in">
                                                    <div className="glass-panel rounded-2xl p-6 text-center relative overflow-hidden border border-cyan-500/30">
                                                        <div className="absolute top-4 right-4 w-12 h-12">
                                                            <svg className="w-full h-full transform -rotate-90" viewBox="0 0 36 36">
                                                                <circle cx="18" cy="18" r="16" fill="none" stroke="rgba(255,255,255,0.1)" strokeWidth="3"></circle>
                                                                <circle cx="18" cy="18" r="16" fill="none" stroke="#00f2ff" strokeWidth="3" strokeDasharray={`${(wordSelTimer/30)*100} ${100-((wordSelTimer/30)*100)}`} strokeLinecap="round"></circle>
                                                            </svg>
                                                            <div className="absolute inset-0 flex items-center justify-center text-sm font-bold text-cyan-400">{wordSelTimer}</div>
                                                        </div>
                                                        <h3 className="text-xl font-black mb-2 uppercase text-cyan-400">{t.wordSelectionTitle}</h3>
                                                        <p className="text-xs text-gray-500 mb-6">{t.wordSelectionDesc}</p>
                                                        <div className="grid grid-cols-2 gap-4">
                                                            {(() => {
                                                                const wordsToDisplay = myRole === 'spy' || myRole === 'mrwhite' ? ['?', '?', '?', '?'] : (lang === 'ar' ? room.scenario?.words_ar : room.scenario?.words_en);
                                                                return wordsToDisplay?.map((word, i) => {
                                                                    const voters = Object.entries(room.wordVotes || {}).filter(([uid, w]) => w === word).map(([uid]) => room.players.find(p => p.uid === uid)?.name);
                                                                    return (
                                                                        <button key={i} onClick={() => submitWordVote(word)} disabled={myRole === 'spy' || myRole === 'mrwhite'} className={`word-vote-card p-6 rounded-xl font-bold text-lg transition-all ${hasVotedWord === word ? 'selected' : 'bg-white/5 border border-white/10'} ${(myRole === 'spy' || myRole === 'mrwhite') ? 'opacity-50 cursor-not-allowed' : ''}`}>
                                                                            {word}
                                                                            {voters.length > 0 && (<div className="flex justify-center gap-1 mt-2 flex-wrap">{voters.map(v => <span key={v} className="voter-name relative">{v}</span>)}</div>)}
                                                                        </button>
                                                                    );
                                                                });
                                                            })()}
                                                        </div>
                                                        {room.admin === user?.uid && myRole !== 'spy' && myRole !== 'mrwhite' && (<button onClick={() => finishWordSelection(false)} className="btn-neon w-full py-3 rounded-lg font-bold mt-6">{t.finishSelection}</button>)}
                                                    </div>
                                                    
                                                    {/* Identity Card */}
                                                    <div className={`identity-square glass-panel ${myRole === 'spy' ? 'identity-spy' : myRole === 'informant' ? 'identity-informant' : myRole === 'mrwhite' ? 'identity-mrwhite' : 'identity-agent'}`}>
                                                        <div className="relative z-10 p-6 flex flex-col items-center justify-center h-full">
                                                            <span className={`text-[10px] font-bold uppercase tracking-widest mb-2 px-3 py-1 rounded-full ${
                                                                myRole === 'spy' ? 'bg-red-500/20 text-red-400' : 
                                                                myRole === 'informant' ? 'bg-blue-500/20 text-blue-400' : 
                                                                myRole === 'mrwhite' ? 'bg-yellow-500/20 text-yellow-400' : 'bg-green-500/20 text-green-400'
                                                            }`}>
                                                                {t[`status${myRole?.charAt(0).toUpperCase() + myRole?.slice(1) || 'Agent'}`]}
                                                            </span>
                                                            
                                                            {myRole === 'spy' && (<><div className="text-5xl mb-2">üïµÔ∏è</div><h3 className="text-3xl font-black tracking-wider text-red-500">???</h3></> )}
                                                            {myRole === 'mrwhite' && (<><div className="text-5xl mb-2">‚ö™</div><p className="text-xs text-gray-300">{t.mrWhiteInstruction}</p></>)}
                                                            {myRole === 'informant' && (
                                                                <>
                                                                    <div className="text-2xl font-bold mt-2">{lang === 'ar' ? room.scenario?.loc_ar : room.scenario?.loc_en}</div>
                                                                    <p className="text-xs text-blue-300 mt-2">{t.informantInstruction}</p>
                                                                </>
                                                            )}
                                                            {myRole === 'agent' && (<><div className="text-3xl font-black mt-2 text-center px-2">{lang === 'ar' ? room.scenario?.loc_ar : room.scenario?.loc_en}</div><p className="text-xs text-gray-400 mt-2">{t.location}</p></>)}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Mr. White Guess Button */}
                                                    {myRole === 'mrwhite' && (
                                                        <div className="mt-4">
                                                            <button onClick={() => {
                                                                const guess = prompt("Guess the location:");
                                                                if(guess) handleMrWhiteGuess(guess);
                                                            }} className="btn-gold w-full py-3 rounded-lg font-bold">{t.guessLocation}</button>
                                                        </div>
                                                    )}
                                                </div>
                                            )}

                                            {room.status === 'discussing' && (
                                                <div className="space-y-4 animate-fade-in">
                                                    {room.chosenWord && (<div className="glass-panel rounded-xl p-3 text-center border border-cyan-500/50"><span className="text-[10px] text-cyan-400 font-bold uppercase">{t.selectedWord}:</span><span className="ml-2 text-lg font-bold text-white">{room.chosenWord}</span></div>)}
                                                    
                                                    {/* Agent/Informant Identity */}
                                                     <div className={`identity-square glass-panel ${myRole === 'spy' ? 'identity-spy' : myRole === 'informant' ? 'identity-informant' : myRole === 'mrwhite' ? 'identity-mrwhite' : 'identity-agent'}`}>
                                                        <div className="relative z-10 p-6 flex flex-col items-center justify-center h-full">
                                                            <span className={`text-[10px] font-bold uppercase tracking-widest mb-2 px-3 py-1 rounded-full ${
                                                                myRole === 'spy' ? 'bg-red-500/20 text-red-400' : 
                                                                myRole === 'informant' ? 'bg-blue-500/20 text-blue-400' : 
                                                                myRole === 'mrwhite' ? 'bg-yellow-500/20 text-yellow-400' : 'bg-green-500/20 text-green-400'
                                                            }`}>
                                                                {t[`status${myRole?.charAt(0).toUpperCase() + myRole?.slice(1) || 'Agent'}`]}
                                                            </span>
                                                            {myRole === 'spy' ? ( <><div className="text-5xl mb-2">üïµÔ∏è</div><h3 className="text-3xl font-black tracking-wider text-red-500">???</h3></> ) : ( <><div className="text-4xl font-black mt-2 text-center px-2">{lang === 'ar' ? room.scenario?.loc_ar : room.scenario?.loc_en}</div><p className="text-xs text-gray-400 mt-2">{t.location}</p></> )}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Mr. White Guess Button */}
                                                    {myRole === 'mrwhite' && (
                                                        <button onClick={() => {
                                                            const guess = prompt("Guess the location:");
                                                            if(guess) handleMrWhiteGuess(guess);
                                                        }} className="btn-gold w-full py-3 rounded-lg font-bold">{t.guessLocation}</button>
                                                    )}

                                                    <div className="glass-panel rounded-2xl p-4 flex flex-col overflow-hidden relative">
                                                        <div className="flex-1 overflow-y-auto p-2 space-y-2 h-48 relative z-10">
                                                            {room.messages?.slice(-20).map((m, i) => (
                                                                <GameChatMessage key={i} msg={m} currentUser={user} players={room.players} onAvatarClick={openProfile} />
                                                            ))}
                                                        </div>
                                                        
                                                        {/* Ghosts can't chat */}
                                                        {!isSpectator && isMyTurn ? (
                                                            <div className="flex flex-col gap-2 mt-auto border-t border-white/10 pt-3 relative z-10">
                                                                <div className="flex gap-1 mb-1">{EMOJI_LIST.slice(0, 10).map(emoji => (<span key={emoji} onClick={() => sendMessage(emoji)} className="emoji-btn">{emoji}</span>))}</div>
                                                                <form onSubmit={(e) => { e.preventDefault(); sendMessage(chatMsg); }} className="flex gap-2">
                                                                    <input className="input-dark flex-1 p-3 rounded-xl text-sm" placeholder={t.chatPlaceholder} value={chatMsg} onChange={e => setChatMsg(e.target.value)} />
                                                                    <button type="submit" className="btn-neon px-5 rounded-xl text-xs">{t.send}</button>
                                                                    <button type="button" onClick={() => handleSkipTurn(false)} className="btn-ghost px-4 rounded-xl text-xs border-orange-500 text-orange-400">{t.skip}</button>
                                                                </form>
                                                            </div>
                                                        ) : (<div className="text-center text-xs text-gray-600 py-3 border-t border-white/10 mt-2">{me?.status === 'ghost' ? t.ghostInstruction : (isSpectator ? t.spectator : "Waiting for turn...")}</div>)}
                                                    </div>
                                                </div>
                                            )}

                                            {room.status === 'voting' && (
                                                <div className="glass-panel rounded-2xl p-6 animate-fade-in space-y-4">
                                                    <div className="flex justify-between items-center">
                                                        <h3 className="text-lg font-bold text-yellow-400">{t.vote}</h3>
                                                        <div className="relative w-10 h-10">
                                                            <svg className="w-full h-full transform -rotate-90" viewBox="0 0 36 36">
                                                                <circle cx="18" cy="18" r="16" fill="none" stroke="rgba(255,255,255,0.1)" strokeWidth="3"></circle>
                                                                <circle cx="18" cy="18" r="16" fill="none" stroke="#ff0055" strokeWidth="3" strokeDasharray={`${(votingTimer/30)*100} ${100-((votingTimer/30)*100)}`} strokeLinecap="round"></circle>
                                                            </svg>
                                                            <div className="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-yellow-400">{votingTimer}</div>
                                                        </div>
                                                    </div>
                                                    <div className="bg-black/20 p-3 rounded-lg text-xs space-y-1 mb-2 border border-white/5">
                                                        <span className="text-gray-500 font-bold">{t.votesTitle}</span>
                                                        <div className="flex flex-wrap gap-2 mt-1">
                                                            {Object.entries(room.votes || {}).map(([uid, target]) => {
                                                                const voter = room.players.find(p => p.uid === uid);
                                                                const targetName = room.players.find(p => p.uid === target)?.name;
                                                                return (<span key={uid} className="bg-white/5 px-2 py-1 rounded">{voter?.name}: <span className="text-cyan-400">{targetName}</span></span>);
                                                            })}
                                                        </div>
                                                    </div>
                                                    {!hasVoted ? (
                                                        <div className="grid grid-cols-2 gap-3">
                                                            {room.players.filter(p => p.status === 'active').map(p => (
                                                                <button key={p.uid} onClick={() => submitVote(p.uid)} className="p-4 rounded-xl border text-sm font-bold transition-all bg-white/5 border-white/10 hover:border-pink-400 hover:bg-pink-500/10">{p.name}</button>
                                                            ))}
                                                        </div>
                                                    ) : (<div className="text-center space-y-4 py-4"><div className="text-green-400 font-bold">{t.confirm}</div></div>)}
                                                    {room.admin === user?.uid && (<button onClick={endVotingNow} className="btn-danger w-full py-2 rounded-lg font-bold text-xs uppercase mt-2">{t.endVoting}</button>)}
                                                </div>
                                            )}
                                        </>
                                    )}
                                </div>
                            </>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
