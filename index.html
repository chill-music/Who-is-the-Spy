<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Who is the Spy? - ŸÖŸÜ ŸáŸà ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap');
        body { font-family: 'Noto Sans Arabic', sans-serif; background-color: #020617; }
        /* ÿ∂ŸÖÿßŸÜ ÿπÿØŸÖ ÿ∏ŸáŸàÿ± ÿßŸÑŸÉŸàÿØ ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ */
        [script-type="text/babel"] { display: none; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">
    <div id="root">
        <!-- ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ÿ≥Ÿäÿ∑ÿ© ÿ™ÿ∏Ÿáÿ± ÿ≠ÿ™Ÿâ Ÿäÿ¥ÿ™ÿ∫ŸÑ ÿ±Ÿäÿ£ŸÉÿ™ -->
        <div class="flex items-center justify-center h-screen">
            <div class="text-xl font-bold animate-pulse text-blue-500">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÑÿπÿ®ÿ©...</div>
        </div>
    </div>

    <!-- ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ text/babel ŸÑÿ∂ŸÖÿßŸÜ ŸÇŸäÿßŸÖ ŸÖŸÉÿ™ÿ®ÿ© Babel ÿ®ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑŸÉŸàÿØ -->
    <script type="text/babel">
        // ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ Firebase ŸÖŸÜ ÿÆŸÑÿßŸÑ CDN ŸÖÿ™ŸàÿßŸÅŸÇ ŸÖÿπ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ÿßÿ™
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        const { useState, useEffect } = React;

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyApAJaNfF0YHupunLRlK3jRYvttxczWShY",
            authDomain: "who-is-the-spy-919b9.firebaseapp.com",
            projectId: "who-is-the-spy-919b9",
            storageBucket: "who-is-the-spy-919b9.firebasestorage.app",
            messagingSenderId: "607075438373",
            appId: "1:607075438373:web:a03e9fb8b243cd993e14cc",
            measurementId: "G-6FVJR2VXN3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'spy-game-919b9';

        const translations = {
            en: {
                title: "Who is the Spy?", subtitle: "A game of wits and deception", joinRoom: "Join an existing room",
                roomCodePlaceholder: "Room Code", or: "OR", createRoom: "Create New Room", roomCode: "Room Code",
                players: "Players", playerList: "Player List", waiting: "Waiting for more players...",
                waitingAdmin: "Waiting for admin to start...", startBtn: "Start Game Now", spyTitle: "You are the Spy!",
                spyDesc: "Try to guess the word without being caught.", spyMission: "Mission: Stay mysterious",
                citizenTitle: "You are a Citizen", locationIs: "The location is:", secretWord: "Secret word:",
                instructions: "Instructions:", instr1: "Talk about the location without naming it.",
                instr2: "The spy tries to blend in.", instr3: "Citizens win by identifying the spy.",
                newRound: "New Round", playerId: "Player ID", errorJoin: "Room not found",
                errorStart: "Need at least 3 players to start", loading: "Connecting to Server...",
            },
            ar: {
                title: "ŸÖŸÜ ŸáŸà ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ÿü", subtitle: "ŸÑÿπÿ®ÿ© ÿßŸÑÿ∞ŸÉÿßÿ° ŸàÿßŸÑÿ™ŸÖŸàŸäŸá ÿßŸÑÿ¨ŸÖÿßÿπŸäÿ©", joinRoom: "ÿßŸÜÿ∂ŸÖ ŸÑÿ∫ÿ±ŸÅÿ© ŸÖŸàÿ¨ŸàÿØÿ©",
                roomCodePlaceholder: "ÿ±ŸÖÿ≤ ÿßŸÑÿ∫ÿ±ŸÅÿ©", or: "ÿ£Ÿà", createRoom: "ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ© ÿ¨ÿØŸäÿØÿ©", roomCode: "ÿ±ŸÖÿ≤ ÿßŸÑÿ∫ÿ±ŸÅÿ©",
                players: "ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ", playerList: "ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≠ÿ∂Ÿàÿ±", waiting: "ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÉÿ™ŸÖÿßŸÑ ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ...",
                waitingAdmin: "ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÖÿ≥ÿ§ŸàŸÑ ŸÑÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ©...", startBtn: "ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®ÿ© ÿßŸÑÿ¢ŸÜ", spyTitle: "ÿ£ŸÜÿ™ ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥!",
                spyDesc: "ÿ≠ÿßŸàŸÑ ŸÖÿπÿ±ŸÅÿ© ÿßŸÑŸÉŸÑŸÖÿ© ÿØŸàŸÜ ÿ£ŸÜ ŸäŸÜÿ™ÿ®Ÿá ÿ£ÿ≠ÿØ.", spyMission: "ÿßŸÑŸÖŸáŸÖÿ©: ÿßÿ®ŸÇŸé ÿ∫ÿßŸÖÿ∂ÿßŸã",
                citizenTitle: "ÿ£ŸÜÿ™ ŸÖŸàÿßÿ∑ŸÜ", locationIs: "ÿßŸÑŸÖŸàŸÇÿπ ŸáŸà:", secretWord: "ÿßŸÑŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±Ÿäÿ©:",
                instructions: "ÿßŸÑÿ™ÿπŸÑŸäŸÖÿßÿ™:", instr1: "ÿ™ÿ≠ÿØÿ´Ÿàÿß ÿπŸÜ ÿßŸÑŸÖŸàŸÇÿπ ÿØŸàŸÜ ÿ∞ŸÉÿ± ÿßÿ≥ŸÖŸá ŸÖÿ®ÿßÿ¥ÿ±ÿ©.",
                instr2: "ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ Ÿäÿ≠ÿßŸàŸÑ ÿßŸÑÿ™ŸÖŸàŸäŸá ŸàÿßŸÑÿßŸÜÿØŸÖÿßÿ¨.", instr3: "ÿßŸÑŸÖŸàÿßÿ∑ŸÜŸàŸÜ ŸäŸÅŸàÿ≤ŸàŸÜ ÿ®ŸÉÿ¥ŸÅ ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥.",
                newRound: "ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ©", playerId: "ŸÖÿπÿ±ŸÅ ÿßŸÑŸÑÿßÿπÿ®", errorJoin: "ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©",
                errorStart: "ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ 3 ŸÑÿßÿπÿ®ŸäŸÜ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ ŸÑŸÑÿ®ÿØÿ°", loading: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±...",
            }
        };

        const LOCATIONS = [
            { en: "Hospital", ar: "ÿßŸÑŸÖÿ≥ÿ™ÿ¥ŸÅŸâ", words: { en: ["Doctor", "Nurse"], ar: ["ÿ∑ÿ®Ÿäÿ®", "ŸÖŸÖÿ±ÿ∂ÿ©"] } },
            { en: "School", ar: "ÿßŸÑŸÖÿØÿ±ÿ≥ÿ©", words: { en: ["Teacher", "Student"], ar: ["ŸÖÿπŸÑŸÖ", "ÿ∑ÿßŸÑÿ®"] } },
            { en: "Restaurant", ar: "ÿßŸÑŸÖÿ∑ÿπŸÖ", words: { en: ["Waiter", "Chef"], ar: ["ŸÜÿßÿØŸÑ", "ÿ∑ÿ®ÿßÿÆ"] } },
            { en: "Airport", ar: "ÿßŸÑŸÖÿ∑ÿßÿ±", words: { en: ["Pilot", "Passport"], ar: ["ÿ∑Ÿäÿßÿ±", "ÿ¨Ÿàÿßÿ≤ ÿ≥ŸÅÿ±"] } },
            { en: "Forest", ar: "ÿßŸÑÿ∫ÿßÿ®ÿ©", words: { en: ["Trees", "Camping"], ar: ["ÿ¥ÿ¨ÿ±", "ÿ™ÿÆŸäŸäŸÖ"] } },
            { en: "Cinema", ar: "ÿßŸÑÿ≥ŸäŸÜŸÖÿß", words: { en: ["Popcorn", "Movie"], ar: ["ŸÅÿ¥ÿßÿ±", "ŸÅŸäŸÑŸÖ"] } },
            { en: "Gym", ar: "ÿßŸÑŸÜÿßÿØŸä ÿßŸÑÿ±Ÿäÿßÿ∂Ÿä", words: { en: ["Coach", "Weight"], ar: ["ŸÖÿØÿ±ÿ®", "Ÿàÿ≤ŸÜ"] } },
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [lang, setLang] = useState('ar');
            const [roomId, setRoomId] = useState('');
            const [gameData, setGameData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const t = translations[lang];

            useEffect(() => {
                signInAnonymously(auth).catch(err => console.error("Auth Error:", err));
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !roomId || roomId.length < 3) return;
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId.toUpperCase());
                const unsubscribe = onSnapshot(roomRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setGameData(docSnap.data());
                    } else {
                        setGameData(null);
                    }
                }, (err) => console.error("Firestore Error:", err));
                return () => unsubscribe();
            }, [user, roomId]);

            const createRoom = async () => {
                if (!user) return;
                setLoading(true);
                const newId = Math.random().toString(36).substring(2, 7).toUpperCase();
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', newId);
                try {
                    await setDoc(roomRef, {
                        id: newId, admin: user.uid, players: [{ uid: user.uid, name: `Player ${user.uid.substring(0, 4)}` }],
                        status: 'waiting', spyId: null, location: null, word: null, createdAt: Date.now()
                    });
                    setRoomId(newId);
                } catch (e) {
                    setError("Error creating room");
                }
                setLoading(false);
            };

            const joinRoom = async (id) => {
                if (!user || !id) return;
                setLoading(true);
                const normalizedId = id.toUpperCase();
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', normalizedId);
                try {
                    const snap = await getDoc(roomRef);
                    if (snap.exists()) {
                        const data = snap.data();
                        if (!data.players.find(p => p.uid === user.uid)) {
                            await updateDoc(roomRef, { players: arrayUnion({ uid: user.uid, name: `Player ${user.uid.substring(0, 4)}` }) });
                        }
                        setRoomId(normalizedId);
                    } else setError(t.errorJoin);
                } catch (e) {
                    setError("Room joining failed");
                }
                setLoading(false);
            };

            const startGame = async () => {
                if (!gameData || gameData.players.length < 3) { setError(t.errorStart); return; }
                const loc = LOCATIONS[Math.floor(Math.random() * LOCATIONS.length)];
                const wordIdx = Math.floor(Math.random() * loc.words.en.length);
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                await updateDoc(roomRef, {
                    status: 'playing', location: { en: loc.en, ar: loc.ar },
                    word: { en: loc.words.en[wordIdx], ar: loc.words.ar[wordIdx] },
                    spyId: gameData.players[Math.floor(Math.random() * gameData.players.length)].uid
                });
            };

            const resetGame = async () => {
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                await updateDoc(roomRef, { status: 'waiting', spyId: null, location: null, word: null });
            };

            if (!user) return <div className="flex items-center justify-center h-screen bg-slate-900 text-white font-bold">{t.loading}</div>;

            return (
                <div className={`min-h-screen bg-slate-950 text-slate-100 p-4 transition-all ${lang === 'ar' ? 'text-right' : 'text-left'}`} dir={lang === 'ar' ? 'rtl' : 'ltr'}>
                    <div className="max-w-md mx-auto">
                        <div className="flex justify-between items-center mb-6 pt-4">
                            <div className="flex items-center gap-2">
                                <div className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                                <span className="text-[10px] text-slate-500 uppercase">Live Server</span>
                            </div>
                            <button onClick={() => setLang(l => l === 'en' ? 'ar' : 'en')} className="bg-slate-800 px-4 py-2 rounded-full border border-slate-700 text-sm">
                                {lang === 'en' ? 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©' : 'English'}
                            </button>
                        </div>

                        <header className="text-center mb-8">
                            <h1 className="text-4xl font-bold text-red-500 mb-2">üïµÔ∏è {t.title}</h1>
                            <p className="text-slate-400">{t.subtitle}</p>
                        </header>

                        {error && <div className="bg-red-900/50 border border-red-500 p-3 rounded-lg mb-4 text-sm flex justify-between">{error}<button onClick={() => setError(null)}>X</button></div>}

                        {!gameData ? (
                            <div className="space-y-6 bg-slate-900 p-6 rounded-2xl border border-slate-800">
                                <div className="space-y-2">
                                    <label className="text-sm text-slate-400">{t.joinRoom}</label>
                                    <div className="flex gap-2">
                                        <input type="text" placeholder={t.roomCodePlaceholder} className="bg-slate-800 border border-slate-700 p-3 rounded-xl flex-1 uppercase outline-none" value={roomId} onChange={(e) => setRoomId(e.target.value)} />
                                        <button onClick={() => joinRoom(roomId)} className="bg-blue-600 px-4 rounded-xl">Join</button>
                                    </div>
                                </div>
                                <div className="relative py-2 text-center text-slate-500 text-sm">--- {t.or} ---</div>
                                <button onClick={createRoom} className="w-full bg-red-600 font-bold py-4 rounded-xl shadow-lg">{t.createRoom}</button>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 flex justify-between">
                                    <div><p className="text-xs text-slate-500">{t.roomCode}</p><p className="text-2xl font-bold text-blue-400">{gameData.id}</p></div>
                                    <div className="text-center"><p className="text-xs text-slate-500">{t.players}</p><p className="text-xl font-bold">{gameData.players.length}</p></div>
                                </div>

                                <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-800">
                                    <h3 className="text-sm text-slate-400 mb-3">{t.playerList}</h3>
                                    <div className="grid grid-cols-2 gap-2">
                                        {gameData.players.map((p) => (
                                            <div key={p.uid} className={`p-2 rounded-lg text-sm truncate border ${p.uid === user.uid ? 'border-blue-500 bg-blue-500/10' : 'border-slate-800 bg-slate-800/50'}`}>
                                                {p.name} {p.uid === gameData.admin && 'üëë'}
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {gameData.status === 'waiting' ? (
                                    <div className="text-center py-8">
                                        {gameData.admin === user.uid ? 
                                            <button onClick={startGame} className="w-full bg-green-600 py-4 rounded-xl font-bold shadow-lg">{t.startBtn}</button> : 
                                            <p className="text-slate-400 italic animate-pulse">{t.waitingAdmin}</p>
                                        }
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        <div className={`p-6 rounded-2xl border-2 text-center ${gameData.spyId === user.uid ? 'border-red-500 bg-red-950/20' : 'border-blue-500 bg-blue-950/20'}`}>
                                            {gameData.spyId === user.uid ? (
                                                <>
                                                    <h2 className="text-3xl font-black text-red-500 mb-2">{t.spyTitle}</h2>
                                                    <p className="text-slate-300">{t.spyDesc}</p>
                                                    <div className="mt-4 px-6 py-2 bg-red-600 rounded-full inline-block font-bold">{t.spyMission}</div>
                                                </>
                                            ) : (
                                                <>
                                                    <h2 className="text-3xl font-black text-blue-500 mb-2">{t.citizenTitle}</h2>
                                                    <p className="text-slate-400">{t.locationIs}</p>
                                                    <div className="text-4xl font-bold text-white my-4">{gameData.location[lang]}</div>
                                                    <p className="text-slate-300">{t.secretWord} <span className="text-yellow-400 font-bold">{gameData.word[lang]}</span></p>
                                                </>
                                            )}
                                        </div>
                                        {gameData.admin === user.uid && <button onClick={resetGame} className="w-full bg-slate-800 py-3 rounded-xl text-slate-300 border border-slate-700">{t.newRound}</button>}
                                    </div>
                                )}
                            </div>
                        )}
                        <footer className="mt-12 text-center text-slate-700 text-[10px]"><p>ID: {user.uid}</p></footer>
                    </div>
                </div>
            );
        }

        // ÿßŸÜÿ™ÿ∏ÿ± ÿ≠ÿ™Ÿâ Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ Babel ÿ®ÿßŸÑŸÉÿßŸÖŸÑ
        const renderApp = () => {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        };
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ Babel ŸÇÿ®ŸÑ ÿßŸÑÿ±ŸÜÿØÿ±
        if (window.Babel) {
            renderApp();
        } else {
            window.addEventListener('load', renderApp);
        }
    </script>
</body>
</html>
