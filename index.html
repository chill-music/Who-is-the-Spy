<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PRO SPY | Covert Arena</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üïµÔ∏è</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #05050a;
            --bg-card: rgba(20, 20, 30, 0.85);
            --primary: #00f2ff;
            --secondary: #7000ff;
            --accent: #ff0055;
            --text-main: #ffffff;
            --text-muted: #8b8b9e;
            --border: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body { 
            background-color: var(--bg-dark); 
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .glass-panel {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }

        .font-tech { font-family: 'Rajdhani', sans-serif; }

        @keyframes pulse-glow {
            0% { text-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary); }
            50% { text-shadow: 0 0 20px var(--primary), 0 0 40px var(--primary), 0 0 60px var(--secondary); }
            100% { text-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary); }
        }

        @keyframes rotate-border {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        @keyframes pop-in {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .animate-fade-in { animation: fade-in-up 0.6s ease-out forwards; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-shake { animation: shake 0.5s ease-in-out; }
        .animate-pop { animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .logo-container {
            position: relative;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-border {
            position: absolute;
            inset: 0;
            border-radius: 12px;
            border: 2px solid transparent;
            border-top-color: var(--primary);
            border-right-color: var(--secondary);
            animation: rotate-border 3s linear infinite;
        }

        .game-title {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            letter-spacing: 2px;
            background: linear-gradient(to right, #fff, var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: pulse-glow 3s infinite alternate;
        }

        .btn-neon {
            position: relative;
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            color: white;
            font-weight: 700;
            transition: all 0.3s;
            overflow: hidden;
        }
        
        .btn-neon:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 0 20px var(--primary);
        }
        
        .btn-neon:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-ghost {
            background: transparent;
            border: 1px solid var(--border);
            transition: 0.3s;
        }
        .btn-ghost:hover { border-color: var(--primary); color: var(--primary); }
        
        .btn-vote {
            background: linear-gradient(90deg, #ff0055, #ff3366);
            color: white;
        }
        .btn-vote:hover:not(:disabled) {
            box-shadow: 0 0 20px rgba(255, 0, 85, 0.5);
        }
        
        .btn-success {
             background: linear-gradient(90deg, #10b981, #22c55e);
             color: white;
        }
        
        .btn-danger {
             background: linear-gradient(90deg, #ef4444, #dc2626);
             color: white;
        }
        
        .btn-google {
            background: white;
            color: #333;
            font-weight: bold;
        }
        .btn-google:hover { background: #f0f0f0; }

        .input-dark {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--border);
            color: white;
            transition: 0.2s;
        }
        .input-dark:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--secondary); border-radius: 2px; }

        .player-card { transition: all 0.3s; position: relative; border: 1px solid transparent; }
        .player-card.active {
            background: rgba(0, 242, 255, 0.1);
            border-color: var(--primary);
        }
        .player-card.eliminated {
            opacity: 0.4;
            border-color: var(--accent);
            filter: grayscale(100%);
        }
        
        .timer-bar-container {
            width: 60px;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        .timer-bar-fill {
            height: 100%;
            background: var(--primary);
            transition: width 1s linear;
        }

        .chat-bubble-me {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            color: white;
            border-radius: 18px 18px 4px 18px;
            padding: 8px 12px;
            max-width: 80%;
            align-self: flex-end;
            word-wrap: break-word;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .chat-bubble-other {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            border-radius: 18px 18px 18px 4px;
            padding: 8px 12px;
            max-width: 80%;
            align-self: flex-start;
            word-wrap: break-word;
        }
        
        .identity-square {
            width: 100%;
            max-width: 280px;
            aspect-ratio: 1 / 1; 
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.5s ease;
        }
        
        .identity-spy {
            border: 2px solid var(--accent);
            background: radial-gradient(circle at center, rgba(255, 0, 85, 0.15), transparent 70%);
            box-shadow: 0 0 40px rgba(255, 0, 85, 0.3);
        }
        
        .identity-agent {
            border: 2px solid #10b981;
            background: radial-gradient(circle at center, rgba(16, 185, 129, 0.1), transparent 70%);
            box-shadow: 0 0 40px rgba(16, 185, 129, 0.2);
        }

        .emoji-btn {
            font-size: 18px;
            padding: 5px;
            cursor: pointer;
            transition: transform 0.2s;
            filter: grayscale(100%);
            opacity: 0.7;
        }
        .emoji-btn:hover {
            transform: scale(1.4);
            filter: grayscale(0%);
            opacity: 1;
        }

        .word-vote-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            transition: all 0.3s;
            position: relative;
        }
        .word-vote-card.selected {
            border-color: var(--primary);
            background: rgba(0, 242, 255, 0.1);
            transform: scale(1.02);
        }
        .voter-name {
            position: absolute;
            bottom: -8px;
            right: 10px;
            font-size: 10px;
            background: var(--secondary);
            padding: 2px 6px;
            border-radius: 8px;
            color: white;
        }
        
        .vote-request-banner {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            width: 90%;
            max-width: 500px;
        }
        
        /* Profile & Level Styles */
        .level-badge {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid var(--secondary);
        }
        
        .xp-bar-bg { background: rgba(255,255,255,0.1); }
        .xp-bar-fill { background: linear-gradient(90deg, var(--secondary), var(--primary)); transition: width 0.5s ease; }
        
        .kd-circle { transition: stroke-dashoffset 1s ease; }
        
        .achievement-card {
            transition: all 0.3s;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .achievement-card.locked { filter: grayscale(100%); opacity: 0.4; }
        .achievement-card.unlocked { border-color: var(--primary); box-shadow: 0 0 15px rgba(0, 242, 255, 0.2); }
        
        /* Mini Profile */
        .mini-profile-popup {
            position: absolute;
            left: 100%;
            top: 0;
            margin-left: 10px;
            z-index: 100;
            width: 250px;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            min-width: 180px;
            z-index: 50;
        }
    </style>
</head>
<body>
    <canvas id="bg-canvas"></canvas>
    <div id="root"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyApAJaNfF0YHupunLRlK3jRYvttxczWShY",
            authDomain: "who-is-the-spy-919b9.firebaseapp.com",
            projectId: "who-is-the-spy-919b9",
            storageBucket: "who-is-the-spy-919b9.firebasestorage.app",
            messagingSenderId: "607075438373",
            appId: "1:607075438373:web:a03e9fb8b243cd993e14cc"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'pro_spy_v10_accounts';
        const usersCollection = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users');

        // --- Achievements Definition ---
        const ACHIEVEMENTS = [
            { id: 'first_win', name_en: "First Blood", name_ar: "ÿ£ŸàŸÑ ÿØŸÖ", desc_en: "Win your first game", desc_ar: "ÿßÿ±ÿ®ÿ≠ ÿ£ŸàŸÑ ŸÑÿπÿ®ÿ©", icon: "ü©∏", tier: 1 },
            { id: 'wins_5', name_en: "Rookie Spy", name_ar: "ÿ¨ÿßÿ≥Ÿàÿ≥ ŸÖÿ®ÿ™ÿØÿ¶", desc_en: "Win 5 games", desc_ar: "ÿßÿ±ÿ®ÿ≠ 5 ŸÖÿ®ÿßÿ±Ÿäÿßÿ™", icon: "üïµÔ∏è", tier: 2 },
            { id: 'wins_10', name_en: "Field Agent", name_ar: "ÿπŸÖŸäŸÑ ŸÖŸäÿØÿßŸÜŸä", desc_en: "Win 10 games", desc_ar: "ÿßÿ±ÿ®ÿ≠ 10 ŸÖÿ®ÿßÿ±Ÿäÿßÿ™", icon: "üî´", tier: 3 },
            { id: 'wins_20', name_en: "Master of Disguise", name_ar: "ÿ≥ŸäÿØ ÿßŸÑÿ™ŸÜŸÉÿ±", desc_en: "Win 20 games", desc_ar: "ÿßÿ±ÿ®ÿ≠ 20 ŸÖÿ®ÿßÿ±ÿßÿ©", icon: "üé≠", tier: 4 },
            { id: 'wins_50', name_en: "Shadow Legend", name_ar: "ÿ£ÿ≥ÿ∑Ÿàÿ±ÿ© ÿßŸÑÿ∏ŸÑ", desc_en: "Win 50 games", desc_ar: "ÿßÿ±ÿ®ÿ≠ 50 ŸÖÿ®ÿßÿ±ÿßÿ©", icon: "üëÅÔ∏è", tier: 5 },
            { id: 'wins_100', name_en: "Immortal", name_ar: "ÿÆÿßŸÑÿØ", desc_en: "Win 100 games", desc_ar: "ÿßÿ±ÿ®ÿ≠ 100 ŸÖÿ®ÿßÿ±ÿßÿ©", icon: "üëë", tier: 6, special: true }
        ];

        // --- Sound System ---
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null; 
        const initAudio = () => { if (!audioCtx) audioCtx = new AudioCtx(); };
        const playSound = (type) => {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            if (type === 'click') {
                osc.frequency.value = 800; osc.type = 'sine';
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'success') {
                osc.frequency.value = 600; osc.type = 'sine';
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(1200, audioCtx.currentTime + 0.15);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            }
        };

        // --- Translations ---
        const TRANSLATIONS = {
            en: {
                appName: "PRO SPY", tagline: "COVERT ARENA",
                nickname: "OPERATOR NAME", create: "CREATE LOBBY", join: "JOIN OPS",
                codePlaceholder: "ENTER CODE", players: "OPERATIVES", start: "LAUNCH MISSION",
                langBtn: "ÿßŸÑÿπÿ±ÿ®Ÿäÿ©", loading: "PROCESSING...", you: "YOU",
                statusSpy: "SPY", statusAgent: "AGENT",
                round: "ROUND", skip: "SKIP TURN", vote: "VOTE TO EJECT",
                chatPlaceholder: "Type message...", send: "SEND",
                waiting: "Awaiting host...", location: "LOCATION",
                spectator: "SPECTATOR", ejected: "EJECTED",
                confirm: "CONFIRM VOTE", gameOver: "GAME OVER",
                spyWin: "SPY WINS!", agentsWin: "AGENTS WIN!",
                playAgain: "PLAY AGAIN", connecting: "Connecting...",
                startVoting: "START VOTING", votingStarted: "VOTING INITIATED",
                voteRequestTitle: "VOTING REQUEST", voteRequestDesc: "wants to start voting.",
                agree: "AGREE", decline: "DECLINE",
                endVoting: "END VOTING NOW", votesTitle: "VOTES:",
                roundsFormat: (c, m) => `ROUND ${c}/${m}`,
                wordSelectionTitle: "SELECT KEYWORD",
                wordSelectionDesc: "Choose a keyword for this round",
                finishSelection: "FINISH SELECTION",
                selectedWord: "Selected Keyword",
                // Auth
                loginGoogle: "Login with Google",
                myAccount: "My Account",
                logout: "Logout",
                profile: "Profile",
                guest: "Guest",
                // Stats
                level: "Level",
                wins: "Wins",
                losses: "Losses",
                winRate: "Win Rate",
                totalGames: "Games",
                kd: "K/D",
                achievements: "Achievements",
                noAchievements: "No achievements yet",
                id: "ID"
            },
            ar: {
                appName: "ÿ®ÿ±Ÿà ÿ¨ÿßÿ≥Ÿàÿ≥", tagline: "ÿ≥ÿßÿ≠ÿ© ÿßŸÑÿπŸÖŸÑŸäÿßÿ™",
                nickname: "ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ", create: "ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖŸÇÿ±", join: "ÿßŸÜÿ∂ŸÖÿßŸÖ",
                codePlaceholder: "ÿ£ÿØÿÆŸÑ ÿßŸÑŸÉŸàÿØ", players: "ÿßŸÑÿπŸÖŸÑÿßÿ°", start: "ÿ®ÿØÿ° ÿßŸÑŸÖŸáŸÖÿ©",
                langBtn: "English", loading: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...", you: "ÿ£ŸÜÿ™",
                statusSpy: "ÿ¨ÿßÿ≥Ÿàÿ≥", statusAgent: "ÿπŸÖŸäŸÑ",
                round: "ÿßŸÑÿ¨ŸàŸÑÿ©", skip: "ÿ™ÿÆÿ∑Ÿä ÿßŸÑÿØŸàÿ±", vote: "ÿ™ÿµŸàŸäÿ™ ŸÑŸÑÿ∑ÿ±ÿØ",
                chatPlaceholder: "ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©...", send: "ÿ•ÿ±ÿ≥ÿßŸÑ",
                waiting: "ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÖÿ∂ŸäŸÅ...", location: "ÿßŸÑŸÖŸàŸÇÿπ",
                spectator: "ŸÖÿ¥ÿßŸáÿØ", ejected: "ŸÖÿ∑ÿ±ŸàÿØ",
                confirm: "ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ™ÿµŸàŸäÿ™", gameOver: "ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÑÿπÿ®ÿ©",
                spyWin: "ŸÅÿßÿ≤ ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥!", agentsWin: "ŸÅÿßÿ≤ ÿßŸÑÿπŸÖŸÑÿßÿ°!",
                playAgain: "ŸÑÿπÿ® ŸÖÿ¨ÿØÿØÿßŸã", connecting: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ£ŸÖŸäŸÜ...",
                startVoting: "ÿ®ÿØÿ° ÿßŸÑÿ™ÿµŸàŸäÿ™", votingStarted: "ÿ®ÿØÿ£ ÿßŸÑÿ™ÿµŸàŸäÿ™",
                voteRequestTitle: "ÿ∑ŸÑÿ® ÿ™ÿµŸàŸäÿ™", voteRequestDesc: "Ÿäÿ±ŸäÿØ ÿ®ÿØÿ° ÿßŸÑÿ™ÿµŸàŸäÿ™.",
                agree: "ŸÖŸàÿßŸÅŸÇ", decline: "ÿ±ŸÅÿ∂",
                endVoting: "ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿ™ÿµŸàŸäÿ™ ÿßŸÑÿ¢ŸÜ", votesTitle: "ÿßŸÑÿ£ÿµŸàÿßÿ™:",
                roundsFormat: (c, m) => `ÿßŸÑÿ¨ŸàŸÑÿ© ${c}/${m}`,
                wordSelectionTitle: "ÿßÿÆÿ™ÿ± ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±",
                wordSelectionDesc: "ÿßÿÆÿ™ÿ± ŸÉŸÑŸÖÿ© ÿ≥ÿ± ŸÑŸáÿ∞Ÿá ÿßŸÑÿ¨ŸàŸÑÿ©",
                finishSelection: "ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ±",
                selectedWord: "ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±",
                // Auth
                loginGoogle: "ÿßŸÑÿØÿÆŸàŸÑ ÿ®ÿ¨Ÿàÿ¨ŸÑ",
                myAccount: "ÿ≠ÿ≥ÿßÿ®Ÿä",
                logout: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨",
                profile: "ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä",
                guest: "ÿ≤ÿßÿ¶ÿ±",
                // Stats
                level: "ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ",
                wins: "ŸÅŸàÿ≤",
                losses: "ÿÆÿ≥ÿßÿ±ÿ©",
                winRate: "ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÅŸàÿ≤",
                totalGames: "ÿßŸÑŸÖÿ®ÿßÿ±Ÿäÿßÿ™",
                kd: "ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÅŸàÿ≤",
                achievements: "ÿßŸÑÿ•ŸÜÿ¨ÿßÿ≤ÿßÿ™",
                noAchievements: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ŸÜÿ¨ÿßÿ≤ÿßÿ™ ÿ®ÿπÿØ",
                id: "ÿßŸÑÿ±ŸÇŸÖ"
            }
        };

        const SCENARIOS = [
            { loc_ar: "ŸÖÿ≠ÿ∑ÿ© ŸÅÿ∂ÿßÿ°", words_ar: ["ŸÅÿ∂ÿßÿ°", "ÿµÿßÿ±ŸàÿÆ", "zero-g", "ŸÇŸÖÿ±"], loc_en: "Space Station", words_en: ["Space", "Rocket", "Zero-g", "Moon"] },
            { loc_ar: "ÿ∫Ÿàÿßÿµÿ© ŸÜŸàŸàŸäÿ©", words_ar: ["ÿπŸÖŸÇ", "ŸÖÿßÿ°", "ÿ∂ÿ∫ÿ∑", "ÿ≥ŸàŸÜÿßÿ±"], loc_en: "Nuclear Submarine", words_en: ["Depth", "Water", "Pressure", "Sonar"] },
            { loc_ar: "ŸÇÿµÿ± ŸÖŸÑŸÉŸä", words_ar: ["ÿ™ÿßÿ¨", "ÿ≠ÿ±ÿßÿ≥", "ÿπÿ±Ÿàÿ¥", "ÿÆÿØŸÖ"], loc_en: "Royal Palace", words_en: ["Crown", "Guards", "Throne", "Servants"] },
            { loc_ar: "ÿ®ŸÜŸÉ ŸÖÿ±ŸÉÿ≤Ÿä", words_ar: ["ÿÆÿ≤ŸÜÿ©", "ŸÖÿßŸÑ", "ÿ±ÿµÿßÿµ", "ŸÖŸÅÿ™ÿßÿ≠"], loc_en: "Central Bank", words_en: ["Vault", "Money", "Lead", "Key"] },
            { loc_ar: "ŸÖÿ≥ÿ™ÿ¥ŸÅŸâ ŸÖŸáÿ¨Ÿàÿ±", words_ar: ["ÿ£ÿ¥ÿ®ÿßÿ≠", "ÿ£ÿ∑ÿ®ÿßÿ°", "ÿ∏ŸÑÿßŸÖ", "ÿ≠ŸÇŸÜ"], loc_en: "Abandoned Hospital", words_en: ["Ghosts", "Doctors", "Dark", "Syringe"] },
            { loc_ar: "ŸÇÿ∑ÿßÿ± ŸÑŸäŸÑŸä", words_ar: ["ÿØÿ±ÿ¨ÿßÿ™", "ÿ™ÿ∞ÿßŸÉÿ±", "ŸÜŸàŸÖ", "ŸÖŸÖÿ±"], loc_en: "Night Train", words_en: ["Bunks", "Tickets", "Sleep", "Aisle"] },
            { loc_ar: "ÿ¨ÿ≤Ÿäÿ±ÿ© ŸÉŸÜÿ≤", words_ar: ["ÿÆÿ±Ÿäÿ∑ÿ©", "ÿ≠ŸÅÿ±", "ÿ∞Ÿáÿ®", "ŸÇÿ±ÿßÿµŸÜÿ©"], loc_en: "Treasure Island", words_en: ["Map", "Dig", "Gold", "Pirates"] },
            { loc_ar: "ŸÖÿµŸÜÿπ ÿ±Ÿàÿ®Ÿàÿ™ÿßÿ™", words_ar: ["ÿ£ÿ≥ŸÑÿßŸÉ", "ÿµŸäÿßŸÜÿ©", "ÿ®ÿ±ŸÖÿ¨ÿ©", "ŸÖÿπÿßÿØŸÜ"], loc_en: "Robot Factory", words_en: ["Wires", "Maintenance", "Coding", "Metal"] },
            { loc_ar: "ŸÖÿ∑ÿßÿ± ÿØŸàŸÑŸä", words_ar: ["ÿ¨Ÿàÿßÿ≤ÿßÿ™", "ÿ∑ÿßÿ¶ÿ±ÿßÿ™", "ÿ≠ŸÇÿßÿ¶ÿ®", "ÿ•ŸÇŸÑÿßÿπ"], loc_en: "Airport", words_en: ["Passports", "Planes", "Bags", "Takeoff"] },
            { loc_ar: "ÿ¨ÿßŸÖÿπÿ© ÿ≥ÿ≠ÿ±", words_ar: ["ŸÉÿ™ÿ®", "ÿπÿµÿß", "ÿπŸÅÿßÿ±Ÿäÿ™", "ÿ™ÿ±ÿßŸÉŸäÿ®"], loc_en: "Magic Uni", words_en: ["Books", "Wand", "Ghosts", "Potions"] },
            { loc_ar: "ÿ≥ŸÅŸäŸÜÿ© ŸÇÿ±ÿßÿµŸÜÿ©", words_ar: ["ÿ¥ÿ±ÿßÿπ", "ŸÖÿØŸÅÿπ", "ÿ∑ŸàŸÇ", "ÿÆÿ¥ÿ®"], loc_en: "Pirate Ship", words_en: ["Sail", "Cannon", "Parrot", "Wood"] },
            { loc_ar: "ŸÖÿ±ŸÉÿ≤ ÿ¥ÿ±ÿ∑ÿ©", words_ar: ["ŸÇÿ∂ÿ®ÿßŸÜ", "ÿ¥ÿ±ÿ∑Ÿä", "ÿ≥Ÿäÿßÿ±ÿ©", "ŸÇÿßŸÜŸàŸÜ"], loc_en: "Police Station", words_en: ["Bars", "Cop", "Car", "Law"] },
            { loc_ar: "ŸÖÿØÿ±ÿ≥ÿ© ÿ´ÿßŸÜŸàŸäÿ©", words_ar: ["ÿ∑ÿßŸÑÿ®", "ÿ≠ŸÇŸäÿ®ÿ©", "ÿ≥ÿ®Ÿàÿ±ÿ©", "ÿ¨ÿ±ÿ≥"], loc_en: "High School", words_en: ["Student", "Bag", "Board", "Bell"] },
            { loc_ar: "ŸÖÿ∑ÿπŸÖ ŸÅÿßÿÆÿ±", words_ar: ["ŸÜÿßÿØŸÑ", "ŸÇÿßÿ¶ŸÖÿ©", "ŸÖŸÜÿØŸäŸÑ", "ÿ¥ŸàŸÉÿ©"], loc_en: "Fancy Restaurant", words_en: ["Waiter", "Menu", "Napkin", "Fork"] },
            { loc_ar: "ÿ¥ÿßÿ∑ÿ¶ ÿßÿ≥ÿ™Ÿàÿßÿ¶Ÿä", words_ar: ["ÿ±ŸÖŸÑ", "ŸÖŸàÿ¨ÿ©", "ÿ¥ŸÖÿ≥", "ŸÉŸàŸÉÿ™ŸäŸÑ"], loc_en: "Tropical Beach", words_en: ["Sand", "Wave", "Sun", "Cocktail"] }
        ];

        const EMOJIS = ['üïµÔ∏è', 'üîç', 'üö®', 'ü§ê', 'üëÄ', 'üî™', 'üõ°Ô∏è', 'üíÄ', 'ü§´', '‚úÖ'];
        const MAX_ROUNDS = 3;

        // --- Helper Functions ---
        const generateUID = () => {
            return Math.floor(100000 + Math.random() * 900000).toString(); // 6 digit ID
        };
        
        const calculateLevel = (xp) => Math.floor(xp / 100) + 1;
        const calculateXPProgress = (xp) => (xp % 100);

        // --- Components ---

        const ProfileModal = ({ show, onClose, userData, lang }) => {
            const t = TRANSLATIONS[lang];
            if (!show || !userData) return null;

            const level = calculateLevel(userData.stats?.xp || 0);
            const xpProgress = calculateXPProgress(userData.stats?.xp || 0);
            const wins = userData.stats?.wins || 0;
            const losses = userData.stats?.losses || 0;
            const totalGames = wins + losses;
            const winRate = totalGames > 0 ? ((wins / totalGames) * 100).toFixed(0) : 0;
            
            // KD Circle Math
            const circumference = 2 * Math.PI * 45;
            const offset = circumference - (winRate / 100) * circumference;

            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="glass-panel rounded-2xl p-6 w-full max-w-md animate-pop" onClick={e => e.stopPropagation()}>
                        {/* Header */}
                        <div className="flex justify-between items-start mb-6">
                            <div className="flex items-center gap-4">
                                <img src={userData.photoURL || `https://ui-avatars.com/api/?name=${userData.displayName}&background=random`} className="w-16 h-16 rounded-full border-2 border-cyan-400" />
                                <div>
                                    <h2 className="text-xl font-bold">{userData.displayName}</h2>
                                    <p className="text-gray-400 text-xs font-mono">ID: #{userData.uid.substring(0, 6)}</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="text-gray-500 hover:text-white text-2xl">&times;</button>
                        </div>

                        {/* Level & XP */}
                        <div className="mb-6 glass-panel rounded-xl p-4 border border-white/10">
                            <div className="flex justify-between items-center mb-2">
                                <span className="font-bold text-primary">{t.level} {level}</span>
                                <span className="text-xs text-gray-400">{xpProgress}/100 XP</span>
                            </div>
                            <div className="w-full h-2 xp-bar-bg rounded-full overflow-hidden">
                                <div className="h-full xp-bar-fill" style={{ width: `${xpProgress}%` }}></div>
                            </div>
                        </div>

                        {/* Stats Grid */}
                        <div className="grid grid-cols-3 gap-4 mb-6">
                            <div className="text-center">
                                <div className="text-3xl font-bold text-green-400">{wins}</div>
                                <div className="text-[10px] text-gray-500 uppercase">{t.wins}</div>
                            </div>
                            <div className="text-center">
                                <div className="text-3xl font-bold text-red-400">{losses}</div>
                                <div className="text-[10px] text-gray-500 uppercase">{t.losses}</div>
                            </div>
                             <div className="text-center">
                                <div className="text-3xl font-bold text-cyan-400">{totalGames}</div>
                                <div className="text-[10px] text-gray-500 uppercase">{t.totalGames}</div>
                            </div>
                        </div>

                        {/* KD Circle */}
                        <div className="flex justify-center mb-6">
                            <div className="relative w-32 h-32">
                                <svg className="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                                    <circle cx="50" cy="50" r="45" stroke="rgba(255,255,255,0.1)" strokeWidth="10" fill="none"/>
                                    <circle cx="50" cy="50" r="45" stroke="url(#gradient)" strokeWidth="10" fill="none"
                                        strokeDasharray={circumference} strokeDashoffset={offset} strokeLinecap="round" className="kd-circle"/>
                                    <defs>
                                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                            <stop offset="0%" stopColor="#7000ff"/>
                                            <stop offset="100%" stopColor="#00f2ff"/>
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div className="absolute inset-0 flex flex-col items-center justify-center">
                                    <span className="text-3xl font-black">{winRate}%</span>
                                    <span className="text-[10px] text-gray-400 uppercase">{t.winRate}</span>
                                </div>
                            </div>
                        </div>

                        {/* Achievements */}
                        <div>
                            <h3 className="text-sm font-bold text-gray-400 mb-3">{t.achievements}</h3>
                            <div className="grid grid-cols-3 gap-2">
                                {ACHIEVEMENTS.map(ach => {
                                    const isUnlocked = (userData.achievements || []).includes(ach.id);
                                    return (
                                        <div key={ach.id} className={`achievement-card rounded-lg p-2 text-center ${isUnlocked ? 'unlocked' : 'locked'}`}>
                                            <div className={`text-2xl mb-1 ${ach.special && isUnlocked ? 'animate-float' : ''}`}>{ach.icon}</div>
                                            <div className="text-[10px] font-bold truncate">{lang === 'ar' ? ach.name_ar : ach.name_en}</div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        const MiniProfile = ({ show, onClose, userData, lang }) => {
            const t = TRANSLATIONS[lang];
            if (!show || !userData) return null;

            const level = calculateLevel(userData.stats?.xp || 0);
            const wins = userData.stats?.wins || 0;
            const losses = userData.stats?.losses || 0;
            const totalGames = wins + losses;
            const winRate = totalGames > 0 ? ((wins / totalGames) * 100).toFixed(0) : 0;

            return (
                <div className="mini-profile-popup glass-panel rounded-lg p-3 animate-fade-in" style={{animationDuration: '0.2s'}}>
                    <div className="flex items-center gap-2 mb-2 border-b border-white/10 pb-2">
                        <img src={userData.photoURL || `https://ui-avatars.com/api/?name=${userData.displayName}`} className="w-8 h-8 rounded-full"/>
                        <div>
                            <div className="font-bold text-sm">{userData.displayName}</div>
                            <div className="text-[9px] text-cyan-400">Lvl {level}</div>
                        </div>
                    </div>
                    <div className="flex justify-between text-[10px] text-gray-400">
                        <span>{t.wins}: <span className="text-white">{wins}</span></span>
                        <span>{t.losses}: <span className="text-white">{losses}</span></span>
                    </div>
                    <div className="mt-1 text-center text-[10px] font-bold text-cyan-400">{winRate}% {t.winRate}</div>
                </div>
            );
        };

        function App() {
            const [lang, setLang] = useState('en');
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [room, setRoom] = useState(null);
            const [roomId, setRoomId] = useState('');
            const [inputCode, setInputCode] = useState('');
            const [nickname, setNickname] = useState(() => localStorage.getItem('pro_spy_nick') || '');
            const [loading, setLoading] = useState(false);
            const [chatMsg, setChatMsg] = useState('');
            const [turnTimer, setTurnTimer] = useState(30);
            const [votingTimer, setVotingTimer] = useState(30);
            const [wordSelTimer, setWordSelTimer] = useState(30);
            const [soundEnabled, setSoundEnabled] = useState(true);
            
            // UI State
            const [showProfile, setShowProfile] = useState(false);
            const [showDropdown, setShowDropdown] = useState(false);
            const [selectedPlayerId, setSelectedPlayerId] = useState(null); // For Mini Profile
            
            const t = TRANSLATIONS[lang];

            // --- Effects ---

            // Background Logic
            useEffect(() => {
                const canvas = document.getElementById('bg-canvas');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                let width, height, particles;
                let mouse = { x: null, y: null };
                const particleCount = 60;
                const resize = () => { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; };
                const handleMouseMove = (e) => { mouse.x = e.clientX; mouse.y = e.clientY; };
                window.addEventListener('resize', resize); window.addEventListener('mousemove', handleMouseMove); resize();
                class Particle {
                    constructor() { this.x = Math.random() * width; this.y = Math.random() * height; this.vx = (Math.random() - 0.5) * 0.5; this.vy = (Math.random() - 0.5) * 0.5; this.size = Math.random() * 2; }
                    update() {
                        this.x += this.vx; this.y += this.vy;
                        if (this.x < 0 || this.x > width) this.vx *= -1;
                        if (this.y < 0 || this.y > height) this.vy *= -1;
                        if (mouse.x != null) { let dx = mouse.x - this.x; let dy = mouse.y - this.y; let dist = Math.sqrt(dx*dx + dy*dy); if (dist < 150) { const force = (150 - dist) / 150; this.x -= dx * force * 0.02; this.y -= dy * force * 0.02; } }
                    }
                    draw() { ctx.fillStyle = 'rgba(0, 242, 255, 0.5)'; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); }
                }
                particles = Array.from({ length: particleCount }, () => new Particle());
                let animId;
                const animate = () => {
                    ctx.clearRect(0, 0, width, height); ctx.strokeStyle = 'rgba(112, 0, 255, 0.1)'); ctx.lineWidth = 1;
                    for (let i = 0; i < particles.length; i++) {
                        particles[i].update(); particles[i].draw();
                        for (let j = i; j < particles.length; j++) { let dx = particles[i].x - particles[j].x; let dy = particles[i].y - particles[j].y; let dist = Math.sqrt(dx*dx + dy*dy); if (dist < 120) { ctx.beginPath(); ctx.moveTo(particles[i].x, particles[i].y); ctx.lineTo(particles[j].x, particles[j].y); ctx.stroke(); } }
                    }
                    animId = requestAnimationFrame(animate);
                };
                animate();
                return () => { cancelAnimationFrame(animId); window.removeEventListener('resize', resize); window.removeEventListener('mousemove', handleMouseMove); };
            }, []);

            // Auth State
            useEffect(() => {
                const unsub = auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        setUser(u);
                        // Fetch or Create User Data
                        const userRef = usersCollection.doc(u.uid);
                        const doc = await userRef.get();
                        if (!doc.exists) {
                            const newUser = {
                                uid: u.uid,
                                email: u.email,
                                displayName: u.displayName,
                                photoURL: u.photoURL,
                                customId: generateUID(),
                                stats: { wins: 0, losses: 0, xp: 0 },
                                achievements: [],
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            await userRef.set(newUser);
                            setUserData(newUser);
                        } else {
                            setUserData(doc.data());
                        }
                    } else {
                        setUser(null);
                        setUserData(null);
                    }
                });
                return unsub;
            }, []);

            // Room Listener
            useEffect(() => {
                if (!user || !roomId) return;
                const unsub = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId)
                    .onSnapshot(doc => { if (doc.exists) setRoom(doc.data()); else setRoom(null); });
                return unsub;
            }, [user, roomId]);

            // Timers
            useEffect(() => {
                if (room?.status === 'discussing' && room?.turnEndTime) {
                    const interval = setInterval(() => {
                        const remaining = Math.max(0, Math.floor((room.turnEndTime - Date.now()) / 1000));
                        setTurnTimer(remaining);
                        if (remaining <= 0) { handleSkipTurn(true); clearInterval(interval); }
                    }, 1000);
                    return () => clearInterval(interval);
                } else setTurnTimer(30);
            }, [room?.status, room?.turnEndTime]);

            useEffect(() => {
                if (room?.status === 'voting' && room?.votingEndTime) {
                    const interval = setInterval(() => {
                        const remaining = Math.max(0, Math.floor((room.votingEndTime - Date.now()) / 1000));
                        setVotingTimer(remaining);
                        if (remaining <= 0) { resolveVotes(true); clearInterval(interval); }
                    }, 1000);
                    return () => clearInterval(interval);
                } else setVotingTimer(30);
            }, [room?.status, room?.votingEndTime]);

            useEffect(() => {
                if (room?.status === 'word_selection' && room?.wordSelEndTime) {
                    const interval = setInterval(() => {
                        const remaining = Math.max(0, Math.floor((room.wordSelEndTime - Date.now()) / 1000));
                        setWordSelTimer(remaining);
                        if (remaining <= 0) { finishWordSelection(); clearInterval(interval); }
                    }, 1000);
                    return () => clearInterval(interval);
                } else setWordSelTimer(30);
            }, [room?.status, room?.wordSelEndTime]);

            // --- Actions ---

            const handleGoogleLogin = async () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                try { await auth.signInWithPopup(provider); } catch (e) { console.error(e); }
            };

            const handleLogout = async () => {
                await auth.signOut();
                setShowDropdown(false);
            };

            const handleCreate = async () => {
                if (!nickname.trim() || !user) return;
                if (soundEnabled) playSound('click');
                setLoading(true);
                const id = Math.random().toString(36).substring(2, 7).toUpperCase();
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(id).set({
                    id, admin: user.uid, status: 'waiting',
                    players: [{ uid: user.uid, name: nickname, status: 'active', photo: userData?.photoURL }],
                    scenario: null, spyId: null, 
                    currentTurnUID: null, turnEndTime: null, votingEndTime: null, currentRound: 0,
                    messages: [], votes: {}, usedLocations: [], 
                    wordVotes: {}, chosenWord: null, wordSelEndTime: null,
                    votingRequest: null
                });
                setRoomId(id);
                setLoading(false);
            };

            const handleJoin = async () => {
                if (!nickname.trim() || !inputCode || !user) return;
                if (soundEnabled) playSound('click');
                setLoading(true);
                const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(inputCode.toUpperCase());
                const snap = await ref.get();
                if (snap.exists) {
                    const data = snap.data();
                    const exists = data.players.find(p => p.uid === user.uid);
                    if (!exists) {
                        await ref.update({ players: [...data.players, { uid: user.uid, name: nickname, status: 'active', photo: userData?.photoURL }] });
                    }
                    setRoomId(inputCode.toUpperCase());
                }
                setLoading(false);
            };

            const startGame = async () => {
                if (room.admin !== user.uid) return;
                if (soundEnabled) playSound('success');
                
                const used = room.usedLocations || [];
                const avail = SCENARIOS.filter(s => !used.includes(s.loc_en));
                const scenario = (avail.length > 0 ? avail : SCENARIOS)[Math.floor(Math.random() * (avail.length || SCENARIOS.length))];
                const activePlayers = room.players.filter(p => p.status === 'active');
                if (activePlayers.length < 3) { alert("Need at least 3 players!"); return; }

                const spy = activePlayers[Math.floor(Math.random() * activePlayers.length)];
                let potentialStarters = activePlayers.filter(p => p.uid !== spy.uid);
                if (potentialStarters.length === 0) potentialStarters = activePlayers; 
                const firstPlayer = potentialStarters[Math.floor(Math.random() * potentialStarters.length)];

                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                    status: 'word_selection', scenario, spyId: spy.uid,
                    currentTurnUID: firstPlayer.uid, turnEndTime: null, currentRound: 1, 
                    players: room.players.map(p => ({ ...p, vote: null })),
                    usedLocations: firebase.firestore.FieldValue.arrayUnion(scenario.loc_en),
                    messages: [], votes: {}, wordVotes: {}, chosenWord: null, 
                    wordSelEndTime: Date.now() + 30000, votingRequest: null
                });
            };

            const submitWordVote = async (word) => {
                if (!user || !room || room.status !== 'word_selection') return;
                if (soundEnabled) playSound('click');
                const voteUpdate = {};
                voteUpdate[`wordVotes.${user.uid}`] = word;
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update(voteUpdate);
            };

            const finishWordSelection = async () => {
                if (!room || room.status !== 'word_selection') return;
                const freshSnap = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).get();
                const freshData = freshSnap.data();
                const counts = {};
                Object.values(freshData.wordVotes || {}).forEach(v => counts[v] = (counts[v] || 0) + 1);
                let maxCount = 0;
                let chosenWord = (lang === 'ar' ? freshData.scenario.words_ar[0] : freshData.scenario.words_en[0]);
                for (const w in counts) { if (counts[w] > maxCount) { maxCount = counts[w]; chosenWord = w; } }
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                    status: 'discussing', turnEndTime: Date.now() + 30000, chosenWord: chosenWord, wordSelEndTime: null
                });
            };

            const handleSkipTurn = async (forced = false) => {
                if (!room) return;
                if (!forced && room.currentTurnUID !== user.uid) return;
                if (forced && room.status !== 'discussing') return;
                nextTurn();
            };

            const nextTurn = async () => {
                if (!room) return;
                const activePlayers = room.players.filter(p => p.status === 'active');
                const currentIndex = activePlayers.findIndex(p => p.uid === room.currentTurnUID);
                const nextIndex = (currentIndex + 1) % activePlayers.length;
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                    currentTurnUID: activePlayers[nextIndex].uid, turnEndTime: Date.now() + 30000
                });
            };

            const requestVoting = async () => {
                if (!room || room.status !== 'discussing') return;
                if (soundEnabled) playSound('click');
                if (room.admin === user.uid) { await triggerVoting(); return; }
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                    votingRequest: { requestedBy: user.uid, votes: { [user.uid]: true } }
                });
            };

            const agreeToVote = async () => {
                if (!room || !room.votingRequest) return;
                if (soundEnabled) playSound('click');
                const currentVotes = room.votingRequest.votes || {};
                const newVotes = { ...currentVotes, [user.uid]: true };
                const activePlayers = room.players.filter(p => p.status === 'active');
                const majorityCount = Math.floor(activePlayers.length / 2) + 1;
                if (user.uid === room.admin) { await triggerVoting(); return; }
                const agreeCount = Object.values(newVotes).filter(v => v === true).length;
                if (agreeCount >= majorityCount) { await triggerVoting(); } 
                else { await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({ "votingRequest.votes": newVotes }); }
            };

            const declineVote = async () => {
                if (!room || !room.votingRequest) return;
                if (soundEnabled) playSound('click');
                const currentVotes = room.votingRequest.votes || {};
                const newVotes = { ...currentVotes, [user.uid]: false };
                const activePlayers = room.players.filter(p => p.status === 'active');
                const majorityCount = Math.floor(activePlayers.length / 2) + 1;
                const declineCount = Object.values(newVotes).filter(v => v === false).length;
                if (declineCount >= majorityCount) {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({ votingRequest: null });
                } else { await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({ "votingRequest.votes": newVotes }); }
            };

            const triggerVoting = async () => {
                if (soundEnabled) playSound('click');
                const sysMsg = { sender: 'system', name: 'SYSTEM', text: t.votingStarted, time: Date.now() };
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                    status: 'voting', currentTurnUID: null, turnEndTime: null,
                    votingEndTime: Date.now() + 30000, messages: firebase.firestore.FieldValue.arrayUnion(sysMsg), votingRequest: null
                });
            };

            const sendMessage = async (text) => {
                if (!text.trim() || !user) return;
                if (soundEnabled) playSound('click');
                const msg = { sender: user.uid, name: nickname, text: text, time: Date.now() };
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                    messages: firebase.firestore.FieldValue.arrayUnion(msg)
                });
                setChatMsg('');
            };

            const submitVote = async (targetUID) => {
                if (!targetUID || !user || (room.votes && room.votes[user.uid])) return;
                if (soundEnabled) playSound('click');
                const voteUpdate = {}; voteUpdate[`votes.${user.uid}`] = targetUID;
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update(voteUpdate);
            };

            const endVotingNow = async () => {
                if (room.admin !== user.uid) return;
                await resolveVotes(true);
            };

            const resolveVotes = async (forced = false) => {
                if (!room || room.status !== 'voting') return;
                const freshSnap = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).get();
                const freshData = freshSnap.data();
                if (freshData.status !== 'voting') return;

                const activePlayers = freshData.players.filter(p => p.status === 'active');
                const votes = freshData.votes || {};
                const voteCounts = {};
                Object.values(votes).forEach(v => voteCounts[v] = (voteCounts[v] || 0) + 1);
                let maxVotes = 0; let ejectedUID = null; let isTie = false;
                for (const uid in voteCounts) {
                    if (voteCounts[uid] > maxVotes) { maxVotes = voteCounts[uid]; ejectedUID = uid; isTie = false; }
                    else if (voteCounts[uid] === maxVotes) { isTie = true; }
                }
                const majorityNeeded = Math.floor(activePlayers.length / 2) + 1;
                
                if (isTie || maxVotes < majorityNeeded) {
                    const nextRound = (freshData.currentRound || 1) + 1;
                    if (nextRound > MAX_ROUNDS) { await endGame(false); } 
                    else {
                        const firstPlayer = activePlayers.find(p => p.uid !== freshData.spyId) || activePlayers[0];
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                            status: 'word_selection', votes: {}, currentRound: nextRound,
                            currentTurnUID: firstPlayer.uid, turnEndTime: null, votingEndTime: null,
                            wordVotes: {}, chosenWord: null, wordSelEndTime: Date.now() + 30000
                        });
                    }
                } else {
                    const newPlayers = freshData.players.map(p => { if (p.uid === ejectedUID) return { ...p, status: 'spectator' }; return p; });
                    const isSpy = ejectedUID === freshData.spyId;
                    const remainingAgents = newPlayers.filter(p => p.status === 'active' && p.uid !== freshData.spyId);
                    let newStatus = freshData.status;
                    if (isSpy) { newStatus = 'finished_spy_caught'; await updateStats(freshData.players, freshData.spyId); } 
                    else if (remainingAgents.length <= 1) { newStatus = 'finished_spy_wins'; await updateStats(freshData.players, freshData.spyId); }
                    else {
                        const nextRound = (freshData.currentRound || 1) + 1;
                        if (nextRound > MAX_ROUNDS) { newStatus = 'finished_spy_wins'; await updateStats(freshData.players, freshData.spyId); }
                        else {
                            const firstPlayer = newPlayers.filter(p => p.status === 'active').find(p => p.uid !== freshData.spyId) || newPlayers.filter(p => p.status === 'active')[0];
                            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                                players: newPlayers, status: 'word_selection', votes: {},
                                currentTurnUID: firstPlayer.uid, turnEndTime: null, votingEndTime: null,
                                currentRound: nextRound, wordVotes: {}, chosenWord: null, wordSelEndTime: Date.now() + 30000
                            });
                            return;
                        }
                    }
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                        players: newPlayers, status: newStatus
                    });
                }
            };

            const updateStats = async (players, spyId) => {
                const batch = db.batch();
                players.forEach(p => {
                    // Only update if user exists in our system
                    const userRef = usersCollection.doc(p.uid);
                    // We rely on cloud functions ideally, but here we do transactional updates
                    // For simplicity in client-side, we'll just increment. 
                    // Logic: Winner gets +Win, +XP. Loser gets +Loss.
                    const isWinner = (p.uid === spyId && room.status === 'finished_spy_wins') || (p.uid !== spyId && room.status === 'finished_spy_caught');
                    
                    batch.update(userRef, {
                        "stats.wins": firebase.firestore.FieldValue.increment(isWinner ? 1 : 0),
                        "stats.losses": firebase.firestore.FieldValue.increment(!isWinner ? 1 : 0),
                        "stats.xp": firebase.firestore.FieldValue.increment(isWinner ? 50 : 10)
                    });
                });
                await batch.commit();
                // Achievement check could happen here, but for simplicity we check on profile load or via backend.
                // We will add a simple client-side check for achievements right here.
                checkAchievements(players, spyId);
            };
            
            const checkAchievements = async (players, spyId) => {
                // Simplified check for the winner
                const winnerId = (room.status === 'finished_spy_wins') ? spyId : null; // Spy won
                const winners = (room.status === 'finished_spy_caught') ? players.filter(p => p.uid !== spyId) : (winnerId ? [players.find(p => p.uid === winnerId)] : []);
                
                winners.forEach(async (p) => {
                    if(!p || !p.uid) return;
                    const userRef = usersCollection.doc(p.uid);
                    const doc = await userRef.get();
                    if(!doc.exists) return;
                    const data = doc.data();
                    const wins = (data.stats?.wins || 0) + 1; // Already incremented
                    const currentAch = data.achievements || [];
                    let newAch = [...currentAch];
                    
                    if(wins >= 1 && !currentAch.includes('first_win')) newAch.push('first_win');
                    if(wins >= 5 && !currentAch.includes('wins_5')) newAch.push('wins_5');
                    if(wins >= 10 && !currentAch.includes('wins_10')) newAch.push('wins_10');
                    if(wins >= 20 && !currentAch.includes('wins_20')) newAch.push('wins_20');
                    if(wins >= 50 && !currentAch.includes('wins_50')) newAch.push('wins_50');
                    if(wins >= 100 && !currentAch.includes('wins_100')) newAch.push('wins_100');

                    if(newAch.length > currentAch.length) {
                        await userRef.update({ achievements: newAch });
                    }
                });
            };

            const endGame = async (agentsWin) => {
                if (soundEnabled) playSound(agentsWin ? 'success' : 'fail');
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                    status: agentsWin ? 'finished_spy_caught' : 'finished_spy_wins',
                    turnEndTime: null, votingEndTime: null
                });
            };

            const resetGame = async () => {
                if (soundEnabled) playSound('click');
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                    status: 'waiting', scenario: null, spyId: null, currentTurnUID: null, currentRound: 0,
                    votes: {}, messages: [], votingEndTime: null, turnEndTime: null,
                    players: room.players.map(p => ({ uid: p.uid, name: p.name, status: 'active', photo: p.photo })),
                    wordVotes: {}, chosenWord: null, wordSelEndTime: null, votingRequest: null
                });
            };

            // --- Render Guard ---
            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center space-y-4 animate-fade-in">
                            <div className="logo-container mx-auto animate-float">
                                <div className="logo-border"></div>
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" strokeWidth="2">
                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                </svg>
                            </div>
                            <p className="text-gray-400 font-mono text-sm animate-pulse">{t.connecting}</p>
                            <button onClick={handleGoogleLogin} className="btn-google px-6 py-3 rounded-lg text-sm font-bold mt-4 inline-flex items-center gap-2">
                                <svg class="w-5 h-5" viewBox="0 0 21 20" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0)"><path d="M20.3087 10.2242C20.3087 9.46273 20.2446 8.74991 20.1273 8.08594H10.5V11.9392H15.9715C15.7353 13.1916 15.0216 14.2518 13.9444 14.9582V17.4635H17.2543C19.1883 15.7262 20.3087 13.1977 20.3087 10.2242Z" fill="#4285F4"/><path d="M10.5 19.875C13.1617 19.875 15.3983 18.9749 17.2545 17.4636L13.9446 14.9582C12.9389 15.6222 11.7015 16.0092 10.5 16.0092C7.93332 16.0092 5.72548 14.2615 4.93682 11.9136H1.51758V14.4934C3.3629 18.0879 7.13889 19.875 10.5 19.875Z" fill="#34A853"/><path d="M4.93672 11.9136C4.73672 11.2496 4.62266 10.5469 4.62266 9.82357C4.62266 9.10026 4.73672 8.39751 4.93672 7.73354V5.15375H1.51748C0.774766 6.61518 0.351562 8.20361 0.351562 9.82357C0.351562 11.4435 0.774766 13.0319 1.51748 14.4934L4.93672 11.9136Z" fill="#FBBC05"/><path d="M10.5 3.63864C11.8379 3.63864 13.0392 4.09256 13.9864 4.98477L17.3199 1.65131C15.3941 -0.131629 13.1575 -0.124985 10.5 -0.124985C7.13889 -0.124985 3.3629 1.66216 1.51758 5.25668L4.93682 7.83647C5.72548 5.48861 7.93332 3.63864 10.5 3.63864Z" fill="#EA4335"/></g><defs><clipPath id="clip0"><rect width="20" height="20" fill="white" transform="translate(0.351562)"/></clipPath></defs></svg>
                                {t.loginGoogle}
                            </button>
                        </div>
                    </div>
                );
            }

            // --- Render Helpers ---
            const isMyTurn = room?.currentTurnUID === user.uid;
            const isSpy = room?.spyId === user.uid;
            const me = room?.players?.find(p => p.uid === user.uid);
            const isSpectator = me?.status === 'spectator';
            const hasVoted = room?.votes?.[user.uid];
            const hasVotedWord = room?.wordVotes?.[user.uid];
            const activePlayersCount = room?.players?.filter(p => p.status === 'active').length || 0;
            const voteReq = room?.votingRequest;
            const agreeCount = voteReq?.votes ? Object.values(voteReq.votes).filter(v => v === true).length : 0;
            const declineCount = voteReq?.votes ? Object.values(voteReq.votes).filter(v => v === false).length : 0;
            const majorityNeeded = Math.floor(activePlayersCount / 2) + 1;
            const hasIAgreed = voteReq?.votes?.[user.uid] === true;
            const hasIDeclined = voteReq?.votes?.[user.uid] === false;

            return (
                <div className="min-h-screen flex flex-col items-center p-4 md:p-6" dir={lang === 'ar' ? 'rtl' : 'ltr'}>
                    
                    <ProfileModal show={showProfile} onClose={() => setShowProfile(false)} userData={userData} lang={lang} />

                    {room?.status === 'discussing' && voteReq && (
                         <div className="vote-request-banner glass-panel rounded-xl p-4 border-2 border-pink-500 animate-shake">
                            <div className="flex flex-col gap-2">
                                <div className="text-center font-bold text-pink-400">{t.voteRequestTitle}</div>
                                <div className="text-center text-xs text-gray-300">
                                    <span className="font-bold">{room.players.find(p=>p.uid === voteReq.requestedBy)?.name}</span> {t.voteRequestDesc}
                                </div>
                                <div className="flex justify-center gap-2 mt-2">
                                    <button onClick={agreeToVote} disabled={hasIAgreed} className={`btn px-6 py-2 rounded-lg text-xs font-bold ${hasIAgreed ? 'btn-ghost opacity-50' : 'btn-success'}`}>{t.agree}</button>
                                    <button onClick={declineVote} disabled={hasIDeclined} className={`btn px-6 py-2 rounded-lg text-xs font-bold ${hasIDeclined ? 'btn-ghost opacity-50' : 'btn-danger'}`}>{t.decline}</button>
                                </div>
                            </div>
                         </div>
                    )}

                    {/* Header */}
                    <header className="w-full max-w-4xl flex justify-between items-center mb-6 animate-fade-in">
                        <div className="flex items-center gap-3">
                            <div className="logo-container animate-float">
                                <div className="logo-border"></div>
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" strokeWidth="2">
                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                </svg>
                            </div>
                            <div>
                                <h1 className="game-title text-2xl">{t.appName}</h1>
                                <p className="text-[10px] text-gray-500 tracking-widest font-tech">{t.tagline}</p>
                            </div>
                        </div>
                        <div className="flex gap-2 items-center relative">
                             <button onClick={() => { initAudio(); setSoundEnabled(!soundEnabled); }} className="btn-ghost px-3 py-1 rounded text-xs font-bold border-gray-700">
                                {soundEnabled ? t.soundOn : t.soundOff}
                            </button>
                            <button onClick={() => setLang(lang === 'en' ? 'ar' : 'en')} className="btn-ghost px-4 py-1 rounded text-xs font-bold border-gray-700">{t.langBtn}</button>
                            
                            {/* User Area */}
                            <div className="relative">
                                <button onClick={() => setShowDropdown(!showDropdown)} className="flex items-center gap-2 btn-ghost px-3 py-1 rounded-full border-gray-700">
                                    <img src={userData?.photoURL || `https://ui-avatars.com/api/?name=${userData?.displayName}`} className="w-6 h-6 rounded-full"/>
                                    <span className="text-xs font-bold hidden md:block">{t.myAccount}</span>
                                </button>
                                
                                {showDropdown && (
                                    <div className="dropdown-menu glass-panel rounded-lg py-2 animate-fade-in">
                                        <button onClick={() => { setShowProfile(true); setShowDropdown(false); }} className="w-full text-right px-4 py-2 text-sm hover:bg-white/10">{t.profile}</button>
                                        <button onClick={handleLogout} className="w-full text-right px-4 py-2 text-sm text-red-400 hover:bg-white/10">{t.logout}</button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </header>

                    <main className="w-full max-w-4xl grid grid-cols-1 md:grid-cols-3 gap-4">
                        
                        {/* Left Column */}
                        {room && (
                            <div className="glass-panel rounded-2xl p-4 space-y-2 animate-fade-in delay-1">
                                <h3 className="text-xs font-bold text-gray-400 mb-2 border-b border-gray-800 pb-2 uppercase tracking-wider flex justify-between items-center">
                                    <span>{t.players}</span>
                                    <span className="text-[9px] bg-white/5 px-2 py-0.5 rounded text-cyan-400">{t.roundsFormat(room.currentRound || 1, MAX_ROUNDS)}</span>
                                </h3>
                                <div className="space-y-2">
                                    {room.players.map((p, i) => (
                                        <div key={i} className={`player-card relative p-2 rounded-lg flex items-center justify-between ${p.status === 'spectator' ? 'eliminated' : ''}`}>
                                            <div className="flex items-center gap-2 flex-1">
                                                <img src={p.photo || `https://ui-avatars.com/api/?name=${p.name}`} className="w-6 h-6 rounded-full"/>
                                                <span className="font-bold text-sm truncate">{p.name}</span>
                                                {p.uid === user.uid && <span className="text-[8px] bg-blue-500 px-1 rounded">{t.you}</span>}
                                            </div>
                                            {p.uid === room.currentTurnUID && room.status === 'discussing' && (
                                                <div className="flex items-center gap-1 ml-2">
                                                    <div className="timer-bar-container"><div className="timer-bar-fill" style={{width: `${(turnTimer/30)*100}%`}}></div></div>
                                                    <span className="text-[10px] font-mono text-cyan-400 w-6 text-right">{turnTimer}</span>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>

                                {room.status === 'discussing' && !isSpectator && (
                                    <button onClick={requestVoting} className="btn-vote w-full py-2 rounded-lg font-bold text-xs mt-4 uppercase tracking-wide">{t.startVoting}</button>
                                )}
                            </div>
                        )}

                        {/* Middle Column */}
                        <div className={`${room ? 'md:col-span-2' : 'md:col-span-3'} space-y-4`}>
                            
                            {!room && (
                                <div className="glass-panel rounded-2xl p-8 text-center space-y-6 animate-fade-in mx-auto max-w-md w-full">
                                    <div className="space-y-2">
                                        <label className="text-xs text-gray-400 uppercase">{t.nickname}</label>
                                        <input className="input-dark w-full p-3 rounded-lg text-center font-bold" value={nickname} onChange={e => { setNickname(e.target.value); localStorage.setItem('pro_spy_nick', e.target.value); }} />
                                    </div>
                                    <button onClick={handleCreate} disabled={loading || !nickname} className="btn-neon w-full py-3 rounded-lg font-bold">{t.create}</button>
                                    <div className="flex gap-2">
                                        <input className="input-dark flex-1 p-3 rounded-lg text-center font-mono uppercase" placeholder={t.codePlaceholder} value={inputCode} onChange={e => setInputCode(e.target.value)} />
                                        <button onClick={handleJoin} disabled={loading || !nickname || !inputCode} className="btn-ghost px-6 rounded-lg font-bold">{t.join}</button>
                                    </div>
                                </div>
                            )}

                            {room && (
                                <>
                                    <div className="glass-panel rounded-xl p-3 flex justify-between items-center">
                                        <div className="flex items-center gap-2">
                                            <span className="font-mono font-bold text-lg tracking-widest text-cyan-400">{room.id}</span>
                                            <button onClick={() => navigator.clipboard.writeText(room.id)} className="text-[10px] bg-white/10 px-2 py-1 rounded">Copy</button>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <span className="text-xs font-bold bg-white/10 px-2 py-1 rounded text-cyan-400">
                                                {room.status === 'word_selection' ? 'KEYWORD' : room.status === 'discussing' ? 'DISCUSSION' : room.status.toUpperCase()}
                                            </span>
                                        </div>
                                    </div>

                                    {room.status === 'waiting' && (
                                        <div className="glass-panel rounded-2xl p-6 text-center animate-fade-in">
                                            <div className="animate-pulse text-gray-400 text-sm mb-4">{t.waiting}</div>
                                            {room.admin === user.uid && (<button onClick={startGame} className="btn-neon w-full py-3 rounded-lg font-bold">{t.start}</button>)}
                                        </div>
                                    )}

                                    {(room.status === 'finished_spy_caught' || room.status === 'finished_spy_wins') && (
                                        <div className="glass-panel rounded-2xl p-8 text-center animate-fade-in border border-purple-500">
                                            <h2 className="text-3xl font-black mb-4 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">
                                                {room.status === 'finished_spy_caught' ? t.agentsWin : t.spyWin}
                                            </h2>
                                            <p className="text-gray-400 mb-6">The Spy was: <span className="text-white font-bold">{room.players.find(p => p.uid === room.spyId)?.name}</span></p>
                                            {room.admin === user.uid && (<button onClick={resetGame} className="btn-ghost border-white/20 text-white w-full py-3 rounded-lg">{t.playAgain}</button>)}
                                        </div>
                                    )}

                                    {room.status === 'word_selection' && (
                                        <div className="space-y-4 animate-fade-in">
                                            <div className="glass-panel rounded-2xl p-6 text-center relative overflow-hidden border border-cyan-500/30">
                                                <div className="absolute top-4 right-4 w-12 h-12">
                                                    <svg className="w-full h-full transform -rotate-90" viewBox="0 0 36 36">
                                                        <circle cx="18" cy="18" r="16" fill="none" stroke="rgba(255,255,255,0.1)" strokeWidth="3"></circle>
                                                        <circle cx="18" cy="18" r="16" fill="none" stroke="#00f2ff" strokeWidth="3" strokeDasharray={`${(wordSelTimer/30)*100} ${100-((wordSelTimer/30)*100)}`} strokeLinecap="round"></circle>
                                                    </svg>
                                                    <div className="absolute inset-0 flex items-center justify-center text-sm font-bold text-cyan-400">{wordSelTimer}</div>
                                                </div>
                                                <h3 className="text-xl font-black mb-2 uppercase text-cyan-400">{t.wordSelectionTitle}</h3>
                                                <p className="text-xs text-gray-500 mb-6">{t.wordSelectionDesc}</p>
                                                <div className="grid grid-cols-2 gap-4">
                                                    {(() => {
                                                        const wordsToDisplay = isSpy ? ['?', '?', '?', '?'] : (lang === 'ar' ? room.scenario?.words_ar : room.scenario?.words_en);
                                                        return wordsToDisplay?.map((word, i) => {
                                                            const voters = Object.entries(room.wordVotes || {}).filter(([uid, w]) => w === word).map(([uid]) => room.players.find(p => p.uid === uid)?.name);
                                                            return (
                                                                <button key={i} onClick={() => submitWordVote(word)} disabled={isSpy} className={`word-vote-card p-6 rounded-xl font-bold text-lg transition-all ${hasVotedWord === word ? 'selected' : 'bg-white/5 border border-white/10'} ${isSpy ? 'opacity-50 cursor-not-allowed' : ''}`}>
                                                                    {word}
                                                                    {voters.length > 0 && (<div className="flex justify-center gap-1 mt-2 flex-wrap">{voters.map(v => <span key={v} className="voter-name relative">{v}</span>)}</div>)}
                                                                </button>
                                                            );
                                                        });
                                                    })()}
                                                </div>
                                                {room.admin === user.uid && !isSpy && (<button onClick={() => finishWordSelection(false)} className="btn-neon w-full py-3 rounded-lg font-bold mt-6">{t.finishSelection}</button>)}
                                            </div>
                                            <div className={`identity-square glass-panel ${isSpy ? 'identity-spy' : 'identity-agent'}`}>
                                                <div className="relative z-10 p-6 flex flex-col items-center justify-center h-full">
                                                    <span className={`text-[10px] font-bold uppercase tracking-widest mb-2 px-3 py-1 rounded-full ${isSpy ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}`}>{isSpy ? t.statusSpy : t.statusAgent}</span>
                                                    {isSpy ? ( <><div className="text-5xl mb-2">üïµÔ∏è</div><h3 className="text-3xl font-black tracking-wider text-red-500">???</h3></> ) : ( <><div className="text-3xl font-black mt-2 text-center px-2">{lang === 'ar' ? room.scenario?.loc_ar : room.scenario?.loc_en}</div><p className="text-xs text-gray-400 mt-2">{t.location}</p></> )}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {room.status === 'discussing' && (
                                        <div className="space-y-4 animate-fade-in">
                                            {room.chosenWord && (<div className="glass-panel rounded-xl p-3 text-center border border-cyan-500/50"><span className="text-[10px] text-cyan-400 font-bold uppercase">{t.selectedWord}:</span><span className="ml-2 text-lg font-bold text-white">{room.chosenWord}</span></div>)}
                                            <div className={`identity-square glass-panel ${isSpy ? 'identity-spy' : 'identity-agent'}`}>
                                                <div className="relative z-10 p-6 flex flex-col items-center justify-center h-full">
                                                    <span className={`text-[10px] font-bold uppercase tracking-widest mb-2 px-3 py-1 rounded-full ${isSpy ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}`}>{isSpy ? t.statusSpy : t.statusAgent}</span>
                                                    {isSpy ? ( <><div className="text-5xl mb-2">üïµÔ∏è</div><h3 className="text-3xl font-black tracking-wider text-red-500">???</h3><p className="text-xs text-gray-500 mt-2 text-center">{lang === 'ar' ? 'ÿßŸÉÿ™ÿ¥ŸÅ ÿßŸÑŸÖŸÉÿßŸÜ ÿØŸàŸÜ ÿ£ŸÜ ÿ™ŸÜŸÉÿ¥ŸÅ' : 'Find the location without getting caught'}</p></> ) : ( <><div className="text-4xl font-black mt-2 text-center px-2">{lang === 'ar' ? room.scenario?.loc_ar : room.scenario?.loc_en}</div><p className="text-xs text-gray-400 mt-2">{t.location}</p></> )}
                                                </div>
                                            </div>
                                            <div className="glass-panel rounded-2xl p-4 flex flex-col overflow-hidden relative">
                                                <div className="chat-container space-y-2 mb-3 px-2 h-40 overflow-y-auto relative z-10 mt-4">
                                                    {room.messages?.slice(-20).map((m, i) => (
                                                        <div key={i} className={`flex w-full ${m.sender === user.uid ? 'justify-end' : 'justify-start'}`}>
                                                            <div className={m.sender === user.uid ? 'chat-bubble-me' : 'chat-bubble-other'}>
                                                                {m.sender !== 'system' && <div className="text-[10px] opacity-70 mb-1 font-bold">{m.name}</div>}
                                                                <div className="text-sm leading-tight">{m.text}</div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                                {!isSpectator && isMyTurn ? (
                                                    <div className="flex flex-col gap-2 mt-auto border-t border-white/10 pt-3 relative z-10">
                                                        <div className="flex gap-1 mb-1">{EMOJIS.map(emoji => (<span key={emoji} onClick={() => sendMessage(emoji)} className="emoji-btn">{emoji}</span>))}</div>
                                                        <form onSubmit={(e) => { e.preventDefault(); sendMessage(chatMsg); }} className="flex gap-2">
                                                            <input className="input-dark flex-1 p-3 rounded-xl text-sm" placeholder={t.chatPlaceholder} value={chatMsg} onChange={e => setChatMsg(e.target.value)} />
                                                            <button type="submit" className="btn-neon px-5 rounded-xl text-xs">{t.send}</button>
                                                            <button type="button" onClick={() => handleSkipTurn(false)} className="btn-ghost px-4 rounded-xl text-xs border-orange-500 text-orange-400">{t.skip}</button>
                                                        </form>
                                                    </div>
                                                ) : (<div className="text-center text-xs text-gray-600 py-3 border-t border-white/10 mt-2">{isSpectator ? t.spectator : "Waiting for turn..."}</div>)}
                                            </div>
                                        </div>
                                    )}

                                    {room.status === 'voting' && (
                                        <div className="glass-panel rounded-2xl p-6 animate-fade-in space-y-4">
                                            <div className="flex justify-between items-center">
                                                <h3 className="text-lg font-bold text-yellow-400">{t.vote}</h3>
                                                <div className="relative w-10 h-10">
                                                    <svg className="w-full h-full transform -rotate-90" viewBox="0 0 36 36">
                                                        <circle cx="18" cy="18" r="16" fill="none" stroke="rgba(255,255,255,0.1)" strokeWidth="3"></circle>
                                                        <circle cx="18" cy="18" r="16" fill="none" stroke="#ff0055" strokeWidth="3" strokeDasharray={`${(votingTimer/30)*100} ${100-((votingTimer/30)*100)}`} strokeLinecap="round"></circle>
                                                    </svg>
                                                    <div className="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-yellow-400">{votingTimer}</div>
                                                </div>
                                            </div>
                                            <div className="bg-black/20 p-3 rounded-lg text-xs space-y-1 mb-2 border border-white/5">
                                                <span className="text-gray-500 font-bold">{t.votesTitle}</span>
                                                <div className="flex flex-wrap gap-2 mt-1">
                                                    {Object.entries(room.votes || {}).map(([uid, target]) => {
                                                        const voter = room.players.find(p => p.uid === uid);
                                                        const targetName = room.players.find(p => p.uid === target)?.name;
                                                        return (<span key={uid} className="bg-white/5 px-2 py-1 rounded">{voter?.name}: <span className="text-cyan-400">{targetName}</span></span>);
                                                    })}
                                                </div>
                                            </div>
                                            {!hasVoted ? (
                                                <div className="grid grid-cols-2 gap-3">
                                                    {room.players.filter(p => p.status === 'active').map(p => (
                                                        <button key={p.uid} onClick={() => submitVote(p.uid)} className="p-4 rounded-xl border text-sm font-bold transition-all bg-white/5 border-white/10 hover:border-pink-400 hover:bg-pink-500/10">{p.name}</button>
                                                    ))}
                                                </div>
                                            ) : (<div className="text-center space-y-4 py-4"><div className="text-green-400 font-bold">{t.confirm}</div></div>)}
                                            {room.admin === user.uid && (<button onClick={endVotingNow} className="btn-danger w-full py-2 rounded-lg font-bold text-xs uppercase mt-2">{t.endVoting}</button>)}
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
