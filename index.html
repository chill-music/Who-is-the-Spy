<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Who is the Spy? | Final Build</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;600;800&family=Inter:wght@400;900&display=swap');
        
        body { 
            background-color: #020617; 
            color: #f8fafc;
            font-family: 'Noto Sans Arabic', sans-serif;
            margin: 0;
            overflow-x: hidden;
        }

        .glass-card {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 2rem;
        }

        .spy-theme { background: linear-gradient(135deg, #ef4444 0%, #7f1d1d 100%); }
        .citizen-theme { background: linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%); }
        
        .btn-primary {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-primary:active { transform: scale(0.95); }

        .loading-ring {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(59, 130, 246, 0.1);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyApAJaNfF0YHupunLRlK3jRYvttxczWShY",
            authDomain: "who-is-the-spy-919b9.firebaseapp.com",
            projectId: "who-is-the-spy-919b9",
            storageBucket: "who-is-the-spy-919b9.firebasestorage.app",
            messagingSenderId: "607075438373",
            appId: "1:607075438373:web:a03e9fb8b243cd993e14cc"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'spy_game_pro_final';

        const LOCATIONS = [
            { ar: "Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰", words: ["Ø·Ø¨ÙŠØ¨", "Ù…Ù…Ø±Ø¶Ø©", "Ø¬Ø±Ø§Ø­Ø©", "Ù…Ø±ÙŠØ¶"] },
            { ar: "Ø§Ù„Ù…Ø¯Ø±Ø³Ø©", words: ["Ù…Ø¹Ù„Ù…", "Ø·Ø§Ù„Ø¨", "Ù…ÙƒØªØ¨Ø©", "Ø§Ù…ØªØ­Ø§Ù†"] },
            { ar: "Ø§Ù„Ù…Ø·Ø¹Ù…", words: ["Ø·Ø¨Ø§Ø®", "Ù†Ø§Ø¯Ù„", "Ù‚Ø§Ø¦Ù…Ø© Ø·Ø¹Ø§Ù…", "Ø¹Ø´Ø§Ø¡"] },
            { ar: "Ø§Ù„Ù…Ø·Ø§Ø±", words: ["Ø·ÙŠØ§Ø±", "Ø¬ÙˆØ§Ø² Ø³ÙØ±", "Ù…Ø¯Ø±Ø¬", "ØªØ°ÙƒØ±Ø©"] },
            { ar: "Ø§Ù„ØºØ§Ø¨Ø©", words: ["Ø´Ø¬Ø±", "ØªØ®ÙŠÙŠÙ…", "ØµÙŠØ§Ø¯", "Ø°Ø¦Ø§Ø¨"] },
            { ar: "Ø§Ù„Ø³ÙŠÙ†Ù…Ø§", words: ["ÙÙŠÙ„Ù…", "ÙØ´Ø§Ø±", "Ø´Ø§Ø´Ø©", "Ù…Ù…Ø«Ù„ÙŠÙ†"] }
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [room, setRoom] = useState(null);
            const [roomId, setRoomId] = useState('');
            const [playerName, setPlayerName] = useState(localStorage.getItem('p_name') || '');
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [copySuccess, setCopySuccess] = useState(false);
            const [selectedWord, setSelectedWord] = useState(null);

            // Auth Setup
            useEffect(() => {
                const unsub = auth.onAuthStateChanged(async (u) => {
                    if (!u) {
                        await auth.signInAnonymously();
                    } else {
                        setUser(u);
                        setLoading(false);
                    }
                });
                return unsub;
            }, []);

            // Real-time Room Sync (The Fix)
            useEffect(() => {
                if (!user || !roomId) return;
                const docPath = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId);
                
                const unsubscribe = docPath.onSnapshot((doc) => {
                    if (doc.exists) {
                        setRoom(doc.data());
                    } else {
                        setRoom(null);
                        if (roomId) setError("Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø£Ùˆ Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
                    }
                });
                return unsubscribe;
            }, [user, roomId]);

            const copyRoomCode = () => {
                const el = document.createElement('textarea');
                el.value = roomId;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                setCopySuccess(true);
                setTimeout(() => setCopySuccess(false), 2000);
            };

            const createRoom = async () => {
                if (!playerName.trim()) { setError("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹"); return; }
                setLoading(true);
                localStorage.setItem('p_name', playerName);
                const newId = Math.random().toString(36).substring(2, 7).toUpperCase();
                const roomData = {
                    id: newId,
                    admin: user.uid,
                    players: [{ uid: user.uid, name: playerName }],
                    status: 'waiting',
                    spyId: null,
                    location: null,
                    word: null,
                    options: null
                };
                
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(newId).set(roomData);
                    setRoomId(newId);
                } catch (e) { setError("ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©"); }
                setLoading(false);
            };

            const joinRoom = async () => {
                if (!playerName.trim()) { setError("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹"); return; }
                if (!roomId) return;
                setLoading(true);
                localStorage.setItem('p_name', playerName);
                const rRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId.toUpperCase());
                
                try {
                    const snap = await rRef.get();
                    if (snap.exists) {
                        const data = snap.data();
                        const exists = data.players.find(p => p.uid === user.uid);
                        if (!exists) {
                            await rRef.update({
                                players: firebase.firestore.FieldValue.arrayUnion({ uid: user.uid, name: playerName })
                            });
                        }
                        setRoomId(roomId.toUpperCase());
                    } else {
                        setError("Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± ØµØ­ÙŠØ­");
                    }
                } catch (e) { setError("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…"); }
                setLoading(false);
            };

            const startGame = async () => {
                if (room.players.length < 3) { setError("ØªØ­ØªØ§Ø¬ Ù„Ù€ 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"); return; }
                const loc = LOCATIONS[Math.floor(Math.random() * LOCATIONS.length)];
                const options = [...loc.words].sort(() => 0.5 - Math.random());
                const correctWord = loc.words[Math.floor(Math.random() * loc.words.length)];
                const spy = room.players[Math.floor(Math.random() * room.players.length)];

                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                    status: 'playing',
                    location: loc.ar,
                    word: correctWord,
                    options: options,
                    spyId: spy.uid
                });
                setSelectedWord(null);
            };

            const reset = () => {
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                    status: 'waiting', spyId: null, location: null
                });
            };

            if (loading) return (
                <div className="h-screen flex items-center justify-center flex-col gap-4">
                    <div className="loading-ring"></div>
                    <span className="text-blue-400 font-bold tracking-widest animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4 text-right" dir="rtl">
                    <div className="w-full max-w-md">
                        {/* Title Section */}
                        <div className="text-center mb-8">
                            <h1 className="text-5xl font-black mb-2 bg-gradient-to-r from-red-500 to-blue-500 bg-clip-text text-transparent italic">
                                Ù…Ù† Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ØŸ
                            </h1>
                            <p className="text-slate-500 font-bold tracking-tighter uppercase text-xs">Who is the Spy - Final Version</p>
                        </div>

                        {error && (
                            <div className="bg-red-500/20 border border-red-500 text-red-200 p-3 rounded-xl mb-4 text-center text-sm font-bold flex justify-between items-center">
                                <span>{error}</span>
                                <button onClick={() => setError(null)}>âœ•</button>
                            </div>
                        )}

                        {!room ? (
                            <div className="glass-card p-8 shadow-2xl space-y-6">
                                <div className="space-y-2">
                                    <label className="text-xs font-black text-slate-500 mr-2">Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨</label>
                                    <input 
                                        className="w-full bg-slate-900 border border-slate-800 p-4 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none font-bold"
                                        placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..."
                                        value={playerName}
                                        onChange={e => setPlayerName(e.target.value)}
                                    />
                                </div>

                                <button onClick={createRoom} className="w-full btn-primary bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl font-black text-lg shadow-lg">
                                    Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
                                </button>

                                <div className="flex items-center gap-4 py-2">
                                    <div className="h-[1px] bg-slate-800 flex-1"></div>
                                    <span className="text-slate-600 text-xs font-bold">Ø£Ùˆ Ø§Ù†Ø¶Ù… Ù„ØºØ±ÙØ©</span>
                                    <div className="h-[1px] bg-slate-800 flex-1"></div>
                                </div>

                                <div className="flex gap-2">
                                    <input 
                                        className="flex-1 bg-slate-900 border border-slate-800 p-4 rounded-2xl uppercase font-black text-center tracking-widest"
                                        placeholder="Ø§Ù„Ø±Ù…Ø²"
                                        value={roomId}
                                        onChange={e => setRoomId(e.target.value.toUpperCase())}
                                    />
                                    <button onClick={joinRoom} className="bg-slate-800 hover:bg-slate-700 px-6 rounded-2xl font-black">
                                        Ø¯Ø®ÙˆÙ„
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-6 animate-in fade-in duration-500">
                                {/* Room Stats */}
                                <div className="glass-card p-4 flex justify-between items-center border-slate-800">
                                    <div className="cursor-pointer group relative" onClick={copyRoomCode}>
                                        <span className="text-[10px] text-slate-500 font-black block">Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©</span>
                                        <div className="flex items-center gap-2">
                                            <span className="text-3xl font-black text-blue-400 font-mono tracking-widest">{room.id}</span>
                                            <span className={`text-xl transition-all ${copySuccess ? 'scale-125 opacity-100' : 'opacity-40 group-hover:opacity-100'}`}>
                                                {copySuccess ? 'âœ…' : 'ğŸ“‹'}
                                            </span>
                                        </div>
                                    </div>
                                    <div className="text-left">
                                        <span className="text-[10px] text-slate-500 font-black block">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</span>
                                        <span className="text-3xl font-black">{room.players.length}</span>
                                    </div>
                                </div>

                                {room.status === 'waiting' ? (
                                    <div className="glass-card p-6 space-y-4">
                                        <div className="grid grid-cols-1 gap-2">
                                            {room.players.map((p, i) => (
                                                <div key={i} className={`p-4 rounded-xl flex justify-between items-center ${p.uid === user.uid ? 'bg-blue-500/10 border border-blue-500/30' : 'bg-slate-800/40 border border-slate-800'}`}>
                                                    <span className="font-bold">{p.name} {p.uid === user.uid && "(Ø£Ù†Øª)"}</span>
                                                    {p.uid === room.admin && <span>ğŸ‘‘</span>}
                                                </div>
                                            ))}
                                        </div>

                                        {room.admin === user.uid ? (
                                            <button onClick={startGame} className="w-full bg-green-600 hover:bg-green-500 py-4 rounded-2xl font-black text-xl mt-4 shadow-xl">
                                                Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø¢Ù†
                                            </button>
                                        ) : (
                                            <div className="text-center py-6 text-slate-500 italic flex flex-col items-center gap-3">
                                                <div className="loading-ring !w-6 !h-6 border-t-blue-400"></div>
                                                Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ù„Ø¨Ø¯Ø¡...
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="space-y-6">
                                        <div className={`p-8 rounded-[2.5rem] border-2 shadow-2xl text-center relative overflow-hidden ${room.spyId === user.uid ? 'spy-theme border-red-400' : 'citizen-theme border-blue-400'}`}>
                                            {room.spyId === user.uid ? (
                                                <div className="space-y-6">
                                                    <div className="text-7xl">ğŸ•µï¸â€â™‚ï¸</div>
                                                    <h2 className="text-4xl font-black uppercase">Ø£Ù†Øª Ø§Ù„Ø¬Ø§Ø³ÙˆØ³!</h2>
                                                    <p className="text-red-100/70 text-sm font-bold">Ù…Ù‡Ù…ØªÙƒ: Ø§ÙƒØªØ´Ù Ø§Ù„Ù…ÙƒØ§Ù† Ù…Ù† Ø­Ø¯ÙŠØ«Ù‡Ù… Ø¯ÙˆÙ† Ø£Ù† ÙŠÙƒØªØ´ÙÙˆÙƒ.</p>
                                                    <div className="inline-block px-6 py-2 bg-black/30 rounded-full text-xs font-black animate-pulse">Ù…Ù‡Ù…Ø© Ø³Ø±ÙŠØ© Ù„Ù„ØºØ§ÙŠØ©</div>
                                                </div>
                                            ) : (
                                                <div className="space-y-4">
                                                    <h2 className="text-xs font-black text-blue-100/60 uppercase tracking-[0.3em]">Ø£Ù†Øª Ù…ÙˆØ§Ø·Ù† ØµØ§Ù„Ø­</h2>
                                                    <div className="space-y-1">
                                                        <p className="text-[10px] text-blue-200 font-bold uppercase">Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø³Ø±ÙŠ Ù‡Ùˆ:</p>
                                                        <div className="text-5xl font-black text-white tracking-tighter">{room.location}</div>
                                                    </div>
                                                    <div className="h-[1px] bg-white/10 my-4 w-1/2 mx-auto"></div>
                                                    <div className="space-y-4">
                                                        <p className="text-[10px] text-blue-200 font-bold">Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙ…ÙˆÙŠÙ‡:</p>
                                                        <div className="grid grid-cols-2 gap-2">
                                                            {room.options.map((w, i) => (
                                                                <button 
                                                                    key={i}
                                                                    onClick={() => setSelectedWord(w)}
                                                                    className={`p-4 rounded-2xl border-2 transition-all font-bold ${selectedWord === w ? 'bg-yellow-400 text-black border-white scale-105' : 'bg-black/20 border-white/5 hover:bg-black/40'}`}
                                                                >
                                                                    {w}
                                                                </button>
                                                            ))}
                                                        </div>
                                                        {selectedWord && (
                                                            <div className={`mt-2 font-black py-2 px-6 rounded-full inline-block border-2 ${selectedWord === room.word ? "bg-green-500/20 border-green-500 text-green-400" : "bg-red-500/20 border-red-500 text-red-400"}`}>
                                                                {selectedWord === room.word ? "Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© âœ…" : "Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø© âŒ"}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        {room.admin === user.uid && (
                                            <button onClick={reset} className="w-full bg-slate-900 border border-slate-800 py-4 rounded-2xl font-black hover:bg-slate-800 text-sm">
                                                Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸ”„
                                            </button>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                        
                        <div className="mt-12 text-center text-[9px] text-slate-800 font-mono tracking-[0.5em] uppercase">
                            Secure-Build: {user.uid.substr(0,12)}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
