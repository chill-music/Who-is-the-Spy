<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Who is the Spy? | Ù…Ù† Ù‡Ùˆ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;600;800&display=swap');
        body { 
            font-family: 'Noto Sans Arabic', sans-serif; 
            background-color: #020617; 
            margin: 0; 
            overflow-x: hidden;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .spy-gradient {
            background: linear-gradient(135deg, #ef4444 0%, #7f1d1d 100%);
        }
        .citizen-gradient {
            background: linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%);
        }
    </style>
</head>
<body class="text-slate-100">
    <div id="root"></div>

    <!-- Firebase SDKs (Compatibility Version) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyApAJaNfF0YHupunLRlK3jRYvttxczWShY",
            authDomain: "who-is-the-spy-919b9.firebaseapp.com",
            projectId: "who-is-the-spy-919b9",
            storageBucket: "who-is-the-spy-919b9.firebasestorage.app",
            messagingSenderId: "607075438373",
            appId: "1:607075438373:web:a03e9fb8b243cd993e14cc"
        };

        // Initialize Firebase safely
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'spy_master_pro';

        const LOCATIONS = [
            { ar: "Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰", words: ["Ø·Ø¨ÙŠØ¨", "Ù…Ù…Ø±Ø¶Ø©", "Ø¬Ø±Ø§Ø­Ø©", "Ù…Ø±ÙŠØ¶"] },
            { ar: "Ø§Ù„Ù…Ø¯Ø±Ø³Ø©", words: ["Ù…Ø¹Ù„Ù…", "Ø·Ø§Ù„Ø¨", "Ø³Ø¨ÙˆØ±Ø©", "Ø·Ø§ÙˆÙ„Ø©"] },
            { ar: "Ø§Ù„Ù…Ø·Ø¹Ù…", words: ["Ù†Ø§Ø¯Ù„", "Ø·Ø¨Ø§Ø®", "Ù‚Ø§Ø¦Ù…Ø© Ø·Ø¹Ø§Ù…", "Ø¹Ø´Ø§Ø¡"] },
            { ar: "Ø§Ù„Ù…Ø·Ø§Ø±", words: ["Ø·ÙŠØ§Ø±", "Ø¬ÙˆØ§Ø² Ø³ÙØ±", "Ø·Ø§Ø¦Ø±Ø©", "Ù…Ø¯Ø±Ø¬"] },
            { ar: "Ø§Ù„ØºØ§Ø¨Ø©", words: ["Ø´Ø¬Ø±", "ØªØ®ÙŠÙŠÙ…", "Ø­ÙŠÙˆØ§Ù†Ø§Øª", "ÙƒÙˆØ®"] },
            { ar: "Ø§Ù„Ø³ÙŠÙ†Ù…Ø§", words: ["ÙØ´Ø§Ø±", "ÙÙŠÙ„Ù…", "Ø´Ø§Ø´Ø©", "ØªØ°ÙƒØ±Ø©"] },
            { ar: "Ø§Ù„Ù†Ø§Ø¯ÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ", words: ["Ù…Ø¯Ø±Ø¨", "Ø£ÙˆØ²Ø§Ù†", "Ù…Ø³Ø¨Ø­", "Ø±ÙƒØ¶"] },
            { ar: "Ø§Ù„ÙØ¶Ø§Ø¡", words: ["Ø±Ø§Ø¦Ø¯ ÙØ¶Ø§Ø¡", "ÙƒÙˆÙƒØ¨", "ØµØ§Ø±ÙˆØ®", "Ù†Ø¬ÙˆÙ…"] }
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [roomId, setRoomId] = useState('');
            const [gameData, setGameData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [playerName, setPlayerName] = useState(localStorage.getItem('spy_name') || '');

            // Auth Logic with Fix for "Configuration Not Found"
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        // Check if already signed in
                        if (auth.currentUser) {
                            setUser(auth.currentUser);
                            setLoading(false);
                            return;
                        }
                        // Try anonymous login
                        await auth.signInAnonymously();
                    } catch (err) {
                        console.error("Auth Error:", err);
                        // Fallback: Create a local fake user ID if Firebase Auth is disabled in dashboard
                        const fakeUser = { uid: 'local_' + Math.random().toString(36).substr(2, 9) };
                        setUser(fakeUser);
                        setError("ØªØ­Ø°ÙŠØ±: Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ù…Ù„ Ø¨ÙˆØ¶Ø¹ Ù…Ø­Ù„ÙŠ Ù„Ø¹Ø¯Ù… ØªÙØ¹ÙŠÙ„ Auth");
                    }
                    setLoading(false);
                };

                const unsubscribe = auth.onAuthStateChanged((u) => {
                    if (u) setUser(u);
                });

                initAuth();
                return () => unsubscribe();
            }, []);

            // Real-time Game Sync
            useEffect(() => {
                if (!user || !roomId) return;
                
                const roomPath = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId.toUpperCase());
                
                const unsubscribe = roomPath.onSnapshot((doc) => {
                    if (doc.exists) {
                        setGameData(doc.data());
                    } else {
                        if (gameData) setRoomId(''); // Room was deleted
                    }
                }, (err) => {
                    console.error("Sync Error:", err);
                });

                return () => unsubscribe();
            }, [user, roomId]);

            const handleCreateRoom = async () => {
                if (!playerName.trim()) { setError("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹"); return; }
                setLoading(true);
                localStorage.setItem('spy_name', playerName);
                const newId = Math.random().toString(36).substring(2, 7).toUpperCase();
                const roomRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(newId);
                
                const initialData = {
                    id: newId,
                    admin: user.uid,
                    players: [{ uid: user.uid, name: playerName }],
                    status: 'waiting',
                    spyId: null,
                    location: null,
                    word: null,
                    createdAt: Date.now()
                };

                try {
                    await roomRef.set(initialData);
                    setRoomId(newId);
                } catch (e) {
                    setError("ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firestore");
                }
                setLoading(false);
            };

            const handleJoinRoom = async (idToJoin) => {
                const targetId = (idToJoin || roomId).toUpperCase();
                if (!playerName.trim()) { setError("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹"); return; }
                if (!targetId) { setError("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©"); return; }
                
                setLoading(true);
                localStorage.setItem('spy_name', playerName);
                const roomRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(targetId);
                
                try {
                    const snap = await roomRef.get();
                    if (snap.exists) {
                        const data = snap.data();
                        const players = [...data.players];
                        if (!players.find(p => p.uid === user.uid)) {
                            players.push({ uid: user.uid, name: playerName });
                            await roomRef.update({ players });
                        }
                        setRoomId(targetId);
                    } else {
                        setError("Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!");
                    }
                } catch (e) {
                    setError("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…");
                }
                setLoading(false);
            };

            const startGame = async () => {
                if (gameData.players.length < 3) {
                    setError("ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
                    return;
                }
                const loc = LOCATIONS[Math.floor(Math.random() * LOCATIONS.length)];
                const word = loc.words[Math.floor(Math.random() * loc.words.length)];
                const spy = gameData.players[Math.floor(Math.random() * gameData.players.length)];

                const roomRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId);
                await roomRef.update({
                    status: 'playing',
                    location: loc.ar,
                    word: word,
                    spyId: spy.uid
                });
            };

            const resetGame = async () => {
                const roomRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId);
                await roomRef.update({
                    status: 'waiting',
                    spyId: null,
                    location: null,
                    word: null
                });
            };

            if (loading) return (
                <div className="flex flex-col items-center justify-center h-screen space-y-4">
                    <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                    <div className="text-xl font-bold text-blue-400 animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            );

            return (
                <div className="min-h-screen p-4 md:p-8 flex flex-col items-center justify-center" dir="rtl">
                    <div className="w-full max-w-md">
                        {/* Header */}
                        <div className="text-center mb-10">
                            <h1 className="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-blue-500 mb-2">
                                Ù…Ù† Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ØŸ
                            </h1>
                            <p className="text-slate-400">Ù„Ø¹Ø¨Ø© Ø§Ù„Ø®Ø¯Ø§Ø¹ ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</p>
                        </div>

                        {error && (
                            <div className="mb-6 p-4 bg-red-900/30 border border-red-500/50 rounded-xl text-red-200 text-sm flex justify-between items-center">
                                <span>{error}</span>
                                <button onClick={() => setError(null)} className="text-lg">Ã—</button>
                            </div>
                        )}

                        {!gameData ? (
                            /* Setup View */
                            <div className="glass-panel p-8 rounded-3xl shadow-2xl space-y-6">
                                <div className="space-y-2">
                                    <label className="text-xs text-slate-500 mr-2 uppercase tracking-widest font-bold">Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨</label>
                                    <input 
                                        type="text" 
                                        placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." 
                                        className="w-full bg-slate-800/50 border border-slate-700 p-4 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                                        value={playerName}
                                        onChange={(e) => setPlayerName(e.target.value)}
                                    />
                                </div>

                                <div className="grid grid-cols-1 gap-4">
                                    <button 
                                        onClick={handleCreateRoom}
                                        className="w-full spy-gradient py-4 rounded-2xl font-bold text-lg shadow-lg hover:opacity-90 transition-all active:scale-95"
                                    >
                                        Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
                                    </button>
                                    
                                    <div className="relative py-2 text-center">
                                        <span className="bg-slate-900 px-4 text-slate-600 text-sm">Ø£Ùˆ Ø§Ù†Ø¶Ù… Ù„ØºØ±ÙØ©</span>
                                        <div className="absolute top-1/2 left-0 right-0 h-[1px] bg-slate-800 -z-10"></div>
                                    </div>

                                    <div className="flex gap-2">
                                        <input 
                                            type="text" 
                                            placeholder="Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©" 
                                            className="flex-1 bg-slate-800/50 border border-slate-700 p-4 rounded-2xl uppercase font-mono text-center tracking-widest outline-none focus:border-blue-500"
                                            value={roomId}
                                            onChange={(e) => setRoomId(e.target.value.toUpperCase())}
                                        />
                                        <button 
                                            onClick={() => handleJoinRoom()}
                                            className="bg-slate-700 hover:bg-slate-600 px-6 rounded-2xl font-bold transition-all"
                                        >
                                            Ø¯Ø®ÙˆÙ„
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            /* Lobby / Game View */
                            <div className="space-y-6">
                                {/* Room Info Card */}
                                <div className="glass-panel p-4 rounded-2xl flex justify-between items-center shadow-lg">
                                    <div>
                                        <span className="text-[10px] text-slate-500 block uppercase">Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©</span>
                                        <span className="text-2xl font-black text-blue-400 tracking-widest font-mono">{gameData.id}</span>
                                    </div>
                                    <div className="text-left">
                                        <span className="text-[10px] text-slate-500 block uppercase text-right">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</span>
                                        <span className="text-2xl font-bold">{gameData.players.length}</span>
                                    </div>
                                </div>

                                {gameData.status === 'waiting' ? (
                                    /* Waiting Lobby */
                                    <div className="glass-panel p-6 rounded-3xl space-y-6">
                                        <div className="grid grid-cols-2 gap-3">
                                            {gameData.players.map((p, idx) => (
                                                <div key={idx} className={`p-3 rounded-xl border flex items-center gap-2 ${p.uid === user.uid ? 'border-blue-500 bg-blue-500/10' : 'border-slate-800 bg-slate-800/40'}`}>
                                                    <div className={`w-2 h-2 rounded-full ${p.uid === user.uid ? 'bg-blue-500' : 'bg-slate-600'}`}></div>
                                                    <span className="text-sm truncate">{p.name}</span>
                                                    {p.uid === gameData.admin && <span className="text-xs">ğŸ‘‘</span>}
                                                </div>
                                            ))}
                                        </div>

                                        {gameData.admin === user.uid ? (
                                            <button 
                                                onClick={startGame}
                                                className="w-full bg-green-600 hover:bg-green-700 py-4 rounded-2xl font-bold text-lg shadow-xl transition-all"
                                            >
                                                Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø¢Ù†
                                            </button>
                                        ) : (
                                            <div className="text-center py-4 text-slate-400 flex flex-col items-center gap-3">
                                                <div className="w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                                                Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø£Ø¯Ù…Ù† Ø§Ù„ØºØ±ÙØ© Ù„Ù„Ø¨Ø¯Ø¡...
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    /* Playing State */
                                    <div className="space-y-6 animate-in fade-in zoom-in duration-500">
                                        <div className={`p-8 rounded-[2rem] border-2 shadow-2xl text-center relative overflow-hidden ${gameData.spyId === user.uid ? 'border-red-500/50 spy-gradient' : 'border-blue-500/50 citizen-gradient'}`}>
                                            {gameData.spyId === user.uid ? (
                                                <div className="space-y-6">
                                                    <div className="text-7xl">ğŸ•µï¸â€â™‚ï¸</div>
                                                    <h2 className="text-4xl font-black uppercase tracking-tighter">Ø£Ù†Øª Ø§Ù„Ø¬Ø§Ø³ÙˆØ³!</h2>
                                                    <p className="text-red-200">Ù…Ù‡Ù…ØªÙƒ: Ø§ÙƒØªØ´Ù Ø§Ù„Ù…ÙƒØ§Ù† Ù…Ù† ÙƒÙ„Ø§Ù…Ù‡Ù… Ø¯ÙˆÙ† Ø£Ù† ÙŠÙƒØ´ÙÙˆÙƒ.</p>
                                                    <div className="inline-block px-6 py-2 bg-black/30 rounded-full text-sm font-bold animate-pulse">
                                                        Ø§Ù„Ù…Ù‡Ù…Ø©: Ø§Ø¨Ù‚Ù ØºØ§Ù…Ø¶Ø§Ù‹
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="space-y-4">
                                                    <h2 className="text-xl text-blue-200 font-bold uppercase tracking-widest">Ø£Ù†Øª Ù…ÙˆØ§Ø·Ù†</h2>
                                                    <div className="space-y-2">
                                                        <p className="text-xs text-blue-300">Ø§Ù„Ù…ÙƒØ§Ù† Ù‡Ùˆ:</p>
                                                        <div className="text-5xl font-black text-white">{gameData.location}</div>
                                                    </div>
                                                    <div className="h-[1px] bg-white/20 my-4"></div>
                                                    <div className="space-y-1">
                                                        <p className="text-xs text-blue-300">Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ©:</p>
                                                        <p className="text-2xl font-bold text-yellow-300">{gameData.word}</p>
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        <div className="glass-panel p-6 rounded-2xl text-sm text-slate-400 space-y-2 leading-relaxed">
                                            <p className="font-bold text-slate-200 mb-2">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¬ÙˆÙ„Ø©:</p>
                                            <p>â€¢ ÙŠØªØ­Ø¯Ø« Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø¹Ù† Ø§Ù„Ù…ÙƒØ§Ù†/Ø§Ù„ÙƒÙ„Ù…Ø© Ø¯ÙˆÙ† Ø°ÙƒØ± Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØµØ±ÙŠØ­.</p>
                                            <p>â€¢ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ† ÙƒØ´Ù Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ Ø¨Ø§Ù„ØªØµÙˆÙŠØª.</p>
                                            <p>â€¢ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ ÙƒØ´Ù Ø§Ù„Ù…ÙƒØ§Ù† Ù„ÙŠÙÙˆØ².</p>
                                        </div>

                                        {gameData.admin === user.uid && (
                                            <button 
                                                onClick={resetGame}
                                                className="w-full bg-slate-800 border border-slate-700 py-3 rounded-xl font-bold hover:bg-slate-700 transition-all"
                                            >
                                                ğŸ”„ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©
                                            </button>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                        
                        <div className="mt-12 text-center text-[10px] text-slate-700 font-mono tracking-widest">
                            SERVER_STATUS: CONNECTED | UID: {user.uid.substr(0,8)}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
