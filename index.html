<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PRO SPY | Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Noto+Sans+Arabic:wght@400;700;900&display=swap');
        
        :root {
            --primary: #00f2ff;
            --accent: #7000ff;
            --bg: #050505;
        }

        body { 
            background-color: var(--bg); 
            color: #ffffff;
            font-family: 'Space Grotesk', 'Noto Sans Arabic', sans-serif;
            margin: 0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .cyber-panel {
            background: rgba(15, 15, 20, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #00a2ff);
            color: black;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-primary:active { transform: scale(0.95); opacity: 0.8; }

        @keyframes scan {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        .scanner::after {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; height: 2px;
            background: var(--primary);
            box-shadow: 0 0 15px var(--primary);
            animation: scan 3s linear infinite;
            opacity: 0.3;
        }

        .animated-logo {
            filter: drop-shadow(0 0 8px rgba(0, 242, 255, 0.4));
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(0.98); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const firebaseConfig = {
 
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'pro_spy_v2';
        const GEMINI_KEY = ""; // Key provided by environment

        const T = {
            en: {
                name: "PRO SPY", tag: "ULTRALIGHT ESPIONAGE",
                nick: "AGENT CODENAME", create: "SECURE NEW CHANNEL",
                join: "PATCH INTO FREQUENCY", code: "CODE",
                players: "ACTIVE OPERATIVES", start: "LAUNCH MISSION",
                spy: "YOU ARE THE SPY", agent: "YOU ARE AN AGENT",
                objective: "MISSION LOCATION:", spyGoal: "Infiltrate. Don't reveal your identity.",
                copied: "ENCRYPTED!", copy: "COPY CODE", newRound: "RESET FREQUENCY",
                lang: "العربية", loading: "ENCRYPTING...", joinBtn: "SYNC"
            },
            ar: {
                name: "برو جاسوس", tag: "تجسس فائق الدقة",
                nick: "الاسم الرمزي", create: "تأمين قناة جديدة",
                join: "اختراق التردد", code: "الرمز",
                players: "العملاء النشطون", start: "إطلاق المهمة",
                spy: "أنت الجاسوس", agent: "أنت عميل ميداني",
                objective: "موقع المهمة:", spyGoal: "تسلل. لا تكشف هويتك الحقيقية.",
                copied: "تم التشفير!", copy: "نسخ الرمز", newRound: "تصفير التردد",
                lang: "English", loading: "جاري التشفير...", joinBtn: "ربط"
            }
        };

        function App() {
            const [user, setUser] = useState(null);
            const [lang, setLang] = useState('en');
            const [room, setRoom] = useState(null);
            const [nickname, setNickname] = useState(localStorage.getItem('spy_v2_nick') || '');
            const [roomInput, setRoomInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [copyOk, setCopyOk] = useState(false);
            const [authLoading, setAuthLoading] = useState(true);

            const t = T[lang];

            useEffect(() => {
                const unsub = auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        setUser(u);
                        setAuthLoading(false);
                    } else {
                        await auth.signInAnonymously();
                    }
                });
                return unsub;
            }, []);

            useEffect(() => {
                if (!room?.id) return;
                const unsub = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(room.id)
                    .onSnapshot(doc => doc.exists && setRoom(doc.data()));
                return unsub;
            }, [room?.id]);

            const createRoom = async () => {
                if (!nickname || !user) return;
                setLoading(true);
                const id = Math.random().toString(36).substring(2, 7).toUpperCase();
                const newRoom = {
                    id, admin: user.uid, players: [{uid: user.uid, name: nickname}],
                    status: 'waiting', location: null, spyId: null
                };
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(id).set(newRoom);
                setRoom(newRoom);
                setLoading(false);
            };

            const joinRoom = async () => {
                const id = roomInput.trim().toUpperCase();
                if (!nickname || !id || !user) return;
                setLoading(true);
                const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(id);
                const snap = await ref.get();
                if (snap.exists) {
                    const data = snap.data();
                    if (!data.players.find(p => p.uid === user.uid)) {
                        await ref.update({ players: [...data.players, {uid: user.uid, name: nickname}] });
                    }
                    setRoom(snap.data());
                }
                setLoading(false);
            };

            const startMission = async () => {
                if (!user) return;
                setLoading(true);
                try {
                    const prompt = "JSON: {\"ar\": \"مكان\", \"en\": \"Place\"}. One interesting location.";
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_KEY}`, {
                        method: 'POST', body: JSON.stringify({ contents: [{parts: [{text: prompt}]}], generationConfig: {responseMimeType: "application/json"}})
                    });
                    const data = await res.json();
                    const loc = JSON.parse(data.candidates[0].content.parts[0].text);
                    const spy = room.players[Math.floor(Math.random() * room.players.length)].uid;
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(room.id).update({
                        status: 'playing', location: loc, spyId: spy
                    });
                } catch(e) { console.error(e); }
                setLoading(false);
            };

            const resetRoom = async () => {
                if (!user) return;
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(room.id).update({
                    status: 'waiting', location: null, spyId: null
                });
            };

            if (authLoading) return (
                <div className="min-h-screen flex items-center justify-center bg-black">
                    <div className="w-12 h-12 border-2 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col items-center p-6 sm:p-12 relative overflow-hidden" dir={lang === 'ar' ? 'rtl' : 'ltr'}>
                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-500 to-transparent opacity-20"></div>
                    
                    <div className="w-full max-w-md z-10">
                        {/* HEADER */}
                        <div className="flex justify-between items-center mb-12">
                            <div className="flex items-center gap-4">
                                <div className="w-12 h-12 rounded-2xl bg-cyan-500/10 border border-cyan-500/30 flex items-center justify-center animated-logo">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#00f2ff" strokeWidth="2.5">
                                        <path d="M12 2l9 4.5V11a9 9 0 0 1-18 0V6.5L12 2z"/>
                                        <circle cx="12" cy="11" r="3"/>
                                    </svg>
                                </div>
                                <div>
                                    <h1 className="text-3xl font-black tracking-tighter text-white leading-none">{t.name}</h1>
                                    <p className="text-[9px] font-bold text-cyan-500/60 uppercase tracking-[0.3em] mt-1">{t.tag}</p>
                                </div>
                            </div>
                            <button onClick={() => setLang(lang === 'en' ? 'ar' : 'en')} className="text-[10px] font-black border border-white/10 px-4 py-2 rounded-full hover:bg-white/5 transition-colors">{t.lang}</button>
                        </div>

                        {!room ? (
                            <div className="space-y-6">
                                <div className="cyber-panel rounded-[2rem] p-8 space-y-6 scanner relative overflow-hidden">
                                    <div className="space-y-2">
                                        <label className="text-[10px] font-black text-cyan-500 uppercase tracking-widest px-1">{t.nick}</label>
                                        <input 
                                            type="text" value={nickname} 
                                            onChange={e => {setNickname(e.target.value); localStorage.setItem('spy_v2_nick', e.target.value);}}
                                            className="w-full bg-white/5 border border-white/10 p-5 rounded-2xl outline-none focus:border-cyan-500 transition-all text-lg font-bold text-center"
                                        />
                                    </div>
                                    <div className="space-y-3">
                                        <button onClick={createRoom} disabled={!nickname || loading} className="btn-primary w-full py-5 rounded-2xl font-black text-sm uppercase tracking-widest shadow-lg shadow-cyan-500/20">{loading ? t.loading : t.create}</button>
                                        <div className="flex items-center gap-4 py-2">
                                            <div className="h-[1px] flex-1 bg-white/5"></div>
                                            <span className="text-[9px] font-black opacity-20 uppercase tracking-[0.5em]">OR</span>
                                            <div className="h-[1px] flex-1 bg-white/5"></div>
                                        </div>
                                        <div className="flex gap-2">
                                            <input 
                                                type="text" placeholder={t.code} value={roomInput} onChange={e => setRoomInput(e.target.value)}
                                                className="flex-1 bg-white/5 border border-white/10 px-4 rounded-2xl outline-none focus:border-cyan-500 font-mono text-center tracking-[0.3em]"
                                            />
                                            <button onClick={joinRoom} disabled={!nickname || !roomInput || loading} className="bg-white/10 hover:bg-white/20 px-6 py-5 rounded-2xl font-black text-xs transition-all">{t.joinBtn}</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-6">
                                <div className="cyber-panel rounded-2xl p-4 flex justify-between items-center border-l-4 border-l-cyan-500">
                                    <div>
                                        <p className="text-[9px] font-black opacity-40 uppercase tracking-widest">{t.code}</p>
                                        <p className="text-2xl font-mono font-black text-cyan-400">{room.id}</p>
                                    </div>
                                    <button onClick={() => {navigator.clipboard.writeText(room.id); setCopyOk(true); setTimeout(()=>setCopyOk(false), 2000)}} className={`px-5 py-2 rounded-xl text-[10px] font-black transition-all ${copyOk ? 'bg-green-500 text-white' : 'bg-white/10'}`}>
                                        {copyOk ? t.copied : t.copy}
                                    </button>
                                </div>

                                {room.status === 'waiting' ? (
                                    <div className="cyber-panel rounded-[2rem] p-8 space-y-6">
                                        <div className="flex justify-between items-end border-b border-white/5 pb-4">
                                            <h3 className="text-xs font-black uppercase text-cyan-500 tracking-[0.2em]">{t.players}</h3>
                                            <span className="text-2xl font-black opacity-30">{room.players.length}</span>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3 max-h-64 overflow-y-auto">
                                            {room.players.map((p, i) => (
                                                <div key={i} className={`p-4 rounded-2xl border ${p.uid === (user?.uid || '') ? 'border-cyan-500 bg-cyan-500/5' : 'border-white/5 bg-white/5'}`}>
                                                    <p className="text-xs font-black truncate">{p.name}</p>
                                                    <p className="text-[8px] opacity-30 mt-1 uppercase font-bold tracking-tighter">{p.uid === (user?.uid || '') ? "YOU" : "OPERATIVE"}</p>
                                                </div>
                                            ))}
                                        </div>
                                        {room.admin === user?.uid ? (
                                            <button onClick={startMission} disabled={room.players.length < 3 || loading} className="btn-primary w-full py-5 rounded-2xl font-black text-sm uppercase shadow-2xl disabled:opacity-30">{loading ? t.loading : t.start}</button>
                                        ) : (
                                            <div className="text-center py-4 text-[10px] font-black opacity-30 animate-pulse tracking-[0.3em]">{lang === 'ar' ? 'بانتظار القائد...' : 'WAITING FOR COMMANDER...'}</div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="space-y-6">
                                        <div className={`cyber-panel rounded-[2.5rem] p-10 text-center border-t-8 ${room.spyId === user?.uid ? 'border-t-red-600' : 'border-t-cyan-500'}`}>
                                            <div className="w-20 h-20 mx-auto rounded-3xl bg-white/5 flex items-center justify-center mb-6">
                                                {room.spyId === user?.uid ? (
                                                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#dc2626" strokeWidth="2">
                                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                                    </svg>
                                                ) : (
                                                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#00f2ff" strokeWidth="2">
                                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
                                                    </svg>
                                                )}
                                            </div>
                                            <h2 className={`text-4xl font-black tracking-tighter mb-4 ${room.spyId === user?.uid ? 'text-red-500' : 'text-cyan-400'}`}>
                                                {room.spyId === user?.uid ? t.spy : t.agent}
                                            </h2>
                                            <p className="text-white/40 text-xs font-bold leading-relaxed mb-8 px-4">
                                                {room.spyId === user?.uid ? t.spyGoal : t.objective}
                                            </p>
                                            {room.spyId !== user?.uid && (
                                                <div className="bg-cyan-500/10 border border-cyan-500/20 py-8 rounded-[2rem]">
                                                    <span className="text-3xl font-black text-white tracking-tight uppercase">
                                                        {lang === 'ar' ? room.location?.ar : room.location?.en}
                                                    </span>
                                                </div>
                                            )}
                                        </div>
                                        {room.admin === user?.uid && (
                                            <button onClick={resetRoom} className="w-full bg-white/5 border border-white/10 py-4 rounded-2xl font-black text-[10px] tracking-widest hover:bg-white/10 transition-all uppercase">{t.newRound}</button>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}

                        <footer className="text-center mt-12 opacity-10 font-mono text-[8px] tracking-[0.5em] uppercase">
                            SYSTEM ACTIVE // ID: {user?.uid ? user.uid.substring(0, 10) : 'AUTHENTICATING...'}
                        </footer>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

