<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PRO SPY | Elite Tactical Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Noto+Sans+Arabic:wght@400;700;900&display=swap');
        
        :root {
            --primary: #00f2ff;
            --accent: #7000ff;
            --bg: #030303;
        }

        body { 
            background-color: var(--bg); 
            color: #ffffff;
            font-family: 'Space Grotesk', 'Noto Sans Arabic', sans-serif;
            margin: 0;
            overflow-x: hidden;
            user-select: none;
        }

        .bg-grid {
            background-image: 
                radial-gradient(circle at 2px 2px, rgba(112, 0, 255, 0.15) 1px, transparent 0);
            background-size: 30px 30px;
            position: fixed;
            inset: 0;
            z-index: -1;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
        }

        /* Animated Icon */
        .floating-icon {
            animation: floatRotate 4s ease-in-out infinite;
        }
        @keyframes floatRotate {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-5px) rotate(10deg); }
        }

        /* Logo Text Animation */
        .logo-text {
            background: linear-gradient(90deg, #fff, var(--primary), #fff);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 3s linear infinite;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        @keyframes shine {
            to { background-position: 200% center; }
        }

        @keyframes scan {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        .scanner::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, transparent, var(--primary), transparent);
            height: 2px;
            width: 100%;
            animation: scan 3s linear infinite;
            opacity: 0.3;
        }

        .user-badge {
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(0, 242, 255, 0.2); border-color: rgba(0, 242, 255, 0.3); }
            50% { box-shadow: 0 0 20px rgba(0, 242, 255, 0.5); border-color: rgba(0, 242, 255, 0.8); }
        }

        .vote-tag {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    <div id="root"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyApAJaNfF0YHupunLRlK3jRYvttxczWShY",
            authDomain: "who-is-the-spy-919b9.firebaseapp.com",
            projectId: "who-is-the-spy-919b9",
            storageBucket: "who-is-the-spy-919b9.firebasestorage.app",
            messagingSenderId: "607075438373",
            appId: "1:607075438373:web:a03e9fb8b243cd993e14cc"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'pro_spy_v2_elite';
        const GEMINI_KEY = ""; 

        const TRANSLATIONS = {
            en: {
                appName: "PRO SPY", tagline: "IDENTIFY THE TRAITOR", nickname: "Agent Alias",
                create: "CREATE HQ", join: "JOIN OPS", codePlaceholder: "ACCESS CODE",
                players: "ACTIVE AGENTS", start: "ACTIVATE MISSION", spyTitle: "SPY DETECTED",
                spyDesc: "Objective: Sabotage communications.", citizenTitle: "AGENT VERIFIED",
                objective: "MISSION KEYWORD", voting: "VOTE FOR TARGET",
                timer: "LOCKDOWN:", sec: "S", copied: "COPIED", copy: "COPY",
                waiting: "WAITING FOR HQ...", loading: "ENCRYPTING...",
                you: "YOU", newRound: "NEXT PHASE", langBtn: "العربية",
                noChoice: "NO SELECTION", lockIn: "LOCK VOTE", locked: "VOTED"
            },
            ar: {
                appName: "برو جاسوس", tagline: "حدد الخائن", nickname: "اسم العميل",
                create: "إنشاء المقر", join: "انضمام للعملية", codePlaceholder: "رمز الدخول",
                players: "العملاء النشطون", start: "تفعيل المهمة", spyTitle: "تم كشف جاسوس",
                spyDesc: "المهمة: تخريب الاتصالات.", citizenTitle: "تم تأكيد العميل",
                objective: "كلمة المهمة", voting: "تصويت على الهدف",
                timer: "الإغلاق:", sec: "ث", copied: "تم النسخ", copy: "نسخ",
                waiting: "بانتظار القيادة...", loading: "تشفير البيانات...",
                you: "أنت", newRound: "المرحلة التالية", langBtn: "English",
                noChoice: "لم يتم الاختيار", lockIn: "تأكيد الصوت", locked: "تم التصويت"
            }
        };

        async function fetchScenario() {
            try {
                const seed = Math.random();
                const prompt = `Generate a UNIQUE and UNCOMMON location. Provide 4 words directly related to it. Output JSON: {loc_ar, words_ar:[4], loc_en, words_en:[4]}. Seed: ${seed}`;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_KEY}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
                });
                const data = await response.json();
                return JSON.parse(data.candidates[0].content.parts[0].text);
            } catch (e) {
                return { loc_ar: "مفاعل نووي", words_ar: ["إشعاع", "يورانيوم", "تبريد", "تحذير"], loc_en: "Nuclear Reactor", words_en: ["Radiation", "Uranium", "Cooling", "Warning"] };
            }
        }

        function App() {
            const [lang, setLang] = useState('en'); // Default is English
            const [user, setUser] = useState(null);
            const [room, setRoom] = useState(null);
            const [roomId, setRoomId] = useState('');
            const [inputCode, setInputCode] = useState('');
            const [nickname, setNickname] = useState(localStorage.getItem('pro_spy_nick') || '');
            const [loading, setLoading] = useState(false);
            const [timeLeft, setTimeLeft] = useState(0);

            const t = TRANSLATIONS[lang];

            useEffect(() => {
                const unsub = auth.onAuthStateChanged(async (u) => { if (u) setUser(u); else await auth.signInAnonymously(); });
                return unsub;
            }, []);

            useEffect(() => {
                if (!user || !roomId) return;
                const unsub = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId)
                    .onSnapshot(doc => setRoom(doc.exists ? doc.data() : null));
                return unsub;
            }, [user, roomId]);

            useEffect(() => {
                let timer;
                if (room?.status === 'playing' && room?.timerStart) {
                    timer = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - room.timerStart) / 1000);
                        setTimeLeft(Math.max(0, 30 - elapsed)); 
                    }, 1000);
                }
                return () => clearInterval(timer);
            }, [room?.status, room?.timerStart]);

            const handleCreate = async () => {
                if (!nickname.trim()) return;
                setLoading(true);
                const id = Math.random().toString(36).substring(2, 7).toUpperCase();
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(id).set({
                    id, admin: user.uid, status: 'waiting',
                    players: [{ uid: user.uid, name: nickname, vote: null }],
                    scenario: null, spyId: null, timerStart: null
                });
                setRoomId(id);
                setLoading(false);
            };

            const handleJoin = async () => {
                const code = inputCode.toUpperCase();
                if (!nickname.trim() || !code) return;
                setLoading(true);
                const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(code);
                const snap = await ref.get();
                if (snap.exists) {
                    const data = snap.data();
                    if (!data.players.find(p => p.uid === user.uid)) {
                        await ref.update({ players: [...data.players, { uid: user.uid, name: nickname, vote: null }] });
                    }
                    setRoomId(code);
                }
                setLoading(false);
            };

            const startMission = async () => {
                if (room.admin !== user.uid) return;
                setLoading(true);
                const scenario = await fetchScenario();
                const spy = room.players[Math.floor(Math.random() * room.players.length)];
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                    status: 'playing', scenario, spyId: spy.uid, timerStart: Date.now(),
                    players: room.players.map(p => ({ ...p, vote: null }))
                });
                setLoading(false);
            };

            const castVote = async (word) => {
                if (timeLeft <= 0 || room.spyId === user.uid) return;
                const updated = room.players.map(p => p.uid === user.uid ? { ...p, vote: word } : p);
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({ players: updated });
            };

            return (
                <div className="min-h-screen p-4 flex flex-col items-center" dir={lang === 'ar' ? 'rtl' : 'ltr'}>
                    <div className="bg-grid"></div>
                    <div className="w-full max-w-lg space-y-6 pt-4">
                        
                        <header className="flex justify-between items-center px-2">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 glass flex items-center justify-center border-cyan-500/40 relative overflow-hidden floating-icon">
                                    <div className="scanner"></div>
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" className="text-cyan-400">
                                        <circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/>
                                    </svg>
                                </div>
                                <div>
                                    <h1 className="text-2xl font-black leading-none logo-text">{t.appName}</h1>
                                    <p className="text-[8px] font-bold opacity-40 tracking-widest uppercase">{t.tagline}</p>
                                </div>
                            </div>
                            <button onClick={() => setLang(lang === 'en' ? 'ar' : 'en')} className="glass px-3 py-1.5 text-[9px] font-black uppercase tracking-widest border-white/20">{t.langBtn}</button>
                        </header>

                        {!room ? (
                            <main className="glass p-8 space-y-8">
                                <div className="space-y-2">
                                    <label className="text-[10px] font-black opacity-30 uppercase ml-1 flex items-center gap-2">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                        {t.nickname}
                                    </label>
                                    <input className="w-full bg-black/50 border border-white/10 p-4 rounded-2xl font-bold focus:border-cyan-500 outline-none transition-all" value={nickname} onChange={e => { setNickname(e.target.value); localStorage.setItem('pro_spy_nick', e.target.value); }} />
                                </div>
                                <div className="space-y-4 pt-4">
                                    <button onClick={handleCreate} disabled={loading || !nickname} className="w-full bg-gradient-to-r from-cyan-600 to-blue-700 py-4 rounded-2xl font-black text-sm uppercase tracking-wider shadow-lg shadow-cyan-900/20 active:scale-95 transition-all">{t.create}</button>
                                    <div className="flex gap-2">
                                        <input className="flex-1 bg-black/50 border border-white/10 p-4 rounded-2xl font-mono text-center font-black uppercase text-sm focus:border-cyan-500 outline-none" placeholder={t.codePlaceholder} value={inputCode} onChange={e => setInputCode(e.target.value.toUpperCase())} />
                                        <button onClick={handleJoin} disabled={loading || !nickname || !inputCode} className="glass px-6 font-black text-xs uppercase hover:bg-white/10">{t.join}</button>
                                    </div>
                                </div>
                            </main>
                        ) : (
                            <div className="space-y-4">
                                <div className="glass p-4 flex justify-between items-center border-white/5">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-cyan-500/20 px-3 py-1 rounded-full border border-cyan-500/30">
                                            <span className="text-xs font-black text-cyan-400 tracking-widest">{room.id}</span>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                                        <span className="text-[10px] font-black opacity-50 uppercase">{t.players}: {room.players.length}</span>
                                    </div>
                                </div>

                                {room.status === 'waiting' ? (
                                    <div className="glass p-6 space-y-6">
                                        <div className="grid grid-cols-2 gap-3">
                                            {room.players.map((p, i) => (
                                                <div key={i} className={`relative p-4 rounded-2xl border flex flex-col gap-1 transition-all ${p.uid === user.uid ? 'bg-cyan-500/10 border-cyan-500/50 user-badge shadow-inner' : 'bg-white/5 border-white/5 opacity-60'}`}>
                                                    <div className="flex items-center gap-2">
                                                        <div className={`w-1.5 h-1.5 rounded-full ${p.uid === user.uid ? 'bg-cyan-400' : 'bg-white/20'}`}></div>
                                                        <span className="text-[11px] font-black truncate">{p.name}</span>
                                                    </div>
                                                    {p.uid === user.uid && <span className="absolute top-2 right-2 text-[7px] bg-cyan-500 text-black px-1.5 py-0.5 rounded font-black">{t.you}</span>}
                                                </div>
                                            ))}
                                        </div>
                                        {room.admin === user.uid ? 
                                            <button onClick={startMission} className="w-full bg-white text-black py-4 rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-cyan-400 transition-colors">{t.start}</button> 
                                            : <div className="text-center py-4 bg-white/5 rounded-2xl border border-dashed border-white/10 text-[9px] font-black opacity-30 uppercase tracking-[0.3em]">{t.waiting}</div>
                                        }
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        <div className={`relative p-8 rounded-[2.5rem] border-b-[10px] text-center overflow-hidden transition-all duration-700 shadow-2xl ${room.spyId === user.uid ? 'bg-gradient-to-b from-red-900/40 to-black border-red-600' : 'bg-gradient-to-b from-cyan-900/40 to-black border-cyan-600'}`}>
                                            <div className="absolute top-4 left-4 opacity-10">
                                                <svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor">
                                                    {room.spyId === user.uid ? 
                                                        <path d="M12 2a5 5 0 1 0 5 5 5 5 0 0 0-5-5zm0 14c-5 0-9 2-9 5v1h18v-1c0-3-4-5-9-5z"/> :
                                                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 2.18l7 3.12v4.7c0 4.67-3.13 8.87-7 10.15-3.87-1.28-7-5.48-7-10.15V6.3l7-3.12z"/>
                                                    }
                                                </svg>
                                            </div>
                                            <div className="relative z-10 space-y-4">
                                                <div className="flex justify-center items-center gap-2">
                                                    {room.spyId === user.uid ? (
                                                        <svg className="text-red-500 animate-pulse" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                                    ) : (
                                                        <svg className="text-cyan-400" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                                    )}
                                                    <h2 className={`text-xl font-black uppercase tracking-widest ${room.spyId === user.uid ? 'text-red-400' : 'text-cyan-400'}`}>
                                                        {room.spyId === user.uid ? t.spyTitle : t.citizenTitle}
                                                    </h2>
                                                </div>
                                                {room.spyId !== user.uid ? (
                                                    <div className="space-y-1">
                                                        <p className="text-[10px] font-bold opacity-40 uppercase tracking-[0.2em]">{t.objective}</p>
                                                        <div className="text-5xl font-black tracking-tight text-white drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]">
                                                            {lang === 'ar' ? room.scenario?.loc_ar : room.scenario?.loc_en}
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div className="bg-red-500/10 border border-red-500/20 p-4 rounded-2xl">
                                                        <p className="text-[11px] font-bold italic text-red-200/70">{t.spyDesc}</p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        <div className="glass p-6 space-y-6">
                                            <div className="flex justify-between items-end border-b border-white/5 pb-4">
                                                <h3 className="font-black text-xs uppercase tracking-widest flex items-center gap-2">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M12 20v-6M6 20V10M18 20V4"/></svg>
                                                    {t.voting}
                                                </h3>
                                                <div className="text-right">
                                                    <p className="text-[8px] font-black opacity-30 uppercase">{t.timer}</p>
                                                    <div className={`text-2xl font-black font-mono ${timeLeft < 10 ? 'text-red-500 animate-pulse' : 'text-cyan-400'}`}>{timeLeft}{t.sec}</div>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-2 gap-3">
                                                {(room.spyId !== user.uid ? (lang === 'ar' ? room.scenario?.words_ar : room.scenario?.words_en) : ["SECRET","REDACTED","UNKNOWN","ENCRYPTED"])?.map((word, idx) => {
                                                    const voters = room.players.filter(p => p.vote === word);
                                                    const isSelected = room.players.find(p => p.uid === user.uid)?.vote === word;
                                                    return (
                                                        <div key={idx} className="space-y-2">
                                                            <button onClick={() => castVote(word)} disabled={timeLeft <= 0 || room.spyId === user.uid} className={`w-full p-4 rounded-2xl border-2 font-black transition-all text-[11px] uppercase tracking-wider ${isSelected ? 'bg-cyan-500 border-cyan-400 text-black' : 'bg-white/5 border-white/5'}`}>
                                                                {word}
                                                            </button>
                                                            <div className="flex flex-wrap gap-1 px-1 min-h-[16px]">
                                                                {voters.map((v, vi) => (
                                                                    <div key={vi} className="vote-tag flex items-center gap-1 bg-white/10 px-1.5 py-0.5 rounded-full border border-white/5">
                                                                        <div className="w-1 h-1 rounded-full bg-cyan-400"></div>
                                                                        <span className="text-[7px] font-black truncate max-w-[50px]">{v.name}</span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                            {room.admin === user.uid && timeLeft <= 0 && (
                                                <button onClick={startMission} className="w-full bg-cyan-500/10 hover:bg-cyan-500/20 py-4 rounded-2xl font-black border border-cyan-500/30 text-cyan-400 text-xs uppercase tracking-widest transition-all">
                                                    {t.newRound}
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        <footer className="text-center opacity-10 font-mono text-[7px] tracking-[0.5em] py-8 uppercase">TERMINAL_REF: {appId.toUpperCase()} // AUTH_OK</footer>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
